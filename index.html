<!DOCTYPE html> <!--a -->
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Gerenciador de Estudos 22</title>

<!-- PWA Manifest and Theme Color -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#005a9c">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<!-- FullCalendar CSS -->
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css" rel="stylesheet" />

<style>
  :root {
    --bg-primary: #f5f7fa;
    --bg-secondary: #ffffff;
    --bg-tertiary: #f9f9f9;
    --bg-header: #005a9c;
    --bg-header-hover: #004477;
    --text-primary: #333333;
    --text-secondary: #555555;
    --text-light: #ffffff;
    --border-color: #dddddd;
    --accent-color: #005a9c;
    --shadow-color: rgba(0,0,0,0.08);
  }

  [data-theme="dark"] {
    --bg-primary: #121212;
    --bg-secondary: #1e1e1e;
    --bg-tertiary: #2a2a2a;
    --bg-header: #1a237e;
    --bg-header-hover: #283593;
    --text-primary: #e0e0e0;
    --text-secondary: #b0b0b0;
    --text-light: #ffffff;
    --border-color: #444444;
    --accent-color: #3f51b5;
    --shadow-color: rgba(255,255,255,0.08);

    /* FullCalendar Dark Theme */
    --fc-border-color: #444;
    --fc-daygrid-day-bg-color: var(--bg-secondary);
    --fc-list-even-row-bg-color: var(--bg-tertiary);
    --fc-list-odd-row-bg-color: var(--bg-secondary);
  }

  body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    margin: 0; padding: 0;
    background: var(--bg-primary);
    color: var(--text-primary);
    display: flex;
    flex-direction: column;
    min-height: 100vh;
    line-height: 1.6;
    transition: background-color 0.3s, color 0.3s;
  }
  header {
    background: var(--bg-header);
    color: var(--text-light);
    padding: 1.5rem 1rem;
    text-align: center;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    display: flex;
    justify-content: center;
    align-items: center;
    position: relative;
  }
  header h1 {
    margin: 0;
  }
  nav {
    background: var(--bg-secondary);
    display: flex;
    overflow-x: auto;
    border-bottom: 1px solid var(--border-color);
  }
  nav button {
    flex: 1;
    padding: 1rem;
    border: none;
    background: transparent;
    cursor: pointer;
    font-weight: 600;
    font-size: 0.95rem;
    color: var(--text-secondary);
    border-bottom: 3px solid transparent;
    transition: background 0.3s, border-color 0.3s, color 0.3s;
    white-space: nowrap;
  }
  nav button:hover:not([aria-selected="true"]) {
    background: var(--bg-tertiary);
    color: var(--accent-color);
  }
  nav button[aria-selected="true"] {
    color: var(--accent-color);
    border-bottom-color: var(--accent-color);
  }
  main {
    flex: 1;
    max-width: 1200px; /* Aumentado para o calendário */
    width: 95%;
    margin: 1.5rem auto 2rem;
    background: var(--bg-secondary);
    box-shadow: 0 4px 20px var(--shadow-color);
    border-radius: 8px;
    padding: 2rem;
  }
  section {
    display: none;
  }
  section.active {
    display: block;
    animation: fadeIn 0.5s ease-in-out;
  }
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }
  h2 {
    color: var(--accent-color);
    margin-bottom: 1rem;
    border-bottom: 2px solid var(--bg-primary);
    padding-bottom: 0.5rem;
  }
  h3 {
    color: var(--text-primary);
    margin-top: 1.5rem;
    margin-bottom: 0.5rem;
    font-size: 1.1rem;
  }
  label {
    display: block;
    margin-top: 1rem;
    margin-bottom: 0.25rem;
    font-weight: 600;
    color: var(--text-primary);
  }
  /* Inputs gerais */
  input[type=text], input[type=number], input[type=date], input[type=time], select, textarea {
    width: 100%;
    padding: 0.7rem;
    font-size: 1rem;
    margin-top: 0.5rem;
    border-radius: 6px;
    border: 1px solid var(--border-color);
    box-sizing: border-box;
    transition: border-color 0.3s, box-shadow 0.3s;
    background-color: var(--bg-secondary);
    color: var(--text-primary);
  }
  
  /* Container para formulários de adição compactos */
  .compact-add-form {
    margin-top: 1.5rem;
    padding: 1rem;
    background: var(--bg-tertiary);
    border: 1px dashed var(--border-color);
    border-radius: 6px;
  }
  .compact-add-form .input-group {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-top: 0.5rem;
  }
  .compact-add-form .input-group input[type="text"] {
    flex-grow: 1;
    margin: 0;
  }
  .compact-add-form button {
      margin-top: 1rem;
  }

  /* Estilo do input de cor como uma bolinha */
  .color-picker-icon {
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
    width: 38px;
    height: 38px;
    padding: 0;
    border: none;
    border-radius: 50%;
    background-color: transparent;
    cursor: pointer;
    flex-shrink: 0;
    margin: 0;
  }
  .color-picker-icon::-webkit-color-swatch {
    border-radius: 50%;
    border: 2px solid #e0e0e0;
  }
  .color-picker-icon::-moz-color-swatch {
    border-radius: 50%;
    border: 2px solid #e0e0e0;
  }
  
  /* Estilo geral para inputs de cor nos formulários de edição */
  .edit-form input[type="color"] {
    width: 120px;
    height: 40px;
    padding: 0.5rem;
    margin-top: 0.5rem;
    border-radius: 6px;
    border: 1px solid var(--border-color);
    box-sizing: border-box;
    cursor: pointer;
  }
  
  input:focus, select:focus, textarea:focus {
    outline: none;
    border-color: var(--accent-color);
    box-shadow: 0 0 0 3px var(--accent-color-transp);
  }
  textarea {
    resize: vertical;
    min-height: 80px;
  }
  button {
    background-color: var(--accent-color);
    border: none;
    color: var(--text-light);
    padding: 0.8rem 1.5rem;
    margin-top: 1rem;
    font-size: 1rem;
    font-weight: bold;
    border-radius: 6px;
    cursor: pointer;
    transition: background-color 0.3s, transform 0.2s;
  }
  button:hover:not(:disabled) {
    background-color: var(--bg-header-hover);
    transform: translateY(-2px);
  }
  button:disabled {
    background-color: #aaa;
    cursor: not-allowed;
  }
  ul {
    margin-top: 0.5rem;
    max-height: 250px;
    overflow-y: auto;
    background: var(--bg-tertiary);
    padding: 1rem;
    border: 1px solid var(--border-color);
    border-radius: 6px;
    list-style-type: none;
  }
  ul li {
    padding: 0.75rem;
    padding-right: 50px; /* Espaço para o botão de excluir */
    margin-bottom: 0.5rem;
    position: relative;
    background: var(--bg-secondary);
    border-left: 4px solid var(--accent-color);
    border-radius: 4px;
  }
  .subject-item {
    margin-bottom: 1.5rem;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 1rem 1.5rem;
    background-color: var(--bg-secondary);
    transition: box-shadow 0.3s;
  }
  .subject-item:hover {
    box-shadow: 0 4px 12px var(--shadow-color);
  }
  .subject-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .subject-header-title {
    display: flex;
    align-items: center;
    flex-grow: 1;
    min-width: 0;
  }
  .color-box {
    width: 20px;
    height: 20px;
    border-radius: 4px;
    border: 1px solid #666;
    margin-right: 0.75rem;
    display: inline-block;
    vertical-align: middle;
    flex-shrink: 0;
  }
  .subject-title {
    font-size: 1.3rem;
    font-weight: bold;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .topic-list {
    margin-top: 1rem;
    padding-left: 0;
    list-style-type: none;
  }
  .topic-item {
    padding-right: 50px; /* Espaço para o botão de excluir */
    border-radius: 6px;
    margin-bottom: 0.5rem;
    font-size: 0.95rem;
    background: var(--bg-tertiary);
    border: 1px solid var(--border-color);
    position: relative;
  }
  .topic-header {
    display: flex;
    align-items: center;
    font-weight: bold;
  }
  .topic-item .topic-description {
    font-size: 0.9rem;
    color: var(--text-secondary);
    margin-top: 0.5rem;
    padding-left: 22px;
  }
  .edit-form {
    margin-top: 1.5rem;
    padding: 1rem;
    background: var(--bg-tertiary);
    border: 1px solid var(--accent-color);
    border-radius: 6px;
  }
  .edit-form button {
      margin-right: 0.5rem;
  }
  .edit-form button.cancel-btn {
      background-color: #6c757d;
  }
  .edit-form button.cancel-btn:hover {
      background-color: #5a6268;
  }
  #timer-display {
    font-size: 4rem;
    text-align: center;
    margin: 1.5rem 0;
    color: var(--accent-color);
    font-weight: bold;
    font-family: 'Courier New', Courier, monospace;
  }
  .timer-controls button {
      margin: 0 5px;
  }
  table {
    border-collapse: collapse;
    width: 100%;
    margin-top: 1rem;
  }
  th, td {
    border: 1px solid var(--border-color);
    padding: 0.6rem;
    text-align: left;
    vertical-align: middle;
    font-size: 0.9rem;
  }
  th {
    background-color: var(--accent-color);
    color: var(--text-light);
    font-weight: 600;
  }
  tr:nth-child(even) {
      background-color: var(--bg-tertiary);
  }
  canvas {
    width: 100% !important;
    max-width: 100%;
    height: 350px;
    max-height: 400px;
    margin-top: 1rem;
    box-sizing: border-box;
  }
  footer {
      text-align: center;
      padding: 1.5rem;
      margin-top: 2rem;
      background: var(--bg-secondary);
      color: var(--text-secondary);
      font-size: 0.9rem;
      border-top: 1px solid var(--border-color);
  }
  /* Estilo para Botão de Ícone */
  .icon-btn {
    background: transparent;
    border: none;
    cursor: pointer;
    padding: 5px;
    border-radius: 50%;
    width: 32px;
    height: 32px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    transition: background-color 0.2s, color 0.2s;
    margin: 0;
  }
  .icon-btn.delete-btn { color: #e74c3c; }
  .icon-btn.delete-btn:hover { background-color: #fbe9e7; }
  .icon-btn.edit-btn { color: var(--accent-color); }
  .icon-btn.edit-btn:hover { background-color: var(--bg-tertiary); }

  .icon-btn:hover {
    transform: none;
  }
  .icon-btn svg {
    width: 16px;
    height: 16px;
  }
  
  /* --- CORREÇÃO DE LAYOUT --- */
  .subject-header-title .edit-btn, .topic-header .edit-btn {
    margin-left: 10px;
    flex-shrink: 0;
  }
  .actions {
    display: flex;
    align-items: center;
    flex-shrink: 0;
  }
  .subject-header .actions {
    margin-left: 1rem;
  }
  .topic-item .actions {
    position: absolute;
    top: 50%;
    right: 5px;
    transform: translateY(-50%);
  }
  /* --- FIM DA CORREÇÃO --- */

  td .icon-btn {
      margin: auto;
  }

  /* --- CONFIGURAÇÕES E MODAL --- */
  #settings-btn {
    position: absolute;
    top: 1rem;
    right: 1rem;
    background: transparent;
    border: none;
    color: white;
    padding: 8px;
    cursor: pointer;
    border-radius: 50%;
  }
  #settings-btn:hover {
    background-color: rgba(255,255,255,0.1);
  }
  #settings-menu {
    display: none;
    position: absolute;
    top: 50px;
    right: 1rem;
    background-color: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    box-shadow: 0 4px 12px var(--shadow-color);
    z-index: 1000;
    width: 220px; /* Aumentado para caber o texto */
    padding: 5px 0;
  }
  #settings-menu button {
    display: block;
    width: 100%;
    text-align: left;
    background: none;
    border: none;
    padding: 12px 15px;
    color: var(--text-primary);
    cursor: pointer;
    margin: 0;
    border-radius: 0;
  }
  #settings-menu button:hover {
    background-color: var(--bg-tertiary);
  }
  .settings-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 15px;
  }
  .settings-item label {
    margin: 0;
  }
  .settings-item input[type="color"] {
    width: 28px;
    height: 28px;
    border: none;
    padding: 0;
    border-radius: 50%;
    cursor: pointer;
  }
  .settings-item input[type="color"]::-webkit-color-swatch {
    border-radius: 50%;
    border: 1px solid var(--border-color);
  }
  #about-modal, #alarm-modal, #backup-modal {
    display: none;
    position: fixed;
    z-index: 2000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0,0,0,0.5);
    align-items: center;
    justify-content: center;
  }
  .modal-content {
    background-color: var(--bg-secondary);
    margin: auto;
    padding: 25px;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    width: 90%;
    max-width: 500px;
    text-align: center;
  }
  .modal-content p {
    margin-bottom: 1.5rem;
    line-height: 1.7;
  }
  .modal-content button {
    min-width: 100px;
    margin: 0 5px;
  }
  #backup-folder-path {
    font-weight: bold;
    color: var(--accent-color);
    word-break: break-all;
  }

  /* --- ESTILOS DO CALENDÁRIO --- */
  #calendar-container {
    margin-top: 1.5rem;
  }
  #calendar-filters {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    align-items: flex-end;
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid var(--border-color);
  }
  #calendar-filters .filter-group {
    display: flex;
    flex-direction: column;
    flex-grow: 1;
  }
  #calendar-filters label {
    font-size: 0.9rem;
    margin-top: 0;
    margin-bottom: 0.5rem;
  }
  #calendar-filters input, #calendar-filters select {
    margin-top: 0;
    padding: 0.5rem;
  }
  #calendar-filters .view-buttons-group {
    flex-grow: 2;
    text-align: right;
  }
  #calendar-filters .view-buttons-group button {
    margin: 0 0 0 5px;
    padding: 0.5rem 0.8rem;
    font-size: 0.9rem;
  }

  .fc .fc-toolbar-title {
    font-size: 1.5em !important;
    color: var(--accent-color);
  }
  .fc .fc-button-primary {
    background-color: var(--accent-color) !important;
    border-color: var(--accent-color) !important;
  }
  .fc .fc-button-primary:hover {
    background-color: var(--bg-header-hover) !important;
  }
  .fc .fc-daygrid-day.fc-day-today {
    background-color: rgba(0, 90, 156, 0.1);
  }
  .fc-event {
    cursor: pointer;
  }

  @media (max-width: 768px) {
    #calendar-filters {
        flex-direction: column;
        align-items: stretch;
        gap: 1.5rem;
    }
    #calendar-filters .view-buttons-group {
        text-align: left;
    }
    .fc .fc-toolbar.fc-header-toolbar {
        flex-direction: column;
        gap: 10px;
    }
  }

  @media (max-width: 600px) {
    nav button {
      font-size: 0.8rem;
      padding: 0.8rem 0.5rem;
    }
    main {
        padding: 1rem;
    }
    h2 {
        font-size: 1.2rem;
    }
    #timer-display {
        font-size: 3rem;
    }
  }
</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.min.js"></script>
<!-- FullCalendar JS -->
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/locales/pt-br.js"></script>
</head>
<body>

<header>
  <h1>Gerenciador de Estudos 22</h1>
  <button id="settings-btn" title="Configurações">
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16">
      <path d="M9.405 1.05c-.413-1.4-2.397-1.4-2.81 0l-.1.34a1.464 1.464 0 0 1-2.105.872l-.31-.17c-1.283-.698-2.686.705-1.987 1.987l.169.311a1.464 1.464 0 0 1 .872 2.105l-.34.1c-1.4.413-1.4 2.397 0 2.81l.34.1a1.464 1.464 0 0 1-.872 2.105l-.17.31c-.698 1.283.705 2.686 1.987 1.987l.311-.169a1.464 1.464 0 0 1 2.105.872l.1.34c.413 1.4 2.397 1.4 2.81 0l.1-.34a1.464 1.464 0 0 1 2.105-.872l.31.17c1.283.698 2.686-.705 1.987-1.987l-.169-.311a1.464 1.464 0 0 1-.872-2.105l.34-.1c1.4-.413-1.4-2.397 0-2.81l-.34-.1a1.464 1.464 0 0 1 .872-2.105l.17-.31c.698-1.283-.705-2.686-1.987-1.987l-.311.169a1.464 1.464 0 0 1-2.105-.872l-.1-.34zM8 10.93a2.929 2.929 0 1 1 0-5.858 2.929 2.929 0 0 1 0 5.858z"/>
    </svg>
  </button>
  <div id="settings-menu">
    <button id="toggle-theme-btn">Alternar Tema</button>
    <div class="settings-item">
      <label for="theme-color-picker">Cor do Tema</label>
      <input type="color" id="theme-color-picker">
    </div>
    <button id="reset-theme-btn">Resetar Cor</button>
    <hr style="border: none; border-top: 1px solid var(--border-color); margin: 5px 0;">
    <button id="export-data-btn">Exportar Dados</button>
    <button id="import-data-btn">Importar Dados</button>
    <input type="file" id="import-file-input" style="display: none;" accept=".json">
    <button id="schedule-backup-btn">Agendar Backup</button>
    <hr style="border: none; border-top: 1px solid var(--border-color); margin: 5px 0;">
    <button id="about-btn">Sobre</button>
  </div>
</header>

<nav role="tablist" aria-label="Navegação das abas">
  <button role="tab" aria-selected="true" aria-controls="tab-subjects" id="tab-btn-subjects" tabindex="0">Disciplinas</button>
  <button role="tab" aria-selected="false" aria-controls="tab-schedule" id="tab-btn-schedule" tabindex="-1">Atividades Agendadas</button>
  <button role="tab" aria-selected="false" aria-controls="tab-timer" id="tab-btn-timer" tabindex="-1">Cronômetro</button>
  <button role="tab" aria-selected="false" aria-controls="tab-record" id="tab-btn-record" tabindex="-1">Registrar Estudo</button>
  <button role="tab" aria-selected="false" aria-controls="tab-progress" id="tab-btn-progress" tabindex="-1">Histórico &amp; Gráficos</button>
  <button role="tab" aria-selected="false" aria-controls="tab-revision" id="tab-btn-revision" tabindex="-1">Agenda de Revisões</button>
</nav>

<main>
  <!-- Aba Disciplinas -->
  <section tabindex="0" role="tabpanel" id="tab-subjects" aria-labelledby="tab-btn-subjects" class="active">
    <h2>Disciplinas / Matérias</h2>
    <div class="compact-add-form">
      <label for="subject-name">Adicionar nova disciplina:</label>
      <div class="input-group">
        <input id="subject-name" type="text" placeholder="Ex: Matemática" autocomplete="off" />
        <input id="subject-color" type="color" class="color-picker-icon" value="#005a9c" title="Escolha uma cor para a disciplina" />
      </div>
      <button id="add-subject-btn">Adicionar Disciplina</button>
    </div>

    <div id="subjects-container" aria-live="polite" aria-label="Lista de disciplinas com opções" style="margin-top: 2rem;"></div>
    
    <div class="compact-add-form" style="margin-top: 2.5rem;">
        <h3>Agendar Estudo</h3>
        <label for="alarm-subject">Disciplina:</label>
        <select id="alarm-subject">
          <option value="">-- Escolha uma disciplina --</option>
        </select>
        <label for="alarm-topic">Assunto:</label>
        <select id="alarm-topic" disabled>
          <option value="">-- Assunto (opcional) --</option>
        </select>
        <label for="alarm-date">Data:</label>
        <input type="date" id="alarm-date" />
        <label for="alarm-time">Hora:</label>
        <input type="time" id="alarm-time" />
        <button id="add-study-alarm-btn">Agendar Estudo</button>
    </div>
    <h3 style="margin-top: 2rem;">Estudos Agendados</h3>
    <ul id="study-alarm-list"></ul>
  </section>
  
  <!-- Aba Atividades Agendadas (Calendário) -->
  <section tabindex="0" role="tabpanel" id="tab-schedule" aria-labelledby="tab-btn-schedule">
    <h2>Atividades Agendadas</h2>
    <div id="calendar-filters">
        <div class="filter-group">
            <label for="calendar-main-filter">Filtrar por tipo:</label>
            <select id="calendar-main-filter">
                <option value="all">Todos</option>
                <option value="type:study">Estudos</option>
                <option value="type:revision">Revisões</option>
            </select>
        </div>
        <div class="filter-group view-buttons-group">
            <label>&nbsp;</label> <!-- Para alinhamento -->
            <div>
                <button class="view-btn" data-view="dayGridMonth">Mês</button>
                <button class="view-btn" data-view="timeGridWeek">Semana</button>
                <button class="view-btn" data-view="timeGridDay">Dia</button>
                <button class="view-btn" data-view="listYear">Anual</button>
            </div>
        </div>
    </div>
    <div id="calendar-container">
        <div id="calendar"></div>
    </div>
  </section>

  <!-- Aba Cronômetro -->
  <section tabindex="0" role="tabpanel" id="tab-timer" aria-labelledby="tab-btn-timer">
    <h2>Cronômetro de Estudo</h2>
    <label for="timer-subject">Selecione a disciplina:</label>
    <select id="timer-subject" aria-required="true" aria-label="Selecionar disciplina para estudo">
      <option value="">-- Escolha uma disciplina --</option>
    </select>
    <label for="timer-topic">Assunto (opcional):</label>
    <select id="timer-topic" disabled>
        <option value="">-- Geral da disciplina --</option>
    </select>

    <label for="timer-minutes">Defina o tempo de estudo (minutos):</label>
    <input type="number" id="timer-minutes" min="1" max="180" value="25" aria-required="true" aria-label="Tempo de estudo em minutos" />

    <div id="timer-display" aria-live="assertive" aria-atomic="true">00:00</div>

    <div class="timer-controls" style="text-align: center;">
      <button id="start-timer-btn">Iniciar</button>
      <button id="pause-timer-btn" disabled>Pausar</button>
      <button id="reset-timer-btn" disabled>Resetar</button>
    </div>

    <p id="timer-message" role="alert" aria-live="polite" style="display:none; text-align:center; margin-top:1rem; font-weight:bold;"></p>
  </section>

  <!-- Aba Registrar Estudo -->
  <section tabindex="0" role="tabpanel" id="tab-record" aria-labelledby="tab-btn-record">
    <h2>Registrar Progresso de Estudo</h2>
    <label for="record-subject">Disciplina:</label>
    <select id="record-subject" aria-required="true" aria-label="Selecionar disciplina para registro">
      <option value="">-- Escolha --</option>
    </select>
    <label for="record-topic">Assunto (opcional):</label>
    <select id="record-topic" disabled>
        <option value="">-- Geral da disciplina --</option>
    </select>

    <label for="study-method">Método de estudo:</label>
    <select id="study-method">
      <option value="Leitura">Leitura</option>
      <option value="Resumos">Resumos</option>
      <option value="Prática de Questões">Prática de Questões</option>
      <option value="Vídeo Aula">Vídeo Aula</option>
      <option value="Revisão">Revisão</option>
      <option value="Outro">Outro</option>
    </select>

    <label for="study-duration">Duração do estudo (minutos):</label>
    <input type="number" id="study-duration" min="1" value="25" />

    <label for="pages-studied">Páginas / Exercícios / Quantidade:</label>
    <input type="text" id="pages-studied" placeholder="Ex: 30 páginas, 15 questões" />

    <label for="notes">Anotações / Pontos importantes:</label>
    <textarea id="notes" placeholder="Anote dúvidas, pontos-chave para revisão futura..."></textarea>

    <button id="record-study-btn">Registrar Estudo</button>
  </section>

  <!-- Aba Histórico e Gráficos -->
  <section tabindex="0" role="tabpanel" id="tab-progress" aria-labelledby="tab-btn-progress">
    <h2>Histórico de Estudos</h2>
    <div style="overflow-x:auto;">
        <table id="progress-table" aria-label="Histórico de estudos">
          <thead>
            <tr>
              <th>Data</th>
              <th>Disciplina</th>
              <th>Assunto</th>
              <th>Método</th>
              <th>Duração (min)</th>
              <th>Resumo</th>
              <th style="text-align: center;">Ação</th>
            </tr>
          </thead>
          <tbody>
            <!-- Registros preenchidos dinamicamente -->
          </tbody>
        </table>
    </div>

    <h2 style="margin-top: 2rem;">Visualização Gráfica</h2>
    <label for="graph-type">Tipo de gráfico:</label>
    <select id="graph-type" aria-label="Selecionar tipo de gráfico para visualização">
      <option value="bar">Barras</option>
      <option value="line">Linha</option>
      <option value="pie">Pizza</option>
    </select>

    <label for="graph-timeframe">Mostrar estudo dos últimos (dias):</label>
    <input type="number" id="graph-timeframe" min="1" max="365" value="30" />

    <label for="graph-subjects">Selecione disciplinas para mostrar no gráfico:</label>
    <select id="graph-subjects" multiple size="5" aria-label="Selecionar disciplinas para gráfico"></select>
    
    <label for="graph-topics">Filtrar por assuntos (opcional):</label>
    <select id="graph-topics" multiple size="5"></select>

    <button id="update-graph-btn">Atualizar Gráfico</button>

    <canvas id="study-chart" role="img" aria-label="Gráfico resumo do tempo de estudo por disciplina"></canvas>
  </section>

  <!-- Aba Agenda de Revisões -->
  <section tabindex="0" role="tabpanel" id="tab-revision" aria-labelledby="tab-btn-revision">
    <h2>Agenda de Revisões</h2>
    <label for="revision-subject">Disciplina para revisão:</label>
    <select id="revision-subject">
      <option value="">-- Escolha a disciplina --</option>
    </select>
    
    <label for="revision-topic">Assunto para revisão (opcional):</label>
    <select id="revision-topic" disabled>
        <option value="">-- Geral da disciplina --</option>
    </select>

    <label for="revision-date">Data para revisão:</label>
    <input type="date" id="revision-date" />
    <label for="revision-time">Hora da revisão:</label>
    <input type="time" id="revision-time" />

    <label for="revision-notes">Notas para revisão:</label>
    <textarea id="revision-notes" placeholder="O que revisar..."></textarea>

    <button id="add-revision-btn">Agendar Revisão</button>

    <h3 style="margin-top: 2rem;">Revisões Agendadas</h3>
    <ul id="revision-list" aria-live="polite"></ul>
  </section>
</main>

<div id="about-modal">
  <div class="modal-content">
    <h3>Sobre o Gerenciador de Estudos</h3>
    <p>Este programa foi desenvolvido com o objetivo de ajudar alunos de todos os graus acadêmicos a organizarem seus estudos e serem bem sucedidos no gerenciamento do seu tempo e alcançar seus objetivos de forma disciplinada e eficiente.</p>
    <p><strong>Desenvolvido por:</strong> Luan Carlos Marques Cutrim</p>
    <button class="close-modal-btn">Fechar</button>
  </div>
</div>

<div id="alarm-modal">
  <div class="modal-content">
    <h3 id="alarm-title">Alarme!</h3>
    <p id="alarm-text">É hora de estudar/revisar.</p>
    <button id="close-alarm-btn">OK</button>
  </div>
</div>

<div id="backup-modal">
  <div class="modal-content">
    <h3>Agendar Backup Automático</h3>
    <p>Defina o destino e a frequência dos backups automáticos.</p>
    
    <button id="choose-backup-folder-btn" style="margin-bottom: 1rem;">Escolher Pasta de Backup</button>
    <p style="font-size: 0.9em; color: var(--text-secondary);">Pasta: <span id="backup-folder-path">Nenhuma (usará a pasta Downloads)</span></p>

    <hr style="border: none; border-top: 1px solid var(--border-color); margin: 1rem 0;">

    <label for="backup-interval">Fazer backup a cada (dias):</label>
    <input type="number" id="backup-interval" min="1" value="7" style="text-align: center; max-width: 100px; margin: 0 auto;"/>
    <p id="backup-status" style="font-size: 0.9em; color: var(--text-secondary); margin-top: 1rem;"></p>
    
    <div>
        <button id="save-backup-schedule-btn">Salvar</button>
        <button id="cancel-backup-schedule-btn" class="cancel-btn">Cancelar</button>
    </div>
  </div>
</div>

<footer>
  &copy; 2025 Gerenciador de Estudos 22
</footer>

<script>
document.addEventListener('DOMContentLoaded', () => {
  // --- SERVICE WORKER REGISTRATION ---
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('/sw.js')
        .then(registration => {
          console.log('Service Worker registrado com sucesso:', registration);
        })
        .catch(error => {
          console.log('Falha ao registrar Service Worker:', error);
        });
    });
  }

  // Ícones em SVG para reutilização
  const trashIconSVG = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/><path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/></svg>`;
  const editIconSVG = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708l-10 10a.5.5 0 0 1-.168.11l-5 2a.5.5 0 0 1-.65-.65l2-5a.5.5 0 0 1 .11-.168l10-10zM11.207 2.5 13.5 4.793 14.793 3.5 12.5 1.207 11.207 2.5zm1.586 3L10.5 3.207 4 9.707V10h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.293l6.5-6.5zm-9.761 5.175-.106.106-1.528 3.821 3.821-1.528.106-.106A.5.5 0 0 1 5 12.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.468-.325z"/></svg>`;

  let backupDirHandle = null; // Holds the FileSystemDirectoryHandle

  const state = {
    subjects: [],
    studyRecords: [],
    revisions: [],
    studyAlarms: [],
    timer: {
      interval: null,
      timeLeft: 0,
      initialTime: 0,
      isRunning: false,
      isPaused: false,
    }
  };
  
  let calendar = null; // Variável para a instância do calendário

  const tabButtons = document.querySelectorAll('nav button[role="tab"]');
  const tabPanels = document.querySelectorAll('main section[role="tabpanel"]');
  const subjectsContainer = document.getElementById('subjects-container');
  const subjectNameInput = document.getElementById('subject-name');
  const subjectColorInput = document.getElementById('subject-color');
  const addSubjectBtn = document.getElementById('add-subject-btn');
  const selectsToUpdate = [
    document.getElementById('timer-subject'),
    document.getElementById('record-subject'),
    document.getElementById('revision-subject'),
    document.getElementById('graph-subjects'),
    document.getElementById('alarm-subject'),
  ];
  
  // --- LÓGICA DE NAVEGAÇÃO POR ABAS ---
  tabButtons.forEach(btn => {
    btn.addEventListener('click', (e) => {
      const targetId = e.target.getAttribute('aria-controls');
      tabButtons.forEach(b => b.setAttribute('aria-selected', b.getAttribute('aria-controls') === targetId));
      tabPanels.forEach(panel => panel.classList.toggle('active', panel.id === targetId));
      
      if (targetId === 'tab-progress') setTimeout(updateChart, 50);
      if (targetId === 'tab-schedule') {
        setTimeout(() => {
            if (!calendar) {
                initCalendar();
            } else {
                calendar.render(); // Re-renderiza para ajustar o tamanho
            }
            updateUnifiedCalendarFilter();
            updateCalendarEvents();
        }, 50);
      }
    });
  });

  // --- LÓGICA DO CALENDÁRIO ---
  function initCalendar() {
    const calendarEl = document.getElementById('calendar');
    calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        locale: 'pt-br',
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: '' // Os botões de visualização são externos
        },
        height: 'auto', // Ajusta a altura ao container
        events: [],
        eventClick: function(info) {
            alert(
                `Atividade: ${info.event.title}\n` +
                `Data: ${info.event.start.toLocaleString('pt-BR')}\n` +
                `Tipo: ${info.event.extendedProps.type === 'study' ? 'Estudo Agendado' : 'Revisão'}\n` +
                `Descrição: ${info.event.extendedProps.description || 'N/A'}`
            );
        }
    });
    calendar.render();
    
    // Listeners para os botões de visualização externos
    document.querySelectorAll('.view-btn').forEach(button => {
        button.addEventListener('click', (e) => {
            const view = e.currentTarget.dataset.view;
            if (calendar) {
                calendar.changeView(view);
            }
        });
    });

    // Listener para o filtro unificado
    document.getElementById('calendar-main-filter').addEventListener('change', updateCalendarEvents);
  }

  function updateUnifiedCalendarFilter() {
    const filterSelect = document.getElementById('calendar-main-filter');
    const currentValue = filterSelect.value;
    filterSelect.innerHTML = `
        <option value="all">Todos</option>
        <option value="type:study">Estudos</option>
        <option value="type:revision">Revisões</option>
    `;

    const subjectOptGroup = document.createElement('optgroup');
    subjectOptGroup.label = 'Disciplinas';
    state.subjects.forEach(subj => {
        const opt = document.createElement('option');
        opt.value = `subject:${subj.name}`;
        opt.textContent = subj.name;
        subjectOptGroup.appendChild(opt);
    });
    if (subjectOptGroup.children.length > 0) {
        filterSelect.appendChild(subjectOptGroup);
    }

    const topicOptGroup = document.createElement('optgroup');
    topicOptGroup.label = 'Assuntos';
    const allTopics = new Set();
    state.subjects.forEach(subj => {
        subj.topics.forEach(topic => allTopics.add(topic.name));
    });
    allTopics.forEach(topicName => {
        const opt = document.createElement('option');
        opt.value = `topic:${topicName}`;
        opt.textContent = topicName;
        topicOptGroup.appendChild(opt);
    });
     if (topicOptGroup.children.length > 0) {
        filterSelect.appendChild(topicOptGroup);
    }
    
    filterSelect.value = currentValue;
  }

  function updateCalendarEvents() {
    if (!calendar) return;

    const filterValue = document.getElementById('calendar-main-filter').value;

    const studyEvents = state.studyAlarms.map(alarm => ({
        title: `Estudo: ${alarm.subject}${alarm.topic ? ' - ' + alarm.topic : ''}`,
        start: `${alarm.date}T${alarm.time}`,
        backgroundColor: state.subjects.find(s => s.name === alarm.subject)?.color || '#3788d8',
        borderColor: state.subjects.find(s => s.name === alarm.subject)?.color || '#3788d8',
        extendedProps: { 
            type: 'study', 
            subject: alarm.subject, 
            topic: alarm.topic,
            description: `Estudo agendado para ${alarm.subject}` 
        }
    }));

    const revisionEvents = state.revisions.map(rev => ({
        title: `Revisão: ${rev.subject}${rev.topic ? ' - ' + rev.topic : ''}`,
        start: `${rev.date}T${rev.time}`,
        backgroundColor: state.subjects.find(s => s.name === rev.subject)?.color || '#17a2b8',
        borderColor: state.subjects.find(s => s.name === rev.subject)?.color || '#17a2b8',
        extendedProps: { 
            type: 'revision', 
            subject: rev.subject,
            topic: rev.topic,
            description: rev.notes || 'Revisar matéria.' 
        }
    }));
    
    let allEvents = [...studyEvents, ...revisionEvents];

    // Aplicar filtro unificado
    if (filterValue !== 'all') {
        const [category, value] = filterValue.split(':');
        allEvents = allEvents.filter(e => {
            if (category === 'type') return e.extendedProps.type === value;
            if (category === 'subject') return e.extendedProps.subject === value;
            if (category === 'topic') return e.extendedProps.topic === value;
            return false;
        });
    }
    
    calendar.getEventSources().forEach(source => source.remove());
    calendar.addEventSource(allEvents);
  }


  // --- LÓGICA DE DISCIPLINAS E ASSUNTOS ---
  function updateSubjectsUI() {
    subjectsContainer.innerHTML = state.subjects.length === 0 ? '<p>Nenhuma disciplina adicionada ainda.</p>' : '';
    state.subjects.forEach((subj, subjIndex) => {
      const subjectDiv = document.createElement('div');
      subjectDiv.className = 'subject-item';
      subjectDiv.style.borderLeft = `6px solid ${subj.color}`;

      const header = document.createElement('div');
      header.className = 'subject-header';
      header.innerHTML = `
        <div class="subject-header-title">
          <span class="color-box" style="background-color: ${subj.color};"></span>
          <span class="subject-title">${subj.name}</span>
          <button class="icon-btn edit-btn edit-subject-btn" data-index="${subjIndex}" title="Editar disciplina">${editIconSVG}</button>
        </div>
        <div class="actions">
            <button class="icon-btn delete-btn delete-subject-btn" data-index="${subjIndex}" title="Excluir disciplina">${trashIconSVG}</button>
        </div>
      `;
      subjectDiv.appendChild(header);

      const topicList = document.createElement('ul');
      topicList.className = 'topic-list';
      if (subj.topics && subj.topics.length > 0) {
          subj.topics.forEach((topic, topicIndex) => {
              const topicItem = document.createElement('li');
              topicItem.className = 'topic-item';
              topicItem.innerHTML = `
                  <div class="topic-header">
                      <span class="color-box" style="background-color: ${topic.color}; width: 14px; height: 14px; margin-right: 8px;"></span>
                      <span>${topic.name}</span>
                      <button class="icon-btn edit-btn edit-topic-btn" data-subj-index="${subjIndex}" data-topic-index="${topicIndex}" title="Editar assunto">${editIconSVG}</button>
                  </div>
                  <p class="topic-description">${topic.description || 'Sem descrição.'}</p>
                  <div class="actions">
                    <button class="icon-btn delete-btn delete-topic-btn" data-subj-index="${subjIndex}" data-topic-index="${topicIndex}" title="Excluir assunto">${trashIconSVG}</button>
                  </div>
              `;
              topicList.appendChild(topicItem);
          });
      } else {
          const li = document.createElement('li');
          li.textContent = 'Nenhum assunto adicionado.';
          li.style.paddingRight = '0.75rem'; // Remove padding extra
          topicList.appendChild(li);
      }
      subjectDiv.appendChild(topicList);

      const addTopicForm = document.createElement('div');
      addTopicForm.className = 'compact-add-form';
      addTopicForm.innerHTML = `
          <h3>Adicionar Novo Assunto</h3>
          <label>Nome do Assunto:</label>
          <div class="input-group">
            <input type="text" class="topic-name-input" placeholder="Ex: Funções de 1º Grau">
            <input type="color" class="color-picker-icon topic-color-input" value="#3498db" title="Escolha uma cor para o assunto">
          </div>
          <label>Descrição:</label>
          <textarea class="topic-desc-input" placeholder="Detalhes sobre o que estudar, fórmulas, etc."></textarea>
          <button class="add-topic-btn" data-index="${subjIndex}">Adicionar Assunto</button>
      `;
      subjectDiv.appendChild(addTopicForm);
      subjectsContainer.appendChild(subjectDiv);
    });
    
    addSubjectActionListeners();
    updateAllSelects();
  }
  
  function addSubjectActionListeners() {
      // DELETAR DISCIPLINA
      document.querySelectorAll('.delete-subject-btn').forEach(btn => {
          btn.onclick = e => {
              const index = e.currentTarget.dataset.index;
              if(confirm(`Confirma excluir a disciplina "${state.subjects[index].name}" e todos os seus registros?`)){
                  state.subjects.splice(index, 1);
                  saveState();
                  renderAll();
              }
          };
      });

      // EDITAR DISCIPLINA
      document.querySelectorAll('.edit-subject-btn').forEach(btn => {
        btn.onclick = e => {
            const subjIndex = e.currentTarget.dataset.index;
            const subject = state.subjects[subjIndex];
            const subjectDiv = e.currentTarget.closest('.subject-item');
            
            subjectDiv.innerHTML = `
                <div class="edit-form">
                    <h3>Editando Disciplina</h3>
                    <label for="edit-subject-name-${subjIndex}">Nome da Disciplina:</label>
                    <input id="edit-subject-name-${subjIndex}" type="text" value="${subject.name}" class="edit-subject-name-input">
                    <label for="edit-subject-color-${subjIndex}">Cor:</label>
                    <input id="edit-subject-color-${subjIndex}" type="color" value="${subject.color}" class="edit-subject-color-input">
                    <button class="save-subject-edit-btn" data-index="${subjIndex}">Salvar</button>
                    <button type="button" class="cancel-btn cancel-edit-btn">Cancelar</button>
                </div>
            `;
            
            subjectDiv.querySelector('.save-subject-edit-btn').onclick = () => {
                const oldName = subject.name;
                const newName = subjectDiv.querySelector('.edit-subject-name-input').value.trim();
                const newColor = subjectDiv.querySelector('.edit-subject-color-input').value;
                if (!newName) return alert('O nome não pode ser vazio.');
                
                if (state.subjects.some((s, i) => s.name.toLowerCase() === newName.toLowerCase() && i != subjIndex)) {
                    return alert('Já existe uma disciplina com esse nome.');
                }
                
                if (newName !== oldName) {
                    if (!confirm('Atenção: Alterar o nome da disciplina não atualizará os registros de estudo e revisões já existentes que usam o nome antigo. Deseja continuar?')) {
                        return;
                    }
                }
                
                state.subjects[subjIndex].name = newName;
                state.subjects[subjIndex].color = newColor;
                saveState();
                renderAll();
            };
            
            subjectDiv.querySelector('.cancel-edit-btn').onclick = () => renderAll();
        };
      });

      // ADICIONAR ASSUNTO
      document.querySelectorAll('.add-topic-btn').forEach(btn => {
          btn.onclick = e => {
              const subjIndex = e.currentTarget.dataset.index;
              const form = e.currentTarget.closest('.compact-add-form');
              const name = form.querySelector('.topic-name-input').value.trim();
              if (!name) return alert('Por favor, insira o nome do assunto.');
              state.subjects[subjIndex].topics.push({ 
                  name, 
                  color: form.querySelector('.topic-color-input').value, 
                  description: form.querySelector('.topic-desc-input').value.trim() 
              });
              saveState();
              renderAll();
          };
      });

      // DELETAR ASSUNTO
      document.querySelectorAll('.delete-topic-btn').forEach(btn => {
          btn.onclick = e => {
              const { subjIndex, topicIndex } = e.currentTarget.dataset;
              if (confirm('Deseja excluir este assunto?')) {
                  state.subjects[subjIndex].topics.splice(topicIndex, 1);
                  saveState();
                  renderAll();
              }
          };
      });

      // EDITAR ASSUNTO
      document.querySelectorAll('.edit-topic-btn').forEach(btn => {
        btn.onclick = e => {
            const { subjIndex, topicIndex } = e.currentTarget.dataset;
            const topic = state.subjects[subjIndex].topics[topicIndex];
            const topicItem = e.currentTarget.closest('.topic-item');

            topicItem.classList.add('edit-form');
            topicItem.innerHTML = `
                <h4>Editando Assunto</h4>
                <label>Nome:</label>
                <input type="text" value="${topic.name}" class="edit-topic-name-input">
                <label>Cor:</label>
                <input type="color" value="${topic.color}" class="edit-topic-color-input">
                <label>Descrição:</label>
                <textarea class="edit-topic-desc-input">${topic.description || ''}</textarea>
                <button class="save-topic-edit-btn" data-subj-index="${subjIndex}" data-topic-index="${topicIndex}">Salvar</button>
                <button type="button" class="cancel-btn cancel-edit-btn">Cancelar</button>
            `;

            topicItem.querySelector('.save-topic-edit-btn').onclick = () => {
                const newName = topicItem.querySelector('.edit-topic-name-input').value.trim();
                if (!newName) return alert('O nome do assunto não pode ser vazio.');
                
                const newColor = topicItem.querySelector('.edit-topic-color-input').value;
                const newDesc = topicItem.querySelector('.edit-topic-desc-input').value.trim();
                
                state.subjects[subjIndex].topics[topicIndex] = { name: newName, color: newColor, description: newDesc };
                saveState();
                renderAll();
            };

            topicItem.querySelector('.cancel-edit-btn').onclick = () => renderAll();
        };
      });
  }

  function updateAllSelects() {
    selectsToUpdate.forEach(sel => {
      const selectedVal = sel.value;
      sel.innerHTML = '';
      if(sel.id !== 'graph-subjects') {
          sel.innerHTML = '<option value="">-- Escolha uma disciplina --</option>';
      }
      state.subjects.forEach(subj => {
        const opt = document.createElement('option');
        opt.value = subj.name;
        opt.textContent = subj.name;
        sel.appendChild(opt);
      });
      sel.value = selectedVal;
    });
  }

  addSubjectBtn.addEventListener('click', () => {
    const newSubj = subjectNameInput.value.trim();
    if(!newSubj) return alert('Por favor, insira o nome da disciplina.');
    if(state.subjects.find(s => s.name.toLowerCase() === newSubj.toLowerCase())) return alert('Essa disciplina já existe.');
    state.subjects.push({name: newSubj, color: subjectColorInput.value, topics: []});
    subjectNameInput.value = '';
    saveState();
    renderAll();
  });

  // --- LÓGICA DO CRONÔMETRO ---
  const timerDisplay = document.getElementById('timer-display');
  const timerSubjectSelect = document.getElementById('timer-subject');
  const timerTopicSelect = document.getElementById('timer-topic');
  const timerMinutesInput = document.getElementById('timer-minutes');
  const startBtn = document.getElementById('start-timer-btn');
  const pauseBtn = document.getElementById('pause-timer-btn');
  const resetBtn = document.getElementById('reset-timer-btn');
  
  function updateTimerDisplay() {
    const minutes = Math.floor(state.timer.timeLeft / 60);
    const seconds = state.timer.timeLeft % 60;
    timerDisplay.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
    document.title = state.timer.isRunning ? `${timerDisplay.textContent} - Estudando...` : "Gerenciador de Estudos 22";
  }

  function tick() {
    state.timer.timeLeft--;
    updateTimerDisplay();
    if (state.timer.timeLeft <= 0) {
      clearInterval(state.timer.interval);
      state.timer.isRunning = false;
      document.getElementById('timer-message').style.display = 'block';
      const subject = timerSubjectSelect.value;
      const topic = timerTopicSelect.value;
      const duration = state.timer.initialTime / 60;
      if (subject && duration > 0) {
          addStudyRecord(subject, topic, 'Cronômetro', duration, 'Estudo focado');
          alert(`Estudo de ${duration} minutos de ${subject} registrado!`);
      }
      resetTimer();
    }
  }

  function startTimer() {
    if (!timerSubjectSelect.value) return alert('Por favor, selecione uma disciplina.');
    if (state.timer.isRunning) return;
    const minutes = parseInt(timerMinutesInput.value, 10);
    if (isNaN(minutes) || minutes <= 0) return alert('Por favor, insira um tempo válido.');
    
    state.timer.isRunning = true;
    if (!state.timer.isPaused) {
        state.timer.timeLeft = minutes * 60;
        state.timer.initialTime = minutes * 60;
    }
    state.timer.isPaused = false;
    state.timer.interval = setInterval(tick, 1000);
    updateTimerDisplay();
    updateTimerControls();
  }

  function pauseTimer() {
    if (!state.timer.isRunning) return;
    clearInterval(state.timer.interval);
    state.timer.isRunning = false;
    state.timer.isPaused = true;
    updateTimerControls();
  }

  function resetTimer() {
    clearInterval(state.timer.interval);
    Object.assign(state.timer, { isRunning: false, isPaused: false, timeLeft: 0, initialTime: 0 });
    document.getElementById('timer-message').style.display = 'none';
    updateTimerDisplay();
    updateTimerControls();
  }

  function updateTimerControls() {
    startBtn.textContent = state.timer.isPaused ? 'Continuar' : 'Iniciar';
    startBtn.disabled = state.timer.isRunning;
    pauseBtn.disabled = !state.timer.isRunning || state.timer.isPaused;
    resetBtn.disabled = !state.timer.isRunning && !state.timer.isPaused && state.timer.timeLeft === 0;
    timerSubjectSelect.disabled = state.timer.isRunning || state.timer.isPaused;
    timerMinutesInput.disabled = state.timer.isRunning || state.timer.isPaused;
  }
  
  startBtn.onclick = startTimer;
  pauseBtn.onclick = pauseTimer;
  resetBtn.onclick = resetTimer;

  // --- LÓGICA DE REGISTRO DE ESTUDO ---
  function addStudyRecord(subject, topic, method, duration, summary) {
      state.studyRecords.push({ date: new Date().toLocaleDateString('pt-BR'), subject, topic, method, duration, summary });
      saveState();
      renderAll();
  }

  document.getElementById('record-study-btn').onclick = () => {
    const subject = document.getElementById('record-subject').value;
    const topic = document.getElementById('record-topic').value;
    if (!subject) return alert('Por favor, selecione uma disciplina.');
    const duration = Number(document.getElementById('study-duration').value);
    if (isNaN(duration) || duration <= 0) return alert('Informe uma duração válida.');
    
    addStudyRecord(subject, topic, document.getElementById('study-method').value, duration, document.getElementById('pages-studied').value.trim() || document.getElementById('notes').value.trim() || 'Nenhum resumo');
    document.getElementById('record-subject').value = '';
    document.getElementById('record-topic').value = '';
    document.getElementById('record-topic').disabled = true;
    document.getElementById('study-duration').value = 25;
    document.getElementById('pages-studied').value = '';
    document.getElementById('notes').value = '';
    alert('Estudo registrado com sucesso!');
  };
  
  function updateProgressTable() {
    const tbody = document.querySelector('#progress-table tbody');
    tbody.innerHTML = '';
    [...state.studyRecords].reverse().forEach((rec, index) => {
      const realIndex = state.studyRecords.length - 1 - index;
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${rec.date}</td>
        <td>${rec.subject}</td>
        <td>${rec.topic || 'Geral'}</td>
        <td>${rec.method}</td>
        <td>${rec.duration}</td>
        <td>${rec.summary}</td>
        <td style="text-align: center;"><button class="icon-btn delete-btn delete-record-btn" data-index="${realIndex}" title="Excluir registro">${trashIconSVG}</button></td>
      `;
      tbody.appendChild(tr);
    });
    
    document.querySelectorAll('.delete-record-btn').forEach(button => {
        button.onclick = (e) => {
            const indexToDelete = parseInt(e.currentTarget.dataset.index, 10);
            if (confirm('Confirma excluir este registro de estudo?')) {
                state.studyRecords.splice(indexToDelete, 1);
                saveState();
                renderAll();
            }
        };
    });
  }

  // --- LÓGICA DE GRÁFICOS E FILTROS ---
  let chartInstance = null;
  const graphSubjectsSelect = document.getElementById('graph-subjects');
  const graphTopicsSelect = document.getElementById('graph-topics');

  graphSubjectsSelect.addEventListener('change', () => {
    graphTopicsSelect.innerHTML = '';
    const selectedSubjectNames = Array.from(graphSubjectsSelect.selectedOptions).map(o => o.value);
    
    const topics = new Set();
    state.subjects
        .filter(s => selectedSubjectNames.includes(s.name))
        .forEach(s => {
            s.topics.forEach(t => topics.add(t.name));
        });
    
    topics.forEach(topicName => {
        const opt = document.createElement('option');
        opt.value = topicName;
        opt.textContent = topicName;
        graphTopicsSelect.appendChild(opt);
    });
  });

  function updateChart() {
    const ctx = document.getElementById('study-chart').getContext('2d');
    const diasFiltro = Number(document.getElementById('graph-timeframe').value);
    const dataInicial = new Date();
    dataInicial.setDate(dataInicial.getDate() - diasFiltro + 1);
    dataInicial.setHours(0,0,0,0);

    const selectedSubjects = Array.from(graphSubjectsSelect.selectedOptions).map(o => o.value);
    const selectedTopics = Array.from(graphTopicsSelect.selectedOptions).map(o => o.value);
    
    if (chartInstance) chartInstance.destroy();
    if (selectedSubjects.length === 0) return;

    let registrosFiltrados = state.studyRecords.filter(rec => {
      const [d, m, a] = rec.date.split('/');
      const recDate = new Date(`${a}-${m}-${d}`);
      return recDate >= dataInicial && selectedSubjects.includes(rec.subject);
    });

    let chartData;
    let chartLabels;
    let chartColors;

    if (selectedTopics.length > 0) {
        // Filtra pelos tópicos selecionados
        registrosFiltrados = registrosFiltrados.filter(rec => selectedTopics.includes(rec.topic));
        
        const duracaoPorTopico = registrosFiltrados.reduce((acc, rec) => {
            if (!rec.topic) return acc;
            acc[rec.topic] = (acc[rec.topic] || 0) + rec.duration;
            return acc;
        }, {});

        chartLabels = Object.keys(duracaoPorTopico);
        chartData = Object.values(duracaoPorTopico);
        chartColors = chartLabels.map(topicName => {
            for (const subject of state.subjects) {
                const topic = subject.topics.find(t => t.name === topicName);
                if (topic) return topic.color;
            }
            return '#cccccc'; // Fallback
        });

    } else {
        // Agrupa por disciplina se nenhum tópico for selecionado
        const duracaoPorDisciplina = registrosFiltrados.reduce((acc, rec) => {
            acc[rec.subject] = (acc[rec.subject] || 0) + rec.duration;
            return acc;
        }, {});

        chartLabels = Object.keys(duracaoPorDisciplina);
        chartData = Object.values(duracaoPorDisciplina);
        chartColors = chartLabels.map(l => state.subjects.find(s => s.name === l)?.color || '#ccc');
    }
    
    chartInstance = new Chart(ctx, {
      type: document.getElementById('graph-type').value,
      data: { 
          labels: chartLabels, 
          datasets: [{ 
              label: 'Tempo (min)', 
              data: chartData, 
              backgroundColor: chartColors 
          }] 
      },
      options: { responsive: true, maintainAspectRatio: false }
    });
  }
  document.getElementById('update-graph-btn').onclick = updateChart;

  // --- LÓGICA DE REVISÕES E OUTROS SELECTS ---
  const recordSubjectSelect = document.getElementById('record-subject');
  const recordTopicSelect = document.getElementById('record-topic');
  const revisionSubjectSelect = document.getElementById('revision-subject');
  const revisionTopicSelect = document.getElementById('revision-topic');
  const alarmSubjectSelect = document.getElementById('alarm-subject');
  const alarmTopicSelect = document.getElementById('alarm-topic');

  function populateTopicSelect(subjectSelect, topicSelect) {
    const selectedSubjectName = subjectSelect.value;
    topicSelect.innerHTML = topicSelect.id === 'alarm-topic' 
        ? '<option value="">-- Assunto (opcional) --</option>'
        : '<option value="">-- Geral da disciplina --</option>';
    
    const subject = state.subjects.find(s => s.name === selectedSubjectName);
    if(subject && subject.topics.length > 0) {
      subject.topics.forEach(topic => {
        const opt = document.createElement('option');
        opt.value = topic.name;
        opt.textContent = topic.name;
        topicSelect.appendChild(opt);
      });
      topicSelect.disabled = false;
    } else {
      topicSelect.disabled = true;
    }
  }

  recordSubjectSelect.addEventListener('change', () => populateTopicSelect(recordSubjectSelect, recordTopicSelect));
  timerSubjectSelect.addEventListener('change', () => populateTopicSelect(timerSubjectSelect, timerTopicSelect));
  revisionSubjectSelect.addEventListener('change', () => populateTopicSelect(revisionSubjectSelect, revisionTopicSelect));
  alarmSubjectSelect.addEventListener('change', () => populateTopicSelect(alarmSubjectSelect, alarmTopicSelect));

  function updateRevisionList() {
    const revisionList = document.getElementById('revision-list');
    revisionList.innerHTML = state.revisions.length === 0 ? '<li>Nenhuma revisão agendada.</li>' : '';
    [...state.revisions].sort((a, b) => new Date(`${a.date}T${a.time || '00:00'}`) - new Date(`${b.date}T${b.time || '00:00'}`)).forEach((rev) => {
      const li = document.createElement('li');
      if (rev.triggered) {
          li.style.textDecoration = 'line-through';
          li.style.opacity = '0.6';
      }
      const revDate = new Date(rev.date + 'T00:00:00');
      const today = new Date(); today.setHours(0,0,0,0);
      
      let revisionText = `<strong>${revDate.toLocaleDateString('pt-BR',{timeZone:'UTC'})} às ${rev.time || 'N/A'} - ${rev.subject}`;
      if (rev.topic) revisionText += ` > ${rev.topic}`;
      revisionText += `</strong>: ${rev.notes || 'Sem notas.'}`;

      li.innerHTML = `${revisionText}<button class="icon-btn delete-btn delete-revision-btn" data-id="${rev.id}" title="Excluir revisão">${trashIconSVG}</button>`;
      if (revDate < today && !rev.triggered) li.style.borderColor = '#e74c3c';
      else if (revDate.getTime() === today.getTime() && !rev.triggered) li.style.borderColor = '#f39c12';
      revisionList.appendChild(li);
    });

    document.querySelectorAll('.delete-revision-btn').forEach(btn => {
        btn.onclick = e => {
            const idToDelete = parseInt(e.currentTarget.dataset.id, 10);
            if(confirm('Deseja excluir esta revisão?')){
                state.revisions = state.revisions.filter(r => r.id !== idToDelete);
                saveState();
                renderAll();
            }
        };
    });
  }

  document.getElementById('add-revision-btn').onclick = () => {
    const subject = revisionSubjectSelect.value;
    const date = document.getElementById('revision-date').value;
    const time = document.getElementById('revision-time').value;
    if (!subject || !date || !time) return alert('Por favor, selecione a disciplina, a data e a hora.');
    
    const newRevisionDateTime = new Date(`${date}T${time}`);
    const conflict = state.studyAlarms.some(alarm => new Date(`${alarm.date}T${alarm.time}`).getTime() === newRevisionDateTime.getTime()) ||
                     state.revisions.some(rev => new Date(`${rev.date}T${rev.time}`).getTime() === newRevisionDateTime.getTime());

    if (conflict) {
        return alert('Já existe uma atividade agendada para este horário. Por favor, escolha outro.');
    }

    state.revisions.push({ 
        id: Date.now(),
        subject, 
        topic: revisionTopicSelect.value, 
        date, 
        time,
        notes: document.getElementById('revision-notes').value.trim() 
    });
    saveState();
    renderAll();
    revisionSubjectSelect.value = '';
    revisionTopicSelect.innerHTML = '<option value="">-- Geral da disciplina --</option>';
    revisionTopicSelect.disabled = true;
    document.getElementById('revision-date').value = '';
    document.getElementById('revision-time').value = '';
    document.getElementById('revision-notes').value = '';
    alert('Revisão agendada!');
  };

  // --- LÓGICA DE CONFIGURAÇÕES ---
  const settingsBtn = document.getElementById('settings-btn');
  const settingsMenu = document.getElementById('settings-menu');
  const toggleThemeBtn = document.getElementById('toggle-theme-btn');
  const aboutBtn = document.getElementById('about-btn');
  const aboutModal = document.getElementById('about-modal');
  const themeColorPicker = document.getElementById('theme-color-picker');
  const resetThemeBtn = document.getElementById('reset-theme-btn');
  const exportDataBtn = document.getElementById('export-data-btn');
  const importDataBtn = document.getElementById('import-data-btn');
  const importFileInput = document.getElementById('import-file-input');

  settingsBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    settingsMenu.style.display = settingsMenu.style.display === 'block' ? 'none' : 'block';
  });

  document.addEventListener('click', (e) => {
    if (settingsMenu.style.display === 'block' && !settingsMenu.contains(e.target) && !settingsBtn.contains(e.target)) {
      settingsMenu.style.display = 'none';
    }
  });

  toggleThemeBtn.addEventListener('click', () => {
    const currentTheme = document.documentElement.dataset.theme || 'light';
    const newTheme = currentTheme === 'light' ? 'dark' : 'light';
    document.documentElement.dataset.theme = newTheme;
    localStorage.setItem('studyAppTheme', newTheme);
    
    resetCustomThemeColor();
    settingsMenu.style.display = 'none';
  });
  
  aboutBtn.addEventListener('click', () => {
    aboutModal.style.display = 'flex';
    settingsMenu.style.display = 'none';
  });

  document.querySelectorAll('.close-modal-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
        e.currentTarget.closest('.modal-content').parentElement.style.display = 'none';
    });
  });

  window.addEventListener('click', (e) => {
    if (e.target.classList.contains('modal')) {
      e.target.style.display = 'none';
    }
  });

  function applyThemeColor(color) {
    document.documentElement.style.setProperty('--accent-color', color);
    document.documentElement.style.setProperty('--bg-header', color);
    const isDark = document.documentElement.dataset.theme === 'dark';
    const hoverColor = isDark ? lightenColor(color, 20) : darkenColor(color, 20);
    document.documentElement.style.setProperty('--bg-header-hover', hoverColor);
  }

  function darkenColor(hex, percent) {
    let r = parseInt(hex.substring(1, 3), 16);
    let g = parseInt(hex.substring(3, 5), 16);
    let b = parseInt(hex.substring(5, 7), 16);
    r = parseInt(r * (100 - percent) / 100);
    g = parseInt(g * (100 - percent) / 100);
    b = parseInt(b * (100 - percent) / 100);
    r = (r < 255) ? r : 255;  
    g = (g < 255) ? g : 255;  
    b = (b < 255) ? b : 255;  
    const rr = r.toString(16).length == 1 ? "0" + r.toString(16) : r.toString(16);
    const gg = g.toString(16).length == 1 ? "0" + g.toString(16) : g.toString(16);
    const bb = b.toString(16).length == 1 ? "0" + b.toString(16) : b.toString(16);
    return `#${rr}${gg}${bb}`;
  }

  function lightenColor(hex, percent) {
    let r = parseInt(hex.substring(1, 3), 16);
    let g = parseInt(hex.substring(3, 5), 16);
    let b = parseInt(hex.substring(5, 7), 16);
    r = parseInt(r * (100 + percent) / 100);
    g = parseInt(g * (100 + percent) / 100);
    b = parseInt(b * (100 + percent) / 100);
    r = (r < 255) ? r : 255;  
    g = (g < 255) ? g : 255;  
    b = (b < 255) ? b : 255;  
    const rr = r.toString(16).length == 1 ? "0" + r.toString(16) : r.toString(16);
    const gg = g.toString(16).length == 1 ? "0" + g.toString(16) : g.toString(16);
    const bb = b.toString(16).length == 1 ? "0" + b.toString(16) : b.toString(16);
    return `#${rr}${gg}${bb}`;
  }

  themeColorPicker.addEventListener('input', (e) => {
    const color = e.target.value;
    applyThemeColor(color);
    localStorage.setItem('customThemeColor', color);
  });

  function resetCustomThemeColor() {
    document.documentElement.style.removeProperty('--accent-color');
    document.documentElement.style.removeProperty('--bg-header');
    document.documentElement.style.removeProperty('--bg-header-hover');
    localStorage.removeItem('customThemeColor');
  }

  resetThemeBtn.addEventListener('click', () => {
    resetCustomThemeColor();
    settingsMenu.style.display = 'none';
  });
  
  // --- LÓGICA DE EXPORTAÇÃO E IMPORTAÇÃO ---
  async function doExportData(isAutoBackup = false) {
    const dataStr = JSON.stringify(state, null, 2);
    const dataBlob = new Blob([dataStr], {type: "application/json"});
    const fileName = `dados_estudos_22_${new Date().toISOString().slice(0,10)}.json`;

    try {
      let handle = backupDirHandle;
      let permissionGranted = false;

      if (handle) {
        permissionGranted = await verifyHandlePermission(handle, isAutoBackup);
      }

      if (handle && permissionGranted) {
        const fileHandle = await handle.getFileHandle(fileName, { create: true });
        const writable = await fileHandle.createWritable();
        await writable.write(dataBlob);
        await writable.close();
      } else {
        // Fallback para o método de download tradicional se não houver handle
        // ou se a permissão for negada em um backup automático (para não incomodar o usuário)
        if (isAutoBackup) {
          console.log("Backup automático adiado: permissão da pasta não concedida.");
          return false; // Indica que o backup não foi concluído
        }
        const url = URL.createObjectURL(dataBlob);
        const link = document.createElement('a');
        link.download = fileName;
        link.href = url;
        link.click();
        URL.revokeObjectURL(url);
      }
      return true; // Indica que o backup foi concluído ou iniciado com sucesso
    } catch (error) {
      console.error('Erro ao exportar dados:', error);
      if (!isAutoBackup) {
          alert(`Ocorreu um erro ao exportar os dados. Se você escolheu uma pasta, verifique suas permissões.\nErro: ${error.name}`);
      }
      return false;
    }
  }

  exportDataBtn.addEventListener('click', async () => {
    if (await doExportData(false)) { // false indica backup manual
        alert('Dados exportados com sucesso!');
    }
    settingsMenu.style.display = 'none';
  });

  importDataBtn.addEventListener('click', () => {
    if (confirm('Atenção: A importação irá substituir TODOS os seus dados atuais. Deseja continuar?')) {
        importFileInput.click();
    }
    settingsMenu.style.display = 'none';
  });

  importFileInput.addEventListener('change', (event) => {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (e) => {
        try {
            const importedState = JSON.parse(e.target.result);
            if (importedState && typeof importedState.subjects !== 'undefined' && typeof importedState.studyRecords !== 'undefined') {
                Object.assign(state, importedState);
                saveState();
                alert('Dados importados com sucesso! A página será recarregada.');
                location.reload();
            } else {
                alert('Arquivo inválido ou corrompido.');
            }
        } catch (error) {
            console.error('Erro ao importar dados:', error);
            alert('Ocorreu um erro ao ler o arquivo. Verifique se é um arquivo JSON válido.');
        }
    };
    reader.readAsText(file);
    importFileInput.value = '';
  });

  // --- LÓGICA DE BACKUP AGENDADO E PASTA ---
  const scheduleBackupBtn = document.getElementById('schedule-backup-btn');
  const backupModal = document.getElementById('backup-modal');
  const backupIntervalInput = document.getElementById('backup-interval');
  const saveBackupBtn = document.getElementById('save-backup-schedule-btn');
  const cancelBackupBtn = document.getElementById('cancel-backup-schedule-btn');
  const backupStatus = document.getElementById('backup-status');
  const chooseFolderBtn = document.getElementById('choose-backup-folder-btn');
  const folderPathSpan = document.getElementById('backup-folder-path');

  // IndexedDB Helper Functions
  function openDb() {
    return new Promise((resolve, reject) => {
      const request = indexedDB.open('studyAppDB', 1);
      request.onupgradeneeded = () => {
        request.result.createObjectStore('fileHandles', { keyPath: 'id' });
      };
      request.onsuccess = () => resolve(request.result);
      request.onerror = () => reject(request.error);
    });
  }

  async function saveDirectoryHandle(handle) {
    const db = await openDb();
    return new Promise((resolve, reject) => {
      const tx = db.transaction('fileHandles', 'readwrite');
      tx.objectStore('fileHandles').put({ id: 'backupDir', handle });
      tx.oncomplete = () => resolve();
      tx.onerror = () => reject(tx.error);
    });
  }

  async function getDirectoryHandle() {
    try {
      const db = await openDb();
      return new Promise((resolve, reject) => {
        const tx = db.transaction('fileHandles', 'readonly');
        const request = tx.objectStore('fileHandles').get('backupDir');
        tx.oncomplete = () => resolve(request.result ? request.result.handle : null);
        tx.onerror = () => reject(tx.error);
      });
    } catch (error) {
      console.error("Erro ao acessar IndexedDB:", error);
      return null;
    }
  }

  async function verifyHandlePermission(handle, silent = false) {
    if (!handle || typeof handle.queryPermission !== 'function') return false;
    
    const options = { mode: 'readwrite' };
    
    // Verifica se a permissão já foi concedida
    if (await handle.queryPermission(options) === 'granted') {
      return true;
    }
    
    // Se for um processo silencioso (backup automático), não peça permissão.
    if (silent) {
        return false;
    }

    // Pede permissão (só funciona com um gesto do usuário)
    if (await handle.requestPermission(options) === 'granted') {
      return true;
    }

    // A permissão foi negada
    return false;
  }

  chooseFolderBtn.addEventListener('click', async () => {
    if (typeof window.showDirectoryPicker !== 'function') {
      alert('Seu navegador não suporta a seleção de pastas. O backup será salvo na pasta de Downloads.');
      return;
    }
    try {
      const handle = await window.showDirectoryPicker();
      await saveDirectoryHandle(handle);
      backupDirHandle = handle;
      folderPathSpan.textContent = handle.name;
      alert(`Pasta "${handle.name}" selecionada para backups.`);
    } catch (error) {
      console.log('Seleção de pasta cancelada ou falhou:', error);
    }
  });

  scheduleBackupBtn.addEventListener('click', () => {
    const schedule = JSON.parse(localStorage.getItem('studyAppBackupSchedule') || '{}');
    backupIntervalInput.value = schedule.intervalDays || 7;
    updateBackupStatus();
    
    if (backupDirHandle) {
      folderPathSpan.textContent = backupDirHandle.name;
    } else {
      folderPathSpan.textContent = 'Nenhuma (usará a pasta Downloads)';
    }

    backupModal.style.display = 'flex';
    settingsMenu.style.display = 'none';
  });

  function updateBackupStatus() {
    const schedule = JSON.parse(localStorage.getItem('studyAppBackupSchedule') || '{}');
    if (schedule.intervalDays && schedule.lastBackupTimestamp) {
        const nextBackupDate = new Date(schedule.lastBackupTimestamp + schedule.intervalDays * 24 * 60 * 60 * 1000);
        backupStatus.textContent = `Próximo backup: ${nextBackupDate.toLocaleDateString('pt-BR')}.`;
    } else {
        backupStatus.textContent = 'Nenhum backup automático agendado.';
    }
  }

  saveBackupBtn.addEventListener('click', () => {
    const interval = parseInt(backupIntervalInput.value, 10);
    if (isNaN(interval) || interval < 1) {
        return alert('Por favor, insira um intervalo de dias válido.');
    }
    const schedule = {
        intervalDays: interval,
        lastBackupTimestamp: Date.now()
    };
    localStorage.setItem('studyAppBackupSchedule', JSON.stringify(schedule));
    alert(`Backup automático agendado para cada ${interval} dias.`);
    backupModal.style.display = 'none';
  });

  cancelBackupBtn.addEventListener('click', () => {
    backupModal.style.display = 'none';
  });

  async function checkScheduledBackup() {
    const schedule = JSON.parse(localStorage.getItem('studyAppBackupSchedule') || '{}');
    if (!schedule.intervalDays || !schedule.lastBackupTimestamp) return;

    const now = Date.now();
    const nextBackupTimestamp = schedule.lastBackupTimestamp + (schedule.intervalDays * 24 * 60 * 60 * 1000);

    if (now >= nextBackupTimestamp) {
      console.log('Executando backup agendado...');
      if (await doExportData(true)) { // true indica backup automático
        console.log('Backup automático realizado com sucesso!');
        schedule.lastBackupTimestamp = now;
        localStorage.setItem('studyAppBackupSchedule', JSON.stringify(schedule));
      } else {
        console.log('Falha ao realizar o backup automático.');
      }
    }
  }


  // --- LÓGICA DOS ALARMES ---
  const alarmModal = document.getElementById('alarm-modal');
  const alarmTitle = document.getElementById('alarm-title');
  const alarmText = document.getElementById('alarm-text');
  const closeAlarmBtn = document.getElementById('close-alarm-btn');
  let alarmSound;

  document.body.addEventListener('click', () => {
      if (!alarmSound) {
          alarmSound = new Tone.Synth().toDestination();
      }
  }, { once: true });

  function triggerAlarm(alarm) {
      if (alarmSound) {
          alarmSound.triggerAttackRelease("C5", "0.5");
      }
      if (alarm.type === 'study') {
          alarmTitle.textContent = "Hora do Estudo!";
          alarmText.textContent = `É hora do estudo agendado para: ${alarm.subject}${alarm.topic ? ' - ' + alarm.topic : ''}`;
          const alarmToUpdate = state.studyAlarms.find(a => a.id === alarm.id);
          if (alarmToUpdate) alarmToUpdate.triggered = true;
      } else { // revision
          alarmTitle.textContent = "Hora da Revisão!";
          alarmText.textContent = `É hora de revisar: ${alarm.subject} ${alarm.topic ? '> ' + alarm.topic : ''}`;
          const revisionToUpdate = state.revisions.find(r => r.id === alarm.id);
          if (revisionToUpdate) revisionToUpdate.triggered = true;
      }
      alarmModal.style.display = 'flex';
      saveState();
      renderAll();
  }

  closeAlarmBtn.addEventListener('click', () => {
      alarmModal.style.display = 'none';
  });

  function checkAlarms() {
      const now = new Date();
      const allAlarms = [
          ...state.studyAlarms.map(a => ({...a, type: 'study'})),
          ...state.revisions.map(r => ({...r, type: 'revision'}))
      ];

      const dueAlarm = allAlarms.find(alarm => {
          if (alarm.triggered || !alarm.date || !alarm.time) return false;
          const alarmTime = new Date(`${alarm.date}T${alarm.time}`);
          return now >= alarmTime;
      });

      if(dueAlarm) {
          triggerAlarm(dueAlarm);
      }
  }

  setInterval(checkAlarms, 1000); // Verifica a cada segundo

  // Agendar Alarme de Estudo
  document.getElementById('add-study-alarm-btn').addEventListener('click', () => {
      const subject = document.getElementById('alarm-subject').value;
      const topic = document.getElementById('alarm-topic').value;
      const date = document.getElementById('alarm-date').value;
      const time = document.getElementById('alarm-time').value;

      if (!subject || !date || !time) {
          return alert('Por favor, preencha pelo menos a disciplina, a data e a hora para agendar o estudo.');
      }
      
      const newAlarmDateTime = new Date(`${date}T${time}`);
      const conflict = state.studyAlarms.some(alarm => new Date(`${alarm.date}T${alarm.time}`).getTime() === newAlarmDateTime.getTime()) ||
                       state.revisions.some(rev => new Date(`${rev.date}T${rev.time}`).getTime() === newAlarmDateTime.getTime());

      if (conflict) {
          return alert('Já existe uma atividade agendada para este horário. Por favor, escolha outro.');
      }

      state.studyAlarms.push({
          id: Date.now(),
          subject,
          topic,
          date,
          time
      });
      saveState();
      renderAll();
      document.getElementById('alarm-subject').value = '';
      document.getElementById('alarm-topic').value = '';
      document.getElementById('alarm-topic').disabled = true;
      document.getElementById('alarm-date').value = '';
      document.getElementById('alarm-time').value = '';
      alert('Estudo agendado com sucesso!');
  });

  function updateStudyAlarmList() {
      const list = document.getElementById('study-alarm-list');
      list.innerHTML = '';
      if (state.studyAlarms.length === 0) {
          list.innerHTML = '<li>Nenhum estudo agendado.</li>';
          return;
      }
      [...state.studyAlarms].sort((a,b) => new Date(`${a.date}T${a.time}`) - new Date(`${b.date}T${b.time}`)).forEach(alarm => {
          const li = document.createElement('li');
          if (alarm.triggered) {
              li.style.textDecoration = 'line-through';
              li.style.opacity = '0.6';
          }
          const alarmDate = new Date(`${alarm.date}T00:00:00`);
          let alarmText = `<strong>${alarmDate.toLocaleDateString('pt-BR', {timeZone: 'UTC'})} às ${alarm.time}</strong> - ${alarm.subject}`;
          if (alarm.topic) {
              alarmText += ` > ${alarm.topic}`;
          }
          li.innerHTML = `${alarmText}<button class="icon-btn delete-btn delete-study-alarm-btn" data-id="${alarm.id}" title="Excluir agendamento">${trashIconSVG}</button>`;
          list.appendChild(li);
      });

      document.querySelectorAll('.delete-study-alarm-btn').forEach(btn => {
          btn.onclick = (e) => {
              const id = parseInt(e.currentTarget.dataset.id, 10);
              if (confirm('Deseja realmente excluir este agendamento de estudo?')) {
                  state.studyAlarms = state.studyAlarms.filter(a => a.id !== id);
                  saveState();
                  renderAll();
              }
          };
      });
  }


  // --- PERSISTÊNCIA E INICIALIZAÇÃO ---
  function saveState() {
    localStorage.setItem('studyAppState', JSON.stringify(state));
  }

  function loadState() {
    const savedState = JSON.parse(localStorage.getItem('studyAppState'));
    if (savedState) {
      Object.assign(state, savedState);
      // Migration for old data
      state.subjects = state.subjects || [];
      state.studyRecords = state.studyRecords || [];
      state.revisions = state.revisions || [];
      state.studyAlarms = state.studyAlarms || [];
      state.subjects.forEach(s => s.topics = s.topics || []);
      state.studyRecords.forEach(r => r.topic = r.topic || ''); // Ensure topic property exists for filtering
      state.studyAlarms.forEach(a => a.topic = a.topic || ''); // Ensure topic property exists
      state.timer = { interval: null, timeLeft: 0, isRunning: false, isPaused: false };
    }
    const savedTheme = localStorage.getItem('studyAppTheme');
    if (savedTheme) {
      document.documentElement.dataset.theme = savedTheme;
    }
    const savedThemeColor = localStorage.getItem('customThemeColor');
    if (savedThemeColor) {
      applyThemeColor(savedThemeColor);
      themeColorPicker.value = savedThemeColor;
    }
  }

  function renderAll() {
    updateSubjectsUI();
    updateProgressTable();
    updateRevisionList();
    updateStudyAlarmList();
    updateTimerControls();
    updateUnifiedCalendarFilter();
    updateCalendarEvents(); // Atualiza o calendário sempre que houver mudança nos dados
    if (document.querySelector('#tab-progress.active')) {
        graphSubjectsSelect.dispatchEvent(new Event('change'));
        updateChart();
    }
  }

  async function initializeApp() {
    loadState();
    
    // Load the directory handle on startup, but don't ask for permission yet.
    const handle = await getDirectoryHandle();
    if (handle) {
      backupDirHandle = handle;
      console.log("Referência da pasta de backup restaurada do IndexedDB.");
    }

    renderAll();
    checkScheduledBackup();
  }

  initializeApp();
});
</script>

</body>
</html>

