<!DOCTYPE html>
<html lang="pt-BR" data-theme-preset="default">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Gerenciador de Estudos 22</title>

<!-- PWA Manifest and Theme Color -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#005a9c">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<!-- FullCalendar CSS -->
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css" rel="stylesheet" />

<style>
  :root {
    --bg-primary: #f5f7fa;
    --bg-secondary: #ffffff;
    --bg-tertiary: #f9f9f9;
    --bg-header: #005a9c;
    --bg-header-hover: #004477;
    --text-primary: #333333;
    --text-secondary: #555555;
    --text-light: #ffffff;
    --border-color: #dddddd;
    --accent-color: #005a9c;
    --shadow-color: rgba(0,0,0,0.08);
    --font-family-base: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    --button-border-radius: 6px;
    --card-border-radius: 8px;
  }

  /* --- BIBLIOTECA DE TEMAS --- */
  [data-theme-preset="default"] { /* Já definido no :root */ }
  
  [data-theme-preset="dark"] {
    --bg-primary: #121212; --bg-secondary: #1e1e1e; --bg-tertiary: #2a2a2a;
    --bg-header: #1a237e; --bg-header-hover: #283593;
    --text-primary: #e0e0e0; --text-secondary: #b0b0b0; --text-light: #ffffff;
    --border-color: #444444; --accent-color: #3f51b5;
  }
  [data-theme-preset="forest"] {
    --bg-primary: #f1f8e9; --bg-secondary: #ffffff; --bg-tertiary: #e8f5e9;
    --bg-header: #2e7d32; --bg-header-hover: #1b5e20;
    --text-primary: #1b2e35; --text-secondary: #455a64; --text-light: #ffffff;
    --border-color: #c8e6c9; --accent-color: #4caf50;
  }
  [data-theme-preset="ocean"] {
    --bg-primary: #e0f7fa; --bg-secondary: #ffffff; --bg-tertiary: #b2ebf2;
    --bg-header: #00838f; --bg-header-hover: #006064;
    --text-primary: #004d40; --text-secondary: #00695c; --text-light: #ffffff;
    --border-color: #80deea; --accent-color: #00acc1;
  }
  [data-theme-preset="sourcecode"] {
    --bg-primary: #1e1e1e; --bg-secondary: #252526; --bg-tertiary: #333333;
    --bg-header: #007acc; --bg-header-hover: #005a9e;
    --text-primary: #d4d4d4; --text-secondary: #808080; --text-light: #ffffff;
    --border-color: #3c3c3c; --accent-color: #569cd6;
    --font-family-base: 'Courier New', Courier, monospace;
  }
  [data-theme-preset="oldpaper"] {
    --bg-primary: #fdf5e6; --bg-secondary: #faf0e6; --bg-tertiary: #f5deb3;
    --bg-header: #8b4513; --bg-header-hover: #a0522d;
    --text-primary: #5c4033; --text-secondary: #800000; --text-light: #fff;
    --border-color: #d2b48c; --accent-color: #cd853f;
    --font-family-base: 'Georgia', 'Times New Roman', serif;
  }
  [data-theme-preset="coffee"] {
    --bg-primary: #efebe9; --bg-secondary: #ffffff; --bg-tertiary: #d7ccc8;
    --bg-header: #5d4037; --bg-header-hover: #4e342e;
    --text-primary: #3e2723; --text-secondary: #6d4c41; --text-light: #ffffff;
    --border-color: #bcaaa4; --accent-color: #795548;
  }
  [data-theme-preset="matrix"] {
    --bg-primary: #000000; --bg-secondary: #0D0208; --bg-tertiary: #1a1a1a;
    --bg-header: #003B00; --bg-header-hover: #005200;
    --text-primary: #00FF00; --text-secondary: #00b300; --text-light: #ffffff;
    --border-color: #006400; --accent-color: #00FF00;
    --font-family-base: 'Courier New', Courier, monospace;
  }
  [data-theme-preset="sunset"] {
    --bg-primary: #fbe9e7; --bg-secondary: #ffffff; --bg-tertiary: #ffccbc;
    --bg-header: #d84315; --bg-header-hover: #bf360c;
    --text-primary: #4e342e; --text-secondary: #bf360c; --text-light: #ffffff;
    --border-color: #ffab91; --accent-color: #ff7043;
  }
  [data-theme-preset="sakura"] {
    --bg-primary: #fff0f5; --bg-secondary: #ffffff; --bg-tertiary: #ffe4e1;
    --bg-header: #db7093; --bg-header-hover: #c71585;
    --text-primary: #6a5acd; --text-secondary: #8a2be2; --text-light: #ffffff;
    --border-color: #ffb6c1; --accent-color: #ff69b4;
  }
  [data-theme-preset="vampire"] {
    --bg-primary: #1a1a1a; --bg-secondary: #2c2c2c; --bg-tertiary: #383838;
    --bg-header: #9a0007; --bg-header-hover: #6a0005;
    --text-primary: #f0e6e6; --text-secondary: #c9c9c9; --text-light: #ffffff;
    --border-color: #4a4a4a; --accent-color: #e5383b;
  }
  [data-theme-preset="mint"] {
    --bg-primary: #f0fff0; --bg-secondary: #ffffff; --bg-tertiary: #e0eee0;
    --bg-header: #3cb371; --bg-header-hover: #2e8b57;
    --text-primary: #2f4f4f; --text-secondary: #556b2f; --text-light: #ffffff;
    --border-color: #98fb98; --accent-color: #66cdaa;
  }
  [data-theme-preset="galaxy"] {
    --bg-primary: #0c0a1a; --bg-secondary: #1a182b; --bg-tertiary: #2a283b;
    --bg-header: #4a148c; --bg-header-hover: #6a1b9a;
    --text-primary: #e1ddeb; --text-secondary: #b39ddb; --text-light: #ffffff;
    --border-color: #4527a0; --accent-color: #9c27b0;
  }
  [data-theme-preset="neon"] {
    --bg-primary: #000000; --bg-secondary: #111111; --bg-tertiary: #222222;
    --bg-header: #990099; --bg-header-hover: #770077;
    --text-primary: #00ffff; --text-secondary: #b3ffff; --text-light: #ffffff;
    --border-color: #555555; --accent-color: #f0f;
  }
  [data-theme-preset="submarine"] {
    --bg-primary: #001f3f; --bg-secondary: #002a54; --bg-tertiary: #003566;
    --bg-header: #0096c7; --bg-header-hover: #0077b6;
    --text-primary: #e0e0e0; --text-secondary: #ade8f4; --text-light: #ffffff;
    --border-color: #00509d; --accent-color: #00b4d8;
  }
  [data-theme-preset="desert"] {
    --bg-primary: #f4a261; --bg-secondary: #fffaf0; --bg-tertiary: #fde4cf;
    --bg-header: #264653; --bg-header-hover: #2a9d8f;
    --text-primary: #264653; --text-secondary: #2a9d8f; --text-light: #ffffff;
    --border-color: #e9c46a; --accent-color: #e76f51;
  }
  [data-theme-preset="lavender"] {
    --bg-primary: #e6e6fa; --bg-secondary: #ffffff; --bg-tertiary: #d8bfd8;
    --bg-header: #8a2be2; --bg-header-hover: #6a1b9a;
    --text-primary: #483d8b; --text-secondary: #6a5acd; --text-light: #ffffff;
    --border-color: #dda0dd; --accent-color: #9370db;
  }
  [data-theme-preset="terminal"] {
    --bg-primary: #000000; --bg-secondary: #1a1a1a; --bg-tertiary: #2a2a2a;
    --bg-header: #005500; --bg-header-hover: #003300;
    --text-primary: #00ff00; --text-secondary: #00aa00; --text-light: #ffffff;
    --border-color: #006600; --accent-color: #00aa00;
    --font-family-base: 'Courier New', Courier, monospace;
  }

  body {
    font-family: var(--font-family-base);
    margin: 0; padding: 0;
    background: var(--bg-primary);
    color: var(--text-primary);
    display: flex;
    flex-direction: column;
    min-height: 100vh;
    line-height: 1.6;
    transition: background-color 0.3s, color 0.3s;
  }
  header {
    background: var(--bg-header);
    color: var(--text-light);
    padding: 1.5rem 1rem;
    text-align: center;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    display: flex;
    justify-content: center;
    align-items: center;
    position: relative;
  }
  header h1 {
    margin: 0;
  }
  nav {
    background: var(--bg-secondary);
    display: flex;
    overflow-x: auto;
    border-bottom: 1px solid var(--border-color);
  }
  nav button {
    flex: 1;
    padding: 1rem;
    border: none;
    background: transparent;
    cursor: pointer;
    font-weight: 600;
    font-size: 0.95rem;
    color: var(--text-secondary);
    border-bottom: 3px solid transparent;
    transition: background 0.3s, border-color 0.3s, color 0.3s;
    white-space: nowrap;
  }
  nav button:hover:not([aria-selected="true"]) {
    background: var(--bg-tertiary);
    color: var(--accent-color);
  }
  nav button[aria-selected="true"] {
    color: var(--accent-color);
    border-bottom-color: var(--accent-color);
  }
  main {
    flex: 1;
    max-width: 1200px;
    width: 95%;
    margin: 1.5rem auto 2rem;
    background: var(--bg-secondary);
    box-shadow: 0 4px 20px var(--shadow-color);
    border-radius: var(--card-border-radius);
    padding: 2rem;
  }
  section {
    display: none;
  }
  section.active {
    display: block;
    animation: fadeIn 0.5s ease-in-out;
  }
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }
  h2 {
    color: var(--accent-color);
    margin-bottom: 1rem;
    border-bottom: 2px solid var(--bg-primary);
    padding-bottom: 0.5rem;
  }
  h3 {
    color: var(--text-primary);
    margin-top: 1.5rem;
    margin-bottom: 0.5rem;
    font-size: 1.1rem;
  }
  label {
    display: block;
    margin-top: 1rem;
    margin-bottom: 0.25rem;
    font-weight: 600;
    color: var(--text-primary);
  }
  input[type=text], input[type=number], input[type=date], input[type=time], select, textarea {
    width: 100%;
    padding: 0.7rem;
    font-size: 1rem;
    margin-top: 0.5rem;
    border-radius: var(--button-border-radius);
    border: 1px solid var(--border-color);
    box-sizing: border-box;
    transition: border-color 0.3s, box-shadow 0.3s;
    background-color: var(--bg-secondary);
    color: var(--text-primary);
  }
  
  .compact-add-form {
    margin-top: 1.5rem;
    padding: 1rem;
    background: var(--bg-tertiary);
    border: 1px dashed var(--border-color);
    border-radius: var(--card-border-radius);
  }
  .compact-add-form .input-group {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-top: 0.5rem;
  }
  .compact-add-form .input-group input[type="text"] {
    flex-grow: 1;
    margin: 0;
  }
  .compact-add-form button {
      margin-top: 1rem;
  }

  .color-picker-icon {
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
    width: 38px;
    height: 38px;
    padding: 0;
    border: none;
    border-radius: 50%;
    background-color: transparent;
    cursor: pointer;
    flex-shrink: 0;
    margin: 0;
  }
  .color-picker-icon::-webkit-color-swatch {
    border-radius: 50%;
    border: 2px solid #e0e0e0;
  }
  .color-picker-icon::-moz-color-swatch {
    border-radius: 50%;
    border: 2px solid #e0e0e0;
  }
  
  .edit-form input[type="color"] {
    width: 120px;
    height: 40px;
    padding: 0.5rem;
    margin-top: 0.5rem;
    border-radius: var(--button-border-radius);
    border: 1px solid var(--border-color);
    box-sizing: border-box;
    cursor: pointer;
  }
  
  input:focus, select:focus, textarea:focus {
    outline: none;
    border-color: var(--accent-color);
    box-shadow: 0 0 0 3px var(--accent-color-transp);
  }
  textarea {
    resize: vertical;
    min-height: 80px;
  }
  button {
    background-color: var(--accent-color);
    border: none;
    color: var(--text-light);
    padding: 0.8rem 1.5rem;
    margin-top: 1rem;
    font-size: 1rem;
    font-weight: bold;
    border-radius: var(--button-border-radius);
    cursor: pointer;
    transition: background-color 0.3s, transform 0.2s;
  }
  button:hover:not(:disabled) {
    background-color: var(--bg-header-hover);
    transform: translateY(-2px);
  }
  button:disabled {
    background-color: #aaa;
    cursor: not-allowed;
  }
  ul {
    margin-top: 0.5rem;
    max-height: 250px;
    overflow-y: auto;
    background: var(--bg-tertiary);
    padding: 1rem;
    border: 1px solid var(--border-color);
    border-radius: var(--card-border-radius);
    list-style-type: none;
  }
  ul li {
    padding: 0.75rem;
    padding-left: 35px;
    padding-right: 50px;
    margin-bottom: 0.5rem;
    position: relative;
    background: var(--bg-secondary);
    border-left: 4px solid var(--accent-color);
    border-radius: var(--button-border-radius);
    display: flex;
    align-items: center;
  }
  .subject-item {
    margin-bottom: 1.5rem;
    border: 1px solid var(--border-color);
    border-radius: var(--card-border-radius);
    padding: 1rem 1.5rem;
    background-color: var(--bg-secondary);
    transition: box-shadow 0.3s;
  }
  .subject-item:hover {
    box-shadow: 0 4px 12px var(--shadow-color);
  }
  .subject-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .subject-header-title {
    display: flex;
    align-items: center;
    flex-grow: 1;
    min-width: 0;
  }
  .color-box {
    width: 20px;
    height: 20px;
    border-radius: 4px;
    border: 1px solid #666;
    margin-right: 0.75rem;
    display: inline-block;
    vertical-align: middle;
    flex-shrink: 0;
  }
  .subject-title {
    font-size: 1.3rem;
    font-weight: bold;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .topic-list {
    margin-top: 1rem;
    padding-left: 0;
    list-style-type: none;
  }
  .topic-item {
    padding-right: 50px;
    border-radius: var(--button-border-radius);
    margin-bottom: 0.5rem;
    font-size: 0.95rem;
    background: var(--bg-tertiary);
    border: 1px solid var(--border-color);
    position: relative;
  }
  .topic-header {
    display: flex;
    align-items: center;
    font-weight: bold;
  }
  .topic-item .topic-description {
    font-size: 0.9rem;
    color: var(--text-secondary);
    margin-top: 0.5rem;
    padding-left: 22px;
  }
  .edit-form {
    margin-top: 1.5rem;
    padding: 1rem;
    background: var(--bg-tertiary);
    border: 1px solid var(--accent-color);
    border-radius: var(--card-border-radius);
  }
  .edit-form button {
      margin-right: 0.5rem;
  }
  .edit-form button.cancel-btn {
      background-color: #6c757d;
  }
  .edit-form button.cancel-btn:hover {
      background-color: #5a6268;
  }
  #timer-display {
    font-size: 4rem;
    text-align: center;
    margin: 1.5rem 0;
    color: var(--accent-color);
    font-weight: bold;
    font-family: 'Courier New', Courier, monospace;
  }
  .timer-controls button {
      margin: 0 5px;
  }
  table {
    border-collapse: collapse;
    width: 100%;
    margin-top: 1rem;
  }
  th, td {
    border: 1px solid var(--border-color);
    padding: 0.6rem;
    text-align: left;
    vertical-align: middle;
    font-size: 0.9rem;
  }
  th {
    background-color: var(--accent-color);
    color: var(--text-light);
    font-weight: 600;
  }
  tr:nth-child(even) {
      background-color: var(--bg-tertiary);
  }
  canvas {
    width: 100% !important;
    max-width: 100%;
    height: 350px;
    max-height: 400px;
    margin-top: 1rem;
    box-sizing: border-box;
  }
  footer {
      text-align: center;
      padding: 1.5rem;
      margin-top: 2rem;
      background: var(--bg-secondary);
      color: var(--text-secondary);
      font-size: 0.9rem;
      border-top: 1px solid var(--border-color);
  }
  .icon-btn {
    background: transparent;
    border: none;
    cursor: pointer;
    padding: 5px;
    border-radius: 50%;
    width: 32px;
    height: 32px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    transition: background-color 0.2s, color 0.2s;
    margin: 0;
  }
  .icon-btn.delete-btn { color: #e74c3c; }
  .icon-btn.delete-btn:hover { background-color: #fbe9e7; }
  .icon-btn.edit-btn { color: var(--accent-color); }
  .icon-btn.edit-btn:hover { background-color: var(--bg-tertiary); }
  .icon-btn.toggle-subject-btn { color: var(--text-secondary); margin-right: 5px; }

  .icon-btn:hover {
    transform: none;
  }
  .icon-btn svg {
    width: 16px;
    height: 16px;
  }
  
  .subject-header-title .edit-btn, .topic-header .edit-btn {
    margin-left: 10px;
    flex-shrink: 0;
  }
  .actions {
    display: flex;
    align-items: center;
    flex-shrink: 0;
  }
  .subject-header .actions {
    margin-left: 1rem;
  }
  .topic-item .actions {
    position: absolute;
    top: 50%;
    right: 5px;
    transform: translateY(-50%);
  }
  
  td .icon-btn {
      margin: auto;
  }

  /* --- CONFIGURAÇÕES E MODAL --- */
  #settings-btn {
    position: absolute;
    top: 1rem;
    right: 1rem;
    background: transparent;
    border: none;
    color: white;
    padding: 8px;
    cursor: pointer;
    border-radius: 50%;
  }
  #settings-btn:hover {
    background-color: rgba(255,255,255,0.1);
  }
  #settings-menu {
    display: none;
    position: absolute;
    top: 50px;
    right: 1rem;
    background-color: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: var(--card-border-radius);
    box-shadow: 0 4px 12px var(--shadow-color);
    z-index: 1000;
    width: 220px;
    padding: 5px 0;
  }
  #settings-menu button {
    display: block;
    width: 100%;
    text-align: left;
    background: none;
    border: none;
    padding: 12px 15px;
    color: var(--text-primary);
    cursor: pointer;
    margin: 0;
    border-radius: 0;
  }
  #settings-menu button:hover {
    background-color: var(--bg-tertiary);
  }
  
  .modal-overlay {
    display: none;
    position: fixed;
    z-index: 2000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0,0,0,0.5);
    align-items: center;
    justify-content: center;
  }
  .modal-content {
    background-color: var(--bg-secondary);
    margin: auto;
    padding: 25px;
    border: 1px solid var(--border-color);
    border-radius: var(--card-border-radius);
    width: 90%;
    max-width: 600px;
    text-align: center;
  }
  .modal-content p {
    margin-bottom: 1.5rem;
    line-height: 1.7;
  }
  .modal-content button {
    min-width: 100px;
    margin: 0 5px;
  }
  #backup-folder-path, #themes-folder-path {
    font-weight: bold;
    color: var(--accent-color);
    word-break: break-all;
  }

  /* --- MODAL DE INSTRUÇÕES --- */
  #instructions-modal .modal-content {
      max-width: 90vw;
      width: 950px;
      max-height: 90vh;
      display: flex;
      flex-direction: column;
      text-align: left;
  }
  #instructions-modal .instructions-body {
      overflow-y: auto;
      padding-right: 1rem; /* Espaço para a barra de rolagem */
  }
  .instructions-body h3 {
      color: var(--accent-color);
      margin-top: 2rem;
      border-bottom: 1px solid var(--border-color);
      padding-bottom: 0.5rem;
  }
  .instructions-body h4 {
      margin-top: 1.5rem;
      margin-bottom: 0.5rem;
  }
  .instructions-body p {
      margin-bottom: 1rem;
  }
  .instructions-body img {
      max-width: 100%;
      height: auto;
      border-radius: var(--card-border-radius);
      border: 1px solid var(--border-color);
      margin: 1rem 0;
      box-shadow: 0 2px 8px var(--shadow-color);
  }

  /* --- MODAL DE TEMAS --- */
  #themes-grid, #custom-themes-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 1rem;
    margin-top: 1rem;
    margin-bottom: 1.5rem;
    max-height: 60vh;
    overflow-y: auto;
    padding: 5px;
  }
  .theme-preview {
    border: 2px solid var(--border-color);
    border-radius: var(--card-border-radius);
    cursor: pointer;
    transition: transform 0.2s, border-color 0.2s;
    overflow: hidden;
    position: relative;
  }
  .theme-preview:hover {
    transform: scale(1.05);
    border-color: var(--accent-color);
  }
  .theme-preview.active {
    border-color: var(--accent-color);
    box-shadow: 0 0 0 3px var(--accent-color);
  }
  .theme-palette {
    display: flex;
    height: 60px;
  }
  .theme-palette div {
    flex: 1;
  }
  .theme-name {
    padding: 0.5rem;
    font-weight: 600;
    background-color: var(--bg-tertiary);
    font-size: 0.9rem;
  }
  .custom-theme-actions {
    position: absolute;
    top: 2px;
    right: 2px;
    background-color: rgba(0,0,0,0.3);
    border-radius: 5px;
    display: flex;
  }
  .custom-theme-actions .icon-btn {
    width: 24px;
    height: 24px;
    color: white;
  }
  .modal-actions {
    display: flex;
    justify-content: center;
    gap: 1rem;
    margin-top: 1.5rem;
  }

  /* --- EDITOR DE TEMA --- */
  #theme-editor-form {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem 2rem;
    text-align: left;
  }
  .form-group {
    display: flex;
    flex-direction: column;
  }
  .form-group.full-width {
    grid-column: 1 / -1;
  }
  .form-group label {
    margin-bottom: 0.5rem;
  }
  .form-group input[type="color"] {
    width: 100%;
    height: 40px;
    padding: 2px;
  }

  /* --- CICLOS DE ESTUDO --- */
  .cycle-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem;
    border: 1px solid var(--border-color);
    border-radius: var(--card-border-radius);
    margin-bottom: 1rem;
    background-color: var(--bg-tertiary);
  }
  .cycle-item-info strong {
    display: block;
    font-size: 1.1rem;
    color: var(--accent-color);
  }
  .cycle-item-info span {
    font-size: 0.9rem;
    color: var(--text-secondary);
  }
  .cycle-item-actions button {
    margin: 0 0 0 0.5rem;
  }
  .cycle-item-actions button:not(.icon-btn) {
    padding: 0.5rem 1rem;
  }
  #cycle-subjects-container .cycle-subject-entry {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 0.5rem;
  }
  #cycle-subjects-container label {
    margin: 0;
    flex-shrink: 0;
  }

  /* --- ESTILOS DO CALENDÁRIO --- */
  #calendar-container {
    margin-top: 1.5rem;
  }
  #calendar-filters {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    align-items: flex-end;
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid var(--border-color);
  }
  #calendar-filters .filter-group {
    display: flex;
    flex-direction: column;
    flex-grow: 1;
  }
  #calendar-filters label {
    font-size: 0.9rem;
    margin-top: 0;
    margin-bottom: 0.5rem;
  }
  #calendar-filters input, #calendar-filters select {
    margin-top: 0;
    padding: 0.5rem;
  }
  #calendar-filters .view-buttons-group {
    flex-grow: 2;
    text-align: right;
  }
  #calendar-filters .view-buttons-group button {
    margin: 0 0 0 5px;
    padding: 0.5rem 0.8rem;
    font-size: 0.9rem;
  }

  .fc .fc-toolbar-title {
    font-size: 1.5em !important;
    color: var(--accent-color);
  }
  .fc .fc-button-primary {
    background-color: var(--accent-color) !important;
    border-color: var(--accent-color) !important;
  }
  .fc .fc-button-primary:hover {
    background-color: var(--bg-header-hover) !important;
  }
  .fc .fc-daygrid-day.fc-day-today {
    background-color: rgba(0, 90, 156, 0.1);
  }
  .fc-event {
    cursor: pointer;
  }
  
  /* --- ESTILOS PARA REORDENAÇÃO (DRAG & DROP) --- */
  .drag-handle {
    cursor: grab;
    color: var(--text-secondary);
    opacity: 0.6;
    margin-right: 10px;
    flex-shrink: 0;
  }
  .drag-handle:hover {
    opacity: 1;
  }
  .sortable-ghost {
    opacity: 0.4;
    background: #c8ebfb;
  }
  .sortable-chosen {
    cursor: grabbing;
  }
  li .drag-handle, .cycle-item .drag-handle {
    position: static;
    transform: none;
  }
  li .drag-handle {
    position: absolute;
    left: 8px;
    top: 50%;
    transform: translateY(-50%);
  }


  @media (max-width: 768px) {
    #calendar-filters {
        flex-direction: column;
        align-items: stretch;
        gap: 1.5rem;
    }
    #calendar-filters .view-buttons-group {
        text-align: left;
    }
    .fc .fc-toolbar.fc-header-toolbar {
        flex-direction: column;
        gap: 10px;
    }
    #instructions-modal .modal-content {
        max-width: 95vw;
        width: 100%;
    }
  }

  @media (max-width: 600px) {
    nav button {
      font-size: 0.8rem;
      padding: 0.8rem 0.5rem;
    }
    main {
        padding: 1rem;
    }
    h2 {
        font-size: 1.2rem;
    }
    #timer-display {
        font-size: 3rem;
    }
    #theme-editor-form {
        grid-template-columns: 1fr;
    }
  }
</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.min.js"></script>
<!-- FullCalendar JS -->
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/locales/pt-br.js"></script>
<!-- SortableJS para Drag & Drop -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
</head>
<body>

<header>
  <h1>Gerenciador de Estudos 22</h1>
  <button id="settings-btn" title="Configurações">
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16">
      <path d="M9.405 1.05c-.413-1.4-2.397-1.4-2.81 0l-.1.34a1.464 1.464 0 0 1-2.105.872l-.31-.17c-1.283-.698-2.686.705-1.987 1.987l.169.311a1.464 1.464 0 0 1 .872 2.105l-.34.1c-1.4.413-1.4 2.397 0 2.81l.34.1a1.464 1.464 0 0 1-.872 2.105l-.17.31c-.698 1.283.705 2.686 1.987 1.987l.311-.169a1.464 1.464 0 0 1 2.105.872l.1.34c.413 1.4 2.397 1.4 2.81 0l.1-.34a1.464 1.464 0 0 1 2.105-.872l.31.17c1.283.698 2.686-.705 1.987-1.987l-.169-.311a1.464 1.464 0 0 1-.872-2.105l.34-.1c-1.4-.413-1.4-2.397 0-2.81l-.34-.1a1.464 1.464 0 0 1 .872-2.105l.17-.31c.698-1.283-.705-2.686-1.987-1.987l-.311.169a1.464 1.464 0 0 1-2.105-.872l-.1-.34zM8 10.93a2.929 2.929 0 1 1 0-5.858 2.929 2.929 0 0 1 0 5.858z"/>
    </svg>
  </button>
  <div id="settings-menu">
    <button id="themes-btn">Temas</button>
    <button id="custom-themes-btn">Personalizar Temas</button>
    <hr style="border: none; border-top: 1px solid var(--border-color); margin: 5px 0;">
    <button id="export-data-btn">Exportar Dados</button>
    <button id="import-data-btn">Importar Dados</button>
    <input type="file" id="import-file-input" style="display: none;" accept=".json">
    <button id="schedule-backup-btn">Agendar Backup</button>
    <hr style="border: none; border-top: 1px solid var(--border-color); margin: 5px 0;">
    <button id="instructions-btn">Instruções</button>
    <button id="about-btn">Sobre</button>
  </div>
</header>

<nav role="tablist" aria-label="Navegação das abas">
  <button role="tab" aria-selected="true" aria-controls="tab-subjects" id="tab-btn-subjects" tabindex="0">Disciplinas</button>
  <button role="tab" aria-selected="false" aria-controls="tab-schedule" id="tab-btn-schedule" tabindex="-1">Atividades Agendadas</button>
  <button role="tab" aria-selected="false" aria-controls="tab-timer" id="tab-btn-timer" tabindex="-1">Cronômetro</button>
  <button role="tab" aria-selected="false" aria-controls="tab-record" id="tab-btn-record" tabindex="-1">Registrar Estudo</button>
  <button role="tab" aria-selected="false" aria-controls="tab-progress" id="tab-btn-progress" tabindex="-1">Histórico &amp; Gráficos</button>
  <button role="tab" aria-selected="false" aria-controls="tab-revision" id="tab-btn-revision" tabindex="-1">Agenda de Revisões</button>
</nav>

<main>
  <!-- Aba Disciplinas -->
  <section tabindex="0" role="tabpanel" id="tab-subjects" aria-labelledby="tab-btn-subjects" class="active">
    <h2>Disciplinas / Matérias</h2>
    <div class="compact-add-form">
      <label for="subject-name">Adicionar nova disciplina:</label>
      <div class="input-group">
        <input id="subject-name" type="text" placeholder="Ex: Matemática" autocomplete="off" />
        <input id="subject-color" type="color" class="color-picker-icon" value="#005a9c" title="Escolha uma cor para a disciplina" />
      </div>
      <button id="add-subject-btn">Adicionar Disciplina</button>
    </div>

    <div id="subjects-container" aria-live="polite" aria-label="Lista de disciplinas com opções" style="margin-top: 2rem;"></div>
    
    <div class="compact-add-form" style="margin-top: 2.5rem;">
        <h3>Agendar Estudo</h3>
        <label for="alarm-subject">Disciplina:</label>
        <select id="alarm-subject">
          <option value="">-- Escolha uma disciplina --</option>
        </select>
        <label for="alarm-topic">Assunto:</label>
        <select id="alarm-topic" disabled>
          <option value="">-- Assunto (opcional) --</option>
        </select>
        <label for="alarm-date">Data:</label>
        <input type="date" id="alarm-date" />
        <label for="alarm-time">Hora de Início:</label>
        <input type="time" id="alarm-time" />
        <label for="alarm-end-time">Hora de Fim:</label>
        <input type="time" id="alarm-end-time" />
        <button id="add-study-alarm-btn">Agendar Estudo</button>
    </div>
    <h3 style="margin-top: 2rem;">Estudos Agendados</h3>
    <ul id="study-alarm-list"></ul>
  </section>
  
  <!-- Aba Atividades Agendadas (Calendário) -->
  <section tabindex="0" role="tabpanel" id="tab-schedule" aria-labelledby="tab-btn-schedule">
    <h2>Atividades Agendadas</h2>
    <div id="calendar-filters">
        <div class="filter-group">
            <label for="calendar-main-filter">Filtrar por tipo:</label>
            <select id="calendar-main-filter">
                <option value="all">Todos</option>
                <option value="type:study">Estudos</option>
                <option value="type:revision">Revisões</option>
            </select>
        </div>
        <div class="filter-group view-buttons-group">
            <label>&nbsp;</label> <!-- Para alinhamento -->
            <div>
                <button class="view-btn" data-view="dayGridMonth">Mês</button>
                <button class="view-btn" data-view="timeGridWeek">Semana</button>
                <button class="view-btn" data-view="timeGridDay">Dia</button>
                <button class="view-btn" data-view="listYear">Anual</button>
            </div>
        </div>
    </div>
    <div id="calendar-container">
        <div id="calendar"></div>
    </div>
  </section>

  <!-- Aba Cronômetro -->
  <section tabindex="0" role="tabpanel" id="tab-timer" aria-labelledby="tab-btn-timer">
    <h2>Cronômetro</h2>
    
    <div id="timer-mode-selector" style="display: flex; gap: 1rem; margin-bottom: 1rem; justify-content: center; align-items: center;">
        <label style="margin-top:0; display:flex; align-items:center; gap: 5px;"><input type="radio" name="timerMode" value="study" checked> Estudo</label>
        <label style="margin-top:0; display:flex; align-items:center; gap: 5px;"><input type="radio" name="timerMode" value="rest"> Descanso</label>
    </div>

    <div id="timer-subject-group">
        <label for="timer-subject">Selecione a disciplina:</label>
        <select id="timer-subject" aria-required="true" aria-label="Selecionar disciplina para estudo">
          <option value="">-- Escolha uma disciplina --</option>
        </select>
        <label for="timer-topic">Assunto (opcional):</label>
        <select id="timer-topic" disabled>
            <option value="">-- Geral da disciplina --</option>
        </select>
    </div>

    <label for="timer-minutes">Defina o tempo (minutos):</label>
    <input type="number" id="timer-minutes" min="1" max="180" value="25" aria-required="true" aria-label="Tempo em minutos" />

    <div id="timer-display" aria-live="assertive" aria-atomic="true">00:00</div>

    <div class="timer-controls" style="text-align: center;">
      <button id="start-timer-btn">Iniciar</button>
      <button id="pause-timer-btn" disabled>Pausar</button>
      <button id="reset-timer-btn" disabled>Resetar</button>
    </div>

    <p id="timer-message" role="alert" aria-live="polite" style="display:none; text-align:center; margin-top:1rem; font-weight:bold;"></p>
    
    <hr style="border: none; border-top: 1px solid var(--border-color); margin: 2.5rem 0;">

    <h2>Ciclos de Estudo</h2>
    <div id="study-cycles-container"></div>
    <div style="text-align: center; margin-top: 1rem;">
        <button id="create-cycle-btn">Criar Novo Ciclo</button>
    </div>
  </section>

  <!-- Aba Registrar Estudo -->
  <section tabindex="0" role="tabpanel" id="tab-record" aria-labelledby="tab-btn-record">
    <h2>Registrar Progresso de Estudo</h2>
    <label for="record-subject">Disciplina:</label>
    <select id="record-subject" aria-required="true" aria-label="Selecionar disciplina para registro">
      <option value="">-- Escolha --</option>
    </select>
    <label for="record-topic">Assunto (opcional):</label>
    <select id="record-topic" disabled>
        <option value="">-- Geral da disciplina --</option>
    </select>

    <label for="study-method">Método de estudo:</label>
    <select id="study-method">
      <option value="Leitura">Leitura</option>
      <option value="Resumos">Resumos</option>
      <option value="Prática de Questões">Prática de Questões</option>
      <option value="Vídeo Aula">Vídeo Aula</option>
      <option value="Revisão">Revisão</option>
      <option value="Outro">Outro</option>
    </select>

    <label for="study-duration">Duração do estudo (minutos):</label>
    <input type="number" id="study-duration" min="1" value="25" />
    
    <label for="rest-duration">Tempo de descanso (minutos, opcional):</label>
    <input type="number" id="rest-duration" min="1" placeholder="Ex: 5" />

    <label for="pages-studied">Páginas / Exercícios / Quantidade:</label>
    <input type="text" id="pages-studied" placeholder="Ex: 30 páginas, 15 questões" />

    <label for="notes">Anotações / Pontos importantes:</label>
    <textarea id="notes" placeholder="Anote dúvidas, pontos-chave para revisão futura..."></textarea>

    <button id="record-study-btn">Registrar Estudo</button>
  </section>

  <!-- Aba Histórico e Gráficos -->
  <section tabindex="0" role="tabpanel" id="tab-progress" aria-labelledby="tab-btn-progress">
    <h2>Histórico de Estudos</h2>
    <div style="overflow-x:auto;">
        <table id="progress-table" aria-label="Histórico de estudos">
          <thead>
            <tr>
              <th>Data</th>
              <th>Disciplina</th>
              <th>Assunto</th>
              <th>Método</th>
              <th>Duração (min)</th>
              <th>Resumo</th>
              <th>Descanso (min)</th>
              <th style="text-align: center;">Ação</th>
            </tr>
          </thead>
          <tbody>
            <!-- Registros preenchidos dinamicamente -->
          </tbody>
        </table>
    </div>

    <h2 style="margin-top: 2rem;">Visualização Gráfica</h2>
    <label for="graph-type">Tipo de gráfico:</label>
    <select id="graph-type" aria-label="Selecionar tipo de gráfico para visualização">
      <option value="bar">Barras</option>
      <option value="line">Linha</option>
      <option value="pie">Pizza</option>
    </select>

    <label for="graph-timeframe">Mostrar estudo dos últimos (dias):</label>
    <input type="number" id="graph-timeframe" min="1" max="365" value="30" />

    <label for="graph-subjects">Selecione disciplinas para mostrar no gráfico:</label>
    <select id="graph-subjects" multiple size="5" aria-label="Selecionar disciplinas para gráfico"></select>
    
    <label for="graph-topics">Filtrar por assuntos (opcional):</label>
    <select id="graph-topics" multiple size="5"></select>

    <button id="update-graph-btn">Atualizar Gráfico</button>

    <canvas id="study-chart" role="img" aria-label="Gráfico resumo do tempo de estudo por disciplina"></canvas>
  </section>

  <!-- Aba Agenda de Revisões -->
  <section tabindex="0" role="tabpanel" id="tab-revision" aria-labelledby="tab-btn-revision">
    <h2>Agenda de Revisões</h2>
    <label for="revision-subject">Disciplina para revisão:</label>
    <select id="revision-subject">
      <option value="">-- Escolha a disciplina --</option>
    </select>
    
    <label for="revision-topic">Assunto para revisão (opcional):</label>
    <select id="revision-topic" disabled>
        <option value="">-- Geral da disciplina --</option>
    </select>

    <label for="revision-date">Data para revisão:</label>
    <input type="date" id="revision-date" />
    <label for="revision-time">Hora de Início:</label>
    <input type="time" id="revision-time" />
    <label for="revision-end-time">Hora de Fim:</label>
    <input type="time" id="revision-end-time" />

    <label for="revision-notes">Notas para revisão:</label>
    <textarea id="revision-notes" placeholder="O que revisar..."></textarea>

    <button id="add-revision-btn">Agendar Revisão</button>

    <h3 style="margin-top: 2rem;">Revisões Agendadas</h3>
    <ul id="revision-list" aria-live="polite"></ul>
  </section>
</main>

<div id="instructions-modal" class="modal-overlay">
    <div class="modal-content">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <h2 style="margin: 0;">Guia de Instruções</h2>
            <button class="close-modal-btn" style="margin: 0; padding: 0.5rem 1rem;">Fechar</button>
        </div>
        <div class="instructions-body">
            <p>Bem-vindo ao guia do <strong>Gerenciador de Estudos 22</strong>! Aqui você aprenderá a usar todas as funcionalidades do programa para organizar seus estudos da melhor forma.</p>
            
            <h3>Menu de Configurações (Ícone de Engrenagem)</h3>
            <p>No canto superior direito, você encontra o menu de configurações. Ele dá acesso a:</p>
            <ul>
                <li><strong>Temas:</strong> Mude a aparência do aplicativo com temas pré-definidos.</li>
                <li><strong>Personalizar Temas:</strong> Crie, edite e gerencie seus próprios temas.</li>
                <li><strong>Exportar/Importar Dados:</strong> Salve (backup) ou carregue todos os seus dados.</li>
                <li><strong>Agendar Backup:</strong> Configure backups automáticos para uma pasta de sua escolha.</li>
                <li><strong>Instruções:</strong> Abre este guia que você está lendo.</li>
                <li><strong>Sobre:</strong> Mostra informações sobre o desenvolvedor.</li>
            </ul>
            <img src="https://i.imgur.com/BhWhxK7.png" alt="Menu de Configurações">

            <h3>Aba: Disciplinas</h3>
            <p>Esta é a aba principal onde você organiza suas matérias e o que precisa estudar.</p>
            <h4>Adicionando Disciplinas</h4>
            <p>Use o primeiro formulário para adicionar uma nova disciplina. Digite o nome, escolha uma cor para fácil identificação e clique em "Adicionar Disciplina".</p>
            <img src="https://i.imgur.com/8iGOUKO.png" alt="Formulário para adicionar disciplina">
            <h4>Gerenciando Disciplinas e Assuntos</h4>
            <p>Cada disciplina criada aparece em uma lista. Você pode:</p>
            <ul>
                <li><strong>Expandir/Minimizar (seta):</strong> Mostra ou esconde os assuntos e o formulário de adição de assuntos.</li>
                <li><strong>Arrastar (ícone de pontos):</strong> Mude a ordem das disciplinas.</li>
                <li><strong>Editar (lápis):</strong> Altere o nome e a cor da disciplina.</li>
                <li><strong>Excluir (lixeira):</strong> Remove a disciplina e todos os dados associados a ela.</li>
                <li><strong>Adicionar Assunto:</strong> Dentro de cada disciplina expandida, você pode adicionar assuntos específicos com nome, cor e descrição.</li>
            </ul>
            <img src="https://i.imgur.com/zr30woA.png" alt="Exemplo de disciplina na lista">
            <h4>Agendar Estudo</h4>
            <p>No final da aba, há um formulário para agendar um estudo. Selecione a disciplina, data e horários. O evento aparecerá na lista de "Estudos Agendados" e também no calendário da próxima aba.</p>

            <h3>Aba: Atividades Agendadas</h3>
            <p>Aqui você visualiza todos os seus estudos e revisões agendados em um calendário interativo.</p>
            <ul>
                <li><strong>Filtros:</strong> Você pode filtrar os eventos por tipo (Estudo, Revisão), por disciplina ou por assunto.</li>
                <li><strong>Visualizações:</strong> Alterne entre as visualizações de Mês, Semana, Dia ou uma Lista Anual.</li>
                <li><strong>Detalhes:</strong> Clique em um evento no calendário para ver seus detalhes.</li>
            </ul>
            <img src="https://i.imgur.com/0EJ309C.png" alt="Calendário de atividades">

            <h3>Aba: Cronômetro</h3>
            <p>Use esta aba para focar em seus estudos com um cronômetro e para gerenciar ciclos de estudo (como a técnica Pomodoro).</p>
            <h4>Cronômetro Simples</h4>
            <p>Selecione o modo (Estudo ou Descanso), escolha a disciplina (para o modo Estudo), defina os minutos e clique em "Iniciar". O tempo de estudo será registrado automaticamente no seu histórico ao final.</p>
            <img src="https://i.imgur.com/I10xT2I.png" alt="Cronômetro">
            <h4>Ciclos de Estudo</h4>
            <p>Crie um novo ciclo definindo um nome, tempo de estudo, tempo de descanso e o número de sessões. Para cada sessão, escolha uma disciplina. Ao iniciar um ciclo, o cronômetro irá alternar automaticamente entre estudo e descanso, registrando seu progresso.</p>
            <img src="https://i.imgur.com/UE5IVFA.png" alt="Ciclos de Estudo">

            <h3>Aba: Registrar Estudo</h3>
            <p>Esta aba permite que você registre manualmente uma sessão de estudo que já completou. Preencha os detalhes como disciplina, método, duração e anotações.</p>
            <img src="https://i.imgur.com/cUOluEn.png" alt="Registrar estudo manualmente">

            <h3>Aba: Histórico & Gráficos</h3>
            <p>Analise seu desempenho aqui.</p>
            <h4>Histórico de Estudos</h4>
            <p>Uma tabela mostra todos os seus registros de estudo, sejam eles do cronômetro ou manuais. Você pode excluir registros individuais na lixeira.</p>
            <h4>Visualização Gráfica</h4>
            <p>Filtre seus dados para gerar gráficos. Escolha o tipo de gráfico (barras, linha, pizza), o período de tempo e as disciplinas/assuntos que deseja visualizar. Clique em "Atualizar Gráfico" para ver os resultados.</p>
            <img src="https://i.imgur.com/rQ3t5EA.png" alt="Gráfico de desempenho">

            <h3>Aba: Agenda de Revisões</h3>
            <p>Agende suas revisões futuras. Preencha o formulário com a disciplina, data, horários e notas sobre o que precisa ser revisado. As revisões agendadas aparecerão na lista e também no calendário.</p>
            <img src="https://i.imgur.com/N8KAdGh.png" alt="Agenda de Revisões">
        </div>
    </div>
</div>


<div id="about-modal" class="modal-overlay">
  <div class="modal-content">
    <h3>Sobre o Gerenciador de Estudos</h3>
    <p>Este programa foi desenvolvido com o objetivo de ajudar alunos de todos os graus acadêmicos a organizarem seus estudos e serem bem sucedidos no gerenciamento do seu tempo e alcançar seus objetivos de forma disciplinada e eficiente.</p>
    <p><strong>Desenvolvido por:</strong> Luan Carlos Marques Cutrim</p>
    <button class="close-modal-btn">Fechar</button>
  </div>
</div>

<div id="alarm-modal" class="modal-overlay">
  <div class="modal-content">
    <h3 id="alarm-title">Alarme!</h3>
    <p id="alarm-text">É hora de estudar/revisar.</p>
    <button id="close-alarm-btn">OK</button>
  </div>
</div>

<div id="backup-modal" class="modal-overlay">
  <div class="modal-content">
    <h3>Agendar Backup Automático</h3>
    <p>Defina o destino e a frequência dos backups automáticos.</p>
    
    <button id="choose-backup-folder-btn" style="margin-bottom: 1rem;">Escolher Pasta de Backup</button>
    <p style="font-size: 0.9em; color: var(--text-secondary);">Pasta: <span id="backup-folder-path">Nenhuma (usará a pasta Downloads)</span></p>

    <hr style="border: none; border-top: 1px solid var(--border-color); margin: 1rem 0;">

    <label for="backup-interval">Fazer backup a cada (dias):</label>
    <input type="number" id="backup-interval" min="1" value="7" style="text-align: center; max-width: 100px; margin: 0 auto;"/>
    <p id="backup-status" style="font-size: 0.9em; color: var(--text-secondary); margin-top: 1rem;"></p>
    
    <div>
        <button id="save-backup-schedule-btn">Salvar</button>
        <button id="cancel-backup-schedule-btn" class="cancel-btn">Cancelar</button>
    </div>
  </div>
</div>

<div id="themes-modal" class="modal-overlay">
  <div class="modal-content">
    <h3>Biblioteca de Temas</h3>
    <p>Clique em um tema para aplicá-lo instantaneamente.</p>
    <div id="themes-grid">
      <!-- Os temas serão inseridos aqui pelo JavaScript -->
    </div>
    <button class="close-modal-btn">Fechar</button>
  </div>
</div>

<div id="custom-themes-modal" class="modal-overlay">
  <div class="modal-content">
    <h3>Meus Temas Personalizados</h3>
    <p>Crie, edite, importe ou exporte seus próprios temas.</p>
    <button id="choose-themes-folder-btn" style="margin-bottom: 1rem;">Escolher Pasta de Temas</button>
    <p style="font-size: 0.9em; color: var(--text-secondary);">Pasta: <span id="themes-folder-path">Nenhuma (usará a pasta Downloads)</span></p>
    <hr style="border: none; border-top: 1px solid var(--border-color); margin: 1rem 0;">
    <div id="custom-themes-grid"></div>
    <div class="modal-actions">
      <button id="create-new-theme-btn">Criar Novo Tema</button>
      <button id="import-themes-btn">Importar Tema(s)</button>
      <input type="file" id="import-themes-input" style="display: none;" accept=".json">
      <button id="export-themes-btn">Exportar Meus Temas</button>
    </div>
    <button class="close-modal-btn" style="margin-top: 1rem;">Fechar</button>
  </div>
</div>

<div id="theme-editor-modal" class="modal-overlay">
  <div class="modal-content">
    <h3 id="theme-editor-title">Criar Novo Tema</h3>
    <form id="theme-editor-form">
      <input type="hidden" id="theme-editor-id">
      <div class="form-group full-width">
        <label for="theme-name-input">Nome do Tema</label>
        <input type="text" id="theme-name-input" required>
      </div>
      <div class="form-group">
        <label for="theme-accent-color-input">Cor de Destaque</label>
        <input type="color" id="theme-accent-color-input" value="#005a9c">
      </div>
      <div class="form-group">
        <label for="theme-bg-header-input">Cabeçalho</label>
        <input type="color" id="theme-bg-header-input" value="#005a9c">
      </div>
       <div class="form-group">
        <label for="theme-bg-header-hover-input">Cabeçalho (Hover)</label>
        <input type="color" id="theme-bg-header-hover-input" value="#004477">
      </div>
      <div class="form-group">
        <label for="theme-bg-primary-input">Fundo Principal</label>
        <input type="color" id="theme-bg-primary-input" value="#f5f7fa">
      </div>
      <div class="form-group">
        <label for="theme-bg-secondary-input">Fundo Secundário</label>
        <input type="color" id="theme-bg-secondary-input" value="#ffffff">
      </div>
      <div class="form-group">
        <label for="theme-bg-tertiary-input">Fundo Terciário</label>
        <input type="color" id="theme-bg-tertiary-input" value="#f9f9f9">
      </div>
      <div class="form-group">
        <label for="theme-text-primary-input">Texto Principal</label>
        <input type="color" id="theme-text-primary-input" value="#333333">
      </div>
      <div class="form-group">
        <label for="theme-text-secondary-input">Texto Secundário</label>
        <input type="color" id="theme-text-secondary-input" value="#555555">
      </div>
       <div class="form-group">
        <label for="theme-text-light-input">Texto Claro (p/ Cabeçalho)</label>
        <input type="color" id="theme-text-light-input" value="#ffffff">
      </div>
      <div class="form-group">
        <label for="theme-border-color-input">Cor da Borda</label>
        <input type="color" id="theme-border-color-input" value="#dddddd">
      </div>
      <div class="form-group full-width">
        <label for="theme-font-family-base-input">Estilo da Fonte</label>
        <select id="theme-font-family-base-input">
          <option value='-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif'>Padrão (Sans-Serif)</option>
          <option value="'Georgia', 'Times New Roman', serif">Serifada (Georgia)</option>
          <option value="'Courier New', Courier, monospace">Monoespaçada (Courier)</option>
        </select>
      </div>
    </form>
    <div class="modal-actions">
      <button id="save-theme-btn">Salvar Tema</button>
      <button id="cancel-theme-edit-btn" class="cancel-btn">Cancelar</button>
    </div>
  </div>
</div>

<div id="cycle-creator-modal" class="modal-overlay">
  <div class="modal-content">
    <h3 id="cycle-creator-title">Criar Novo Ciclo de Estudo</h3>
    <form id="cycle-creator-form" style="text-align: left;">
        <input type="hidden" id="cycle-editor-id">
        <label for="cycle-name-input">Nome do Ciclo:</label>
        <input type="text" id="cycle-name-input" required placeholder="Ex: Manhã Produtiva">

        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
            <div>
                <label for="cycle-study-time-input">Tempo de Estudo (min):</label>
                <input type="number" id="cycle-study-time-input" value="25" min="1" required>
            </div>
            <div>
                <label for="cycle-rest-time-input">Tempo de Descanso (min):</label>
                <input type="number" id="cycle-rest-time-input" value="5" min="1" required>
            </div>
            <div>
                <label for="cycle-count-input">Nº de Ciclos:</label>
                <input type="number" id="cycle-count-input" value="2" min="1" max="10" required>
            </div>
        </div>

        <h4 style="margin-top: 1.5rem; margin-bottom: 0.5rem; text-align: center;">Disciplinas por Ciclo</h4>
        <div id="cycle-subjects-container" style="max-height: 200px; overflow-y: auto; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: var(--button-border-radius);">
            <!-- Dynamic subject selects will be inserted here -->
        </div>
    </form>
    <div class="modal-actions">
      <button id="save-cycle-btn">Salvar Ciclo</button>
      <button id="cancel-cycle-edit-btn" class="cancel-btn">Cancelar</button>
    </div>
  </div>
</div>

<div id="confirmation-modal" class="modal-overlay">
  <div class="modal-content">
    <h3 id="confirmation-title">Confirmar Ação</h3>
    <p id="confirmation-text">Você tem certeza?</p>
    <div class="modal-actions">
        <button id="confirm-btn">Confirmar</button>
        <button id="cancel-btn" class="cancel-btn">Cancelar</button>
    </div>
  </div>
</div>

<div id="info-modal" class="modal-overlay">
  <div class="modal-content">
    <h3 id="info-title">Aviso</h3>
    <p id="info-text">Operação concluída.</p>
    <button id="info-ok-btn" style="margin: 1rem auto 0;">OK</button>
  </div>
</div>

<footer>
  &copy; 2025 Gerenciador de Estudos 22
</footer>

<script>
document.addEventListener('DOMContentLoaded', () => {
  // --- SERVICE WORKER REGISTRATION ---
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('/sw.js')
        .then(registration => {
          console.log('Service Worker registrado com sucesso:', registration);
        })
        .catch(error => {
          console.log('Falha ao registrar Service Worker:', error);
        });
    });
  }

  // Ícones em SVG para reutilização
  const trashIconSVG = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/><path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/></svg>`;
  const editIconSVG = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708l-10 10a.5.5 0 0 1-.168.11l-5 2a.5.5 0 0 1-.65-.65l2-5a.5.5 0 0 1 .11-.168l10-10zM11.207 2.5 13.5 4.793 14.793 3.5 12.5 1.207 11.207 2.5zm1.586 3L10.5 3.207 4 9.707V10h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.293l6.5-6.5zm-9.761 5.175-.106.106-1.528 3.821 3.821-1.528.106-.106A.5.5 0 0 1 5 12.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.468-.325z"/></svg>`;
  const dragHandleIconSVG = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M7 2a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm3 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0zM7 5a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm3 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0zM7 8a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm3 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm-3 3a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm3 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm-3 3a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm3 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0z"/></svg>`;
  const chevronDownIconSVG = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z"/></svg>`;
  const chevronRightIconSVG = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4.646 1.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1 0 .708l-6 6a.5.5 0 0 1-.708-.708L10.293 8 4.646 2.354a.5.5 0 0 1 0-.708z"/></svg>`;


  let backupDirHandle = null;
  let themesDirHandle = null;

  const state = {
    subjects: [],
    studyRecords: [],
    revisions: [],
    studyAlarms: [],
    customThemes: [],
    studyCycles: [],
    timer: {
      interval: null,
      timeLeft: 0,
      initialTime: 0,
      isRunning: false,
      isPaused: false,
      mode: 'study', // 'study' or 'rest'
      activeCycle: null // Holds the state of a running cycle
    }
  };
  
  let calendar = null;

  // --- Seletores de Elementos DOM ---
  const tabButtons = document.querySelectorAll('nav button[role="tab"]');
  const tabPanels = document.querySelectorAll('main section[role="tabpanel"]');
  const subjectsContainer = document.getElementById('subjects-container');
  const subjectNameInput = document.getElementById('subject-name');
  const subjectColorInput = document.getElementById('subject-color');
  const addSubjectBtn = document.getElementById('add-subject-btn');
  const studyAlarmList = document.getElementById('study-alarm-list');
  const revisionList = document.getElementById('revision-list');
  const selectsToUpdate = [
    document.getElementById('timer-subject'),
    document.getElementById('record-subject'),
    document.getElementById('revision-subject'),
    document.getElementById('graph-subjects'),
    document.getElementById('alarm-subject'),
  ];
  
  // --- LÓGICA DOS MODAIS ---
    const confirmationModal = document.getElementById('confirmation-modal');
    const confirmBtn = document.getElementById('confirm-btn');
    const cancelBtn = document.getElementById('cancel-btn');
    const confirmationText = document.getElementById('confirmation-text');
    let confirmCallback = null;

    function showConfirmationModal(message, onConfirm) {
        confirmationText.textContent = message;
        confirmCallback = onConfirm;
        confirmationModal.style.display = 'flex';
    }

    confirmBtn.addEventListener('click', () => {
        if (confirmCallback) {
            confirmCallback();
        }
        confirmationModal.style.display = 'none';
        confirmCallback = null;
    });

    cancelBtn.addEventListener('click', () => {
        confirmationModal.style.display = 'none';
        confirmCallback = null;
    });

    const infoModal = document.getElementById('info-modal');
    const infoTitle = document.getElementById('info-title');
    const infoText = document.getElementById('info-text');
    const infoOkBtn = document.getElementById('info-ok-btn');

    function showInfoModal(title, message) {
        infoTitle.textContent = title;
        infoText.textContent = message;
        infoModal.style.display = 'flex';
    }

    infoOkBtn.addEventListener('click', () => {
        infoModal.style.display = 'none';
    });
  
  // --- LÓGICA DE NAVEGAÇÃO POR ABAS ---
  tabButtons.forEach(btn => {
    btn.addEventListener('click', (e) => {
      const targetId = e.currentTarget.getAttribute('aria-controls');
      tabButtons.forEach(b => b.setAttribute('aria-selected', b.id === e.currentTarget.id));
      tabPanels.forEach(panel => panel.classList.toggle('active', panel.id === targetId));
      
      if (targetId === 'tab-progress') setTimeout(updateChart, 50);
      if (targetId === 'tab-schedule') {
        setTimeout(() => {
            if (!calendar) {
                initCalendar();
            } else {
                calendar.render(); // Re-render in case the container was hidden
            }
            updateUnifiedCalendarFilter();
            updateCalendarEvents();
        }, 50);
      }
    });
  });

  // --- LÓGICA DO CALENDÁRIO ---
  // CORREÇÃO: Função auxiliar para formatar datas e detectar "virada de noite"
  function getEventDateTimes(date, startTime, endTime) {
    const startDateTime = date + 'T' + startTime;
    const [startH, startM] = startTime.split(':').map(Number);
    const [endH, endM] = endTime.split(':').map(Number);

    let endDateObj = new Date(date + 'T' + endTime);
    // Se a hora final for menor que a inicial, é no dia seguinte
    if (endH < startH || (endH === startH && endM <= startM)) {
      endDateObj.setDate(endDateObj.getDate() + 1);
    }
    
    // Converte a data final para o formato ISO, que o FullCalendar entende
    const endDateTime = endDateObj.toISOString().slice(0, 16);
    return { start: startDateTime, end: endDateTime };
  }

  function initCalendar() {
    const calendarEl = document.getElementById('calendar');
    calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'timeGridWeek', // Melhor visualização padrão para horários
        locale: 'pt-br',
        // CORREÇÃO: Garante que o calendário exiba o dia inteiro
        slotMinTime: "00:00:00",
        slotMaxTime: "24:00:00",
        nowIndicator: true,
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: '' // Botões de visualização agora são externos
        },
        height: 'auto',
        events: [],
        displayEventEnd: true,
        eventTimeFormat: {
            hour: '2-digit',
            minute: '2-digit',
            meridiem: false
        },
        eventClick: function(info) {
            const startStr = info.event.start.toLocaleString('pt-BR', { dateStyle: 'short', timeStyle: 'short' });
            const endStr = info.event.end ? info.event.end.toLocaleString('pt-BR', { dateStyle: 'short', timeStyle: 'short' }) : 'N/A';
            const eventDetails = `Início: ${startStr}\nFim: ${endStr}\nTipo: ${info.event.extendedProps.type === 'study' ? 'Estudo Agendado' : 'Revisão'}\nDescrição: ${info.event.extendedProps.description || 'N/A'}`;
            showInfoModal(`Atividade: ${info.event.title}`, eventDetails);
        }
    });
    calendar.render();
    
    document.querySelectorAll('.view-btn').forEach(button => {
        button.addEventListener('click', (e) => {
            const view = e.currentTarget.dataset.view;
            if (calendar) calendar.changeView(view);
        });
    });

    document.getElementById('calendar-main-filter').addEventListener('change', updateCalendarEvents);
  }

  function updateUnifiedCalendarFilter() {
    const filterSelect = document.getElementById('calendar-main-filter');
    const currentValue = filterSelect.value;
    filterSelect.innerHTML = `
        <option value="all">Todos</option>
        <option value="type:study">Estudos</option>
        <option value="type:revision">Revisões</option>
    `;

    const subjectOptGroup = document.createElement('optgroup');
    subjectOptGroup.label = 'Disciplinas';
    state.subjects.forEach(subj => {
        const opt = document.createElement('option');
        opt.value = `subject:${subj.name}`;
        opt.textContent = subj.name;
        subjectOptGroup.appendChild(opt);
    });
    if (subjectOptGroup.children.length > 0) filterSelect.appendChild(subjectOptGroup);

    const topicOptGroup = document.createElement('optgroup');
    topicOptGroup.label = 'Assuntos';
    const allTopics = new Set();
    state.subjects.forEach(subj => {
        subj.topics.forEach(topic => allTopics.add(topic.name));
    });
    allTopics.forEach(topicName => {
        const opt = document.createElement('option');
        opt.value = `topic:${topicName}`;
        opt.textContent = topicName;
        topicOptGroup.appendChild(opt);
    });
     if (topicOptGroup.children.length > 0) filterSelect.appendChild(topicOptGroup);
    
    filterSelect.value = currentValue;
  }

  function updateCalendarEvents() {
    if (!calendar) return;

    const filterValue = document.getElementById('calendar-main-filter').value;

    // CORREÇÃO: Usa diretamente as propriedades 'start' e 'end' salvas no estado
    const studyEvents = state.studyAlarms.map(alarm => ({
        id: `study_${alarm.id}`,
        title: `Estudo: ${alarm.subject}${alarm.topic ? ' - ' + alarm.topic : ''}`,
        start: alarm.start,
        end: alarm.end,
        backgroundColor: state.subjects.find(s => s.name === alarm.subject)?.color || '#3788d8',
        borderColor: state.subjects.find(s => s.name === alarm.subject)?.color || '#3788d8',
        extendedProps: { type: 'study', subject: alarm.subject, topic: alarm.topic, description: `Estudo agendado para ${alarm.subject}` }
    }));

    const revisionEvents = state.revisions.map(rev => ({
        id: `revision_${rev.id}`,
        title: `Revisão: ${rev.subject}${rev.topic ? ' - ' + rev.topic : ''}`,
        start: rev.start,
        end: rev.end,
        backgroundColor: state.subjects.find(s => s.name === rev.subject)?.color || '#17a2b8',
        borderColor: state.subjects.find(s => s.name === rev.subject)?.color || '#17a2b8',
        extendedProps: { type: 'revision', subject: rev.subject, topic: rev.topic, description: rev.notes || 'Revisar matéria.' }
    }));
    
    let allEvents = [...studyEvents, ...revisionEvents];

    if (filterValue !== 'all') {
        const [category, value] = filterValue.split(':');
        allEvents = allEvents.filter(e => {
            if (category === 'type') return e.extendedProps.type === value;
            if (category === 'subject') return e.extendedProps.subject === value;
            if (category === 'topic') return e.extendedProps.topic === value;
            return false;
        });
    }
    
    calendar.getEventSources().forEach(source => source.remove());
    calendar.addEventSource(allEvents);
  }


  // --- LÓGICA DE DISCIPLINAS E ASSUNTOS ---
  function updateSubjectsUI() {
    subjectsContainer.innerHTML = state.subjects.length === 0 ? '<p>Nenhuma disciplina adicionada ainda.</p>' : '';
    state.subjects.forEach((subj, subjIndex) => {
      const subjectDiv = document.createElement('div');
      subjectDiv.className = 'subject-item';
      subjectDiv.style.borderLeft = `6px solid ${subj.color}`;

      const header = document.createElement('div');
      header.className = 'subject-header';
      header.innerHTML = `
        <div class="subject-header-title">
          <button class="icon-btn toggle-subject-btn" data-index="${subjIndex}" title="${subj.isMinimized ? 'Expandir' : 'Minimizar'}">${subj.isMinimized ? chevronRightIconSVG : chevronDownIconSVG}</button>
          <span class="drag-handle" title="Arraste para reordenar">${dragHandleIconSVG}</span>
          <span class="color-box" style="background-color: ${subj.color};"></span>
          <span class="subject-title">${subj.name}</span>
          <button class="icon-btn edit-btn edit-subject-btn" data-index="${subjIndex}" title="Editar disciplina">${editIconSVG}</button>
        </div>
        <div class="actions">
            <button class="icon-btn delete-btn delete-subject-btn" data-index="${subjIndex}" title="Excluir disciplina">${trashIconSVG}</button>
        </div>
      `;
      subjectDiv.appendChild(header);
      
      const contentWrapper = document.createElement('div');
      contentWrapper.className = 'subject-content-wrapper';
      if (subj.isMinimized) {
        contentWrapper.style.display = 'none';
      }

      const topicList = document.createElement('ul');
      topicList.className = 'topic-list';
      if (subj.topics && subj.topics.length > 0) {
          subj.topics.forEach((topic, topicIndex) => {
              const topicItem = document.createElement('li');
              topicItem.className = 'topic-item';
              topicItem.innerHTML = `
                  <div class="topic-header">
                      <span class="color-box" style="background-color: ${topic.color}; width: 14px; height: 14px; margin-right: 8px;"></span>
                      <span>${topic.name}</span>
                      <button class="icon-btn edit-btn edit-topic-btn" data-subj-index="${subjIndex}" data-topic-index="${topicIndex}" title="Editar assunto">${editIconSVG}</button>
                  </div>
                  <p class="topic-description">${topic.description || 'Sem descrição.'}</p>
                  <div class="actions">
                    <button class="icon-btn delete-btn delete-topic-btn" data-subj-index="${subjIndex}" data-topic-index="${topicIndex}" title="Excluir assunto">${trashIconSVG}</button>
                  </div>
              `;
              topicList.appendChild(topicItem);
          });
      } else {
          const li = document.createElement('li');
          li.textContent = 'Nenhum assunto adicionado.';
          li.style.padding = '0.75rem';
          li.style.alignItems = 'flex-start';
          topicList.appendChild(li);
      }
      contentWrapper.appendChild(topicList);

      const addTopicForm = document.createElement('div');
      addTopicForm.className = 'compact-add-form';
      addTopicForm.innerHTML = `
          <h3>Adicionar Novo Assunto</h3>
          <label>Nome do Assunto:</label>
          <div class="input-group">
            <input type="text" class="topic-name-input" placeholder="Ex: Funções de 1º Grau">
            <input type="color" class="color-picker-icon topic-color-input" value="#3498db" title="Escolha uma cor para o assunto">
          </div>
          <label>Descrição:</label>
          <textarea class="topic-desc-input" placeholder="Detalhes sobre o que estudar, fórmulas, etc."></textarea>
          <button class="add-topic-btn" data-index="${subjIndex}">Adicionar Assunto</button>
      `;
      contentWrapper.appendChild(addTopicForm);
      subjectDiv.appendChild(contentWrapper);
      subjectsContainer.appendChild(subjectDiv);
    });
    
    addSubjectActionListeners();
    updateAllSelects();
  }
  
  function addSubjectActionListeners() {
      document.querySelectorAll('.toggle-subject-btn').forEach(btn => {
        btn.onclick = e => {
            const index = e.currentTarget.dataset.index;
            state.subjects[index].isMinimized = !state.subjects[index].isMinimized;
            saveState();
            updateSubjectsUI();
        };
      });

      document.querySelectorAll('.delete-subject-btn').forEach(btn => {
          btn.onclick = e => {
              const index = e.currentTarget.dataset.index;
              showConfirmationModal(`Confirma excluir a disciplina "${state.subjects[index].name}" e todos os seus registros?`, () => {
                  state.subjects.splice(index, 1);
                  saveState();
                  renderAll();
              });
          };
      });

      document.querySelectorAll('.edit-subject-btn').forEach(btn => {
        btn.onclick = e => {
            const subjIndex = e.currentTarget.dataset.index;
            const subject = state.subjects[subjIndex];
            const subjectDiv = e.currentTarget.closest('.subject-item');
            
            subjectDiv.innerHTML = `
                <div class="edit-form">
                    <h3>Editando Disciplina</h3>
                    <label for="edit-subject-name-${subjIndex}">Nome da Disciplina:</label>
                    <input id="edit-subject-name-${subjIndex}" type="text" value="${subject.name}" class="edit-subject-name-input">
                    <label for="edit-subject-color-${subjIndex}">Cor:</label>
                    <input id="edit-subject-color-${subjIndex}" type="color" value="${subject.color}" class="edit-subject-color-input">
                    <button class="save-subject-edit-btn" data-index="${subjIndex}">Salvar</button>
                    <button type="button" class="cancel-btn cancel-edit-btn">Cancelar</button>
                </div>
            `;
            
            subjectDiv.querySelector('.save-subject-edit-btn').onclick = () => {
                const oldName = subject.name;
                const newName = subjectDiv.querySelector('.edit-subject-name-input').value.trim();
                const newColor = subjectDiv.querySelector('.edit-subject-color-input').value;
                if (!newName) {
                    showInfoModal('Erro de Validação', 'O nome da disciplina não pode ser vazio.');
                    return;
                }
                
                if (state.subjects.some((s, i) => s.name.toLowerCase() === newName.toLowerCase() && i != subjIndex)) {
                    showInfoModal('Erro', 'Já existe uma disciplina com esse nome.');
                    return;
                }
                
                const updateRecords = () => {
                    state.subjects[subjIndex].name = newName;
                    state.subjects[subjIndex].color = newColor;
                    saveState();
                    renderAll();
                };

                if (newName !== oldName) {
                    showConfirmationModal('Atenção: Alterar o nome da disciplina não atualizará os registros de estudo e revisões já existentes que usam o nome antigo. Deseja continuar?', updateRecords);
                } else {
                    updateRecords();
                }
            };
            
            subjectDiv.querySelector('.cancel-edit-btn').onclick = () => renderAll();
        };
      });

      document.querySelectorAll('.add-topic-btn').forEach(btn => {
          btn.onclick = e => {
              const subjIndex = e.currentTarget.dataset.index;
              const form = e.currentTarget.closest('.compact-add-form');
              const name = form.querySelector('.topic-name-input').value.trim();
              if (!name) {
                  showInfoModal('Erro de Validação', 'Por favor, insira o nome do assunto.');
                  return;
              }
              state.subjects[subjIndex].topics.push({ 
                  name, 
                  color: form.querySelector('.topic-color-input').value, 
                  description: form.querySelector('.topic-desc-input').value.trim() 
              });
              saveState();
              renderAll();
          };
      });

      document.querySelectorAll('.delete-topic-btn').forEach(btn => {
          btn.onclick = e => {
              const { subjIndex, topicIndex } = e.currentTarget.dataset;
              showConfirmationModal('Deseja excluir este assunto?', () => {
                  state.subjects[subjIndex].topics.splice(topicIndex, 1);
                  saveState();
                  renderAll();
              });
          };
      });

      document.querySelectorAll('.edit-topic-btn').forEach(btn => {
        btn.onclick = e => {
            const { subjIndex, topicIndex } = e.currentTarget.dataset;
            const topic = state.subjects[subjIndex].topics[topicIndex];
            const topicItem = e.currentTarget.closest('.topic-item');

            topicItem.classList.add('edit-form');
            topicItem.innerHTML = `
                <h4>Editando Assunto</h4>
                <label>Nome:</label>
                <input type="text" value="${topic.name}" class="edit-topic-name-input">
                <label>Cor:</label>
                <input type="color" value="${topic.color}" class="edit-topic-color-input">
                <label>Descrição:</label>
                <textarea class="edit-topic-desc-input">${topic.description || ''}</textarea>
                <button class="save-topic-edit-btn" data-subj-index="${subjIndex}" data-topic-index="${topicIndex}">Salvar</button>
                <button type="button" class="cancel-btn cancel-edit-btn">Cancelar</button>
            `;

            topicItem.querySelector('.save-topic-edit-btn').onclick = () => {
                const newName = topicItem.querySelector('.edit-topic-name-input').value.trim();
                if (!newName) {
                    showInfoModal('Erro de Validação', 'O nome do assunto não pode ser vazio.');
                    return;
                }
                
                const newColor = topicItem.querySelector('.edit-topic-color-input').value;
                const newDesc = topicItem.querySelector('.edit-topic-desc-input').value.trim();
                
                state.subjects[subjIndex].topics[topicIndex] = { name: newName, color: newColor, description: newDesc };
                saveState();
                renderAll();
            };

            topicItem.querySelector('.cancel-edit-btn').onclick = () => renderAll();
        };
      });
  }

  function updateAllSelects() {
    selectsToUpdate.forEach(sel => {
      const selectedVal = sel.value;
      sel.innerHTML = '';
      if(sel.id !== 'graph-subjects') {
          sel.innerHTML = '<option value="">-- Escolha uma disciplina --</option>';
      }
      state.subjects.forEach(subj => {
        const opt = document.createElement('option');
        opt.value = subj.name;
        opt.textContent = subj.name;
        sel.appendChild(opt);
      });
      sel.value = selectedVal;
    });
  }

  addSubjectBtn.addEventListener('click', () => {
    const newSubj = subjectNameInput.value.trim();
    if(!newSubj) {
        showInfoModal('Erro de Validação', 'Por favor, insira o nome da disciplina.');
        return;
    }
    if(state.subjects.find(s => s.name.toLowerCase() === newSubj.toLowerCase())) {
        showInfoModal('Erro', 'Essa disciplina já existe.');
        return;
    }
    state.subjects.push({
        name: newSubj, 
        color: subjectColorInput.value, 
        topics: [],
        isMinimized: false
    });
    subjectNameInput.value = '';
    saveState();
    renderAll();
  });

  // --- LÓGICA DO CRONÔMETRO ---
  const timerDisplay = document.getElementById('timer-display');
  const timerSubjectSelect = document.getElementById('timer-subject');
  const timerTopicSelect = document.getElementById('timer-topic');
  const timerMinutesInput = document.getElementById('timer-minutes');
  const startBtn = document.getElementById('start-timer-btn');
  const pauseBtn = document.getElementById('pause-timer-btn');
  const resetBtn = document.getElementById('reset-timer-btn');
  const timerModeRadios = document.querySelectorAll('input[name="timerMode"]');
  const timerSubjectGroup = document.getElementById('timer-subject-group');
  
  timerModeRadios.forEach(radio => {
    radio.addEventListener('change', (e) => {
        state.timer.mode = e.target.value;
        timerSubjectGroup.style.display = state.timer.mode === 'study' ? 'block' : 'none';
        if (state.timer.mode === 'rest') {
            timerMinutesInput.value = 10;
        } else {
            timerMinutesInput.value = 25;
        }
    });
  });

  function updateTimerDisplay() {
    const minutes = Math.floor(state.timer.timeLeft / 60);
    const seconds = state.timer.timeLeft % 60;
    timerDisplay.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
    
    let titleText = "Gerenciador de Estudos 22";
    let messageText = "";

    if (state.timer.isRunning || state.timer.isPaused) {
        if (state.timer.activeCycle) {
            const cycle = state.timer.activeCycle;
            const currentSubject = cycle.subjects[cycle.currentStep -1];
            const modeText = cycle.isStudy ? `Estudando: ${currentSubject}` : 'Descansando...';
            messageText = `Ciclo ${cycle.currentStep}/${cycle.totalSteps} - ${modeText}`;
            titleText = `${timerDisplay.textContent} - ${messageText}`;
        } else {
            const modeText = state.timer.mode === 'study' ? 'Estudando...' : 'Descansando...';
            messageText = modeText;
            titleText = `${timerDisplay.textContent} - ${messageText}`;
        }
    }
    document.title = titleText;
    const timerMessageEl = document.getElementById('timer-message');
    timerMessageEl.textContent = messageText;
    timerMessageEl.style.display = (state.timer.isRunning || state.timer.isPaused) && (messageText) ? 'block' : 'none';
  }

  function tick() {
    state.timer.timeLeft--;
    updateTimerDisplay();
    if (state.timer.timeLeft <= 0) {
      clearInterval(state.timer.interval);
      state.timer.isRunning = false;

      if (state.timer.activeCycle) {
          handleCycleTransition();
          return;
      }
      
      if (state.timer.mode === 'study') {
          const subject = timerSubjectSelect.value;
          const topic = timerTopicSelect.value;
          const duration = state.timer.initialTime / 60;
          if (subject && duration > 0) {
              addStudyRecord(subject, topic, 'Cronômetro', duration, 'Estudo focado', 0);
              showInfoModal('Estudo Registrado', `Estudo de ${duration} minutos de ${subject} registrado! Que tal uma pausa?`);
              document.querySelector('input[name="timerMode"][value="rest"]').checked = true;
              document.querySelector('input[name="timerMode"][value="rest"]').dispatchEvent(new Event('change'));
              timerMinutesInput.value = 10;
          }
      } else { 
          showInfoModal('Fim da Pausa', 'Pausa finalizada! Hora de voltar a estudar.');
          document.querySelector('input[name="timerMode"][value="study"]').checked = true;
          document.querySelector('input[name="timerMode"][value="study"]').dispatchEvent(new Event('change'));
          timerMinutesInput.value = 25;
      }
      resetTimer(true);
    }
  }

  function startTimer() {
    if (state.timer.mode === 'study' && !timerSubjectSelect.value && !state.timer.activeCycle) {
        showInfoModal('Ação Necessária', 'Por favor, selecione uma disciplina.');
        return;
    }
    if (state.timer.isRunning) return;
    const minutes = parseInt(timerMinutesInput.value, 10);
    if (isNaN(minutes) || minutes <= 0) {
        showInfoModal('Erro de Validação', 'Por favor, insira um tempo válido.');
        return;
    }
    
    state.timer.isRunning = true;
    if (!state.timer.isPaused) {
        state.timer.timeLeft = minutes * 60;
        state.timer.initialTime = minutes * 60;
    }
    state.timer.isPaused = false;
    state.timer.interval = setInterval(tick, 1000);
    updateTimerDisplay();
    updateTimerControls();
  }

  function pauseTimer() {
    if (!state.timer.isRunning) return;
    clearInterval(state.timer.interval);
    state.timer.isRunning = false;
    state.timer.isPaused = true;
    updateTimerControls();
  }

  function resetTimer(forceReset = false) {
    clearInterval(state.timer.interval);
    
    if (state.timer.activeCycle && !forceReset) {
        Object.assign(state.timer, { ...state.timer, isRunning: false, isPaused: false });
    } else { 
        Object.assign(state.timer, { ...state.timer, isRunning: false, isPaused: false, timeLeft: 0, initialTime: 0, activeCycle: null });
        updateStudyCyclesUI(); 
    }
    updateTimerDisplay();
    updateTimerControls();
  }

  function updateTimerControls() {
    const isCycleActive = !!state.timer.activeCycle;
    
    startBtn.style.display = 'inline-block';
    pauseBtn.style.display = 'inline-block';
    
    startBtn.disabled = state.timer.isRunning || isCycleActive;
    pauseBtn.disabled = !state.timer.isRunning || state.timer.isPaused || isCycleActive;
    resetBtn.disabled = (!state.timer.isRunning && !state.timer.isPaused && state.timer.timeLeft === 0) && !isCycleActive;
    
    timerSubjectSelect.disabled = state.timer.isRunning || state.timer.isPaused || isCycleActive;
    timerTopicSelect.disabled = state.timer.isRunning || state.timer.isPaused || isCycleActive || !timerSubjectSelect.value;
    timerMinutesInput.disabled = state.timer.isRunning || state.timer.isPaused || isCycleActive;
    timerModeRadios.forEach(radio => radio.disabled = state.timer.isRunning || state.timer.isPaused || isCycleActive);
    
    document.getElementById('create-cycle-btn').disabled = state.timer.isRunning || state.timer.isPaused || isCycleActive;
    document.querySelectorAll('.start-cycle-btn, .edit-cycle-btn, .delete-cycle-btn').forEach(btn => {
        btn.disabled = state.timer.isRunning || state.timer.isPaused || isCycleActive;
    });

    if (isCycleActive) {
        resetBtn.textContent = 'Parar Ciclo';
        resetBtn.disabled = false;
        startBtn.disabled = true;
        pauseBtn.disabled = true;
    } else {
        resetBtn.textContent = 'Resetar';
    }
  }
  
  startBtn.onclick = startTimer;
  pauseBtn.onclick = pauseTimer;
  resetBtn.onclick = () => {
    if (state.timer.activeCycle) {
        showConfirmationModal('Tem certeza que deseja parar o ciclo atual?', () => {
            resetTimer(true);
        });
    } else {
        resetTimer(true);
    }
  };

  // --- LÓGICA DE CICLOS DE ESTUDO ---
  const createCycleBtn = document.getElementById('create-cycle-btn');
  const cycleCreatorModal = document.getElementById('cycle-creator-modal');
  const cycleCreatorForm = document.getElementById('cycle-creator-form');
  const saveCycleBtn = document.getElementById('save-cycle-btn');
  const cancelCycleBtn = document.getElementById('cancel-cycle-edit-btn');
  const cycleCountInput = document.getElementById('cycle-count-input');
  const cycleSubjectsContainer = document.getElementById('cycle-subjects-container');
  const studyCyclesContainer = document.getElementById('study-cycles-container');

  function updateStudyCyclesUI() {
    studyCyclesContainer.innerHTML = '';
    if (!state.studyCycles || state.studyCycles.length === 0) {
        studyCyclesContainer.innerHTML = '<p style="text-align:center; color: var(--text-secondary);">Nenhum ciclo criado. Crie um para começar!</p>';
        return;
    }

    state.studyCycles.forEach(cycle => {
        const cycleEl = document.createElement('div');
        cycleEl.className = 'cycle-item';
        cycleEl.innerHTML = `
            <span class="drag-handle" title="Arraste para reordenar">${dragHandleIconSVG}</span>
            <div class="cycle-item-info">
                <strong>${cycle.name}</strong>
                <span>${cycle.subjects.length}x (${cycle.studyTime} min estudo / ${cycle.restTime} min descanso)</span>
            </div>
            <div class="cycle-item-actions">
                <button class="start-cycle-btn" data-id="${cycle.id}">Iniciar</button>
                <button class="icon-btn edit-btn edit-cycle-btn" data-id="${cycle.id}" title="Editar Ciclo">${editIconSVG}</button>
                <button class="icon-btn delete-btn delete-cycle-btn" data-id="${cycle.id}" title="Excluir Ciclo">${trashIconSVG}</button>
            </div>
        `;
        studyCyclesContainer.appendChild(cycleEl);
    });

    document.querySelectorAll('.start-cycle-btn').forEach(btn => {
        btn.onclick = (e) => startCycle(e.currentTarget.dataset.id);
    });
    document.querySelectorAll('.edit-cycle-btn').forEach(btn => {
        btn.onclick = (e) => {
            const cycle = state.studyCycles.find(c => c.id === e.currentTarget.dataset.id);
            openCycleCreator(cycle);
        };
    });
    document.querySelectorAll('.delete-cycle-btn').forEach(btn => {
        btn.onclick = (e) => {
            const cycleId = e.currentTarget.dataset.id;
            showConfirmationModal('Tem certeza que deseja excluir este ciclo?', () => {
                state.studyCycles = state.studyCycles.filter(c => c.id !== cycleId);
                saveState();
                updateStudyCyclesUI();
            });
        };
    });
    updateTimerControls();
  }


  function updateCycleSubjectSelectors() {
    const count = parseInt(cycleCountInput.value, 10) || 0;
    const existingSelectors = Array.from(cycleSubjectsContainer.querySelectorAll('select'));
    const values = existingSelectors.map(s => s.value);

    cycleSubjectsContainer.innerHTML = '';
    if (count > 0 && state.subjects.length === 0) {
        cycleSubjectsContainer.innerHTML = '<p>Adicione disciplinas na primeira aba para poder selecioná-las aqui.</p>';
        return;
    }

    for (let i = 0; i < count; i++) {
        const entryDiv = document.createElement('div');
        entryDiv.className = 'cycle-subject-entry';

        const label = document.createElement('label');
        label.textContent = `Disciplina ${i + 1}:`;
        label.htmlFor = `cycle-subject-${i}`;

        const select = document.createElement('select');
        select.id = `cycle-subject-${i}`;
        select.required = true;
        select.innerHTML = '<option value="">-- Selecione --</option>';
        state.subjects.forEach(subj => {
            select.innerHTML += `<option value="${subj.name}">${subj.name}</option>`;
        });
        select.value = values[i] || '';

        entryDiv.appendChild(label);
        entryDiv.appendChild(select);
        cycleSubjectsContainer.appendChild(entryDiv);
    }
  }

  function openCycleCreator(cycle = null) {
    cycleCreatorForm.reset();
    document.getElementById('cycle-editor-id').value = '';
    
    if (cycle) {
        document.getElementById('cycle-creator-title').textContent = 'Editar Ciclo de Estudo';
        document.getElementById('cycle-editor-id').value = cycle.id;
        document.getElementById('cycle-name-input').value = cycle.name;
        document.getElementById('cycle-study-time-input').value = cycle.studyTime;
        document.getElementById('cycle-rest-time-input').value = cycle.restTime;
        document.getElementById('cycle-count-input').value = cycle.subjects.length;
        updateCycleSubjectSelectors();
        const selectors = cycleSubjectsContainer.querySelectorAll('select');
        cycle.subjects.forEach((subjName, index) => {
            if (selectors[index]) {
                selectors[index].value = subjName;
            }
        });
    } else {
        document.getElementById('cycle-creator-title').textContent = 'Criar Novo Ciclo de Estudo';
        updateCycleSubjectSelectors();
    }
    cycleCreatorModal.style.display = 'flex';
  }

  function saveCycle() {
    const id = document.getElementById('cycle-editor-id').value;
    const name = document.getElementById('cycle-name-input').value.trim();
    const studyTime = parseInt(document.getElementById('cycle-study-time-input').value, 10);
    const restTime = parseInt(document.getElementById('cycle-rest-time-input').value, 10);
    const count = parseInt(cycleCountInput.value, 10);

    if (!name || !studyTime || !restTime || !count) {
        showInfoModal('Erro de Validação', 'Por favor, preencha todos os campos do ciclo.');
        return;
    }

    const subjectSelectors = cycleSubjectsContainer.querySelectorAll('select');
    const subjects = Array.from(subjectSelectors).map(s => s.value);
    if (subjects.some(s => !s)) {
        showInfoModal('Erro de Validação', 'Por favor, selecione uma disciplina para cada etapa do ciclo.');
        return;
    }

    const cycleData = {
        id: id || `cycle_${Date.now()}`,
        name,
        studyTime,
        restTime,
        subjects
    };

    if (id) {
        const index = state.studyCycles.findIndex(c => c.id === id);
        state.studyCycles[index] = cycleData;
    } else {
        state.studyCycles.push(cycleData);
    }

    saveState();
    updateStudyCyclesUI();
    cycleCreatorModal.style.display = 'none';
  }

  function startCycle(cycleId) {
    const cycle = state.studyCycles.find(c => c.id === cycleId);
    if (!cycle) return;

    if (state.subjects.length === 0) {
        showInfoModal('Ação Necessária', 'Não há disciplinas cadastradas para iniciar o ciclo.');
        return;
    }
    if (!cycle.subjects.every(subjName => state.subjects.some(s => s.name === subjName))) {
        showInfoModal('Erro', 'Uma ou mais disciplinas deste ciclo foram excluídas. Edite o ciclo para continuar.');
        return;
    }

    state.timer.activeCycle = {
        id: cycle.id,
        name: cycle.name,
        studyTime: cycle.studyTime,
        restTime: cycle.restTime,
        subjects: cycle.subjects,
        totalSteps: cycle.subjects.length,
        currentStep: 1,
        isStudy: true,
    };

    const firstSubject = state.timer.activeCycle.subjects[0];
    timerSubjectSelect.value = firstSubject;
    timerTopicSelect.innerHTML = '<option value="">-- Geral da disciplina --</option>';
    populateTopicSelect(timerSubjectSelect, timerTopicSelect);

    timerMinutesInput.value = state.timer.activeCycle.studyTime;
    document.querySelector('input[name="timerMode"][value="study"]').checked = true;
    timerSubjectGroup.style.display = 'block';

    startTimer();
    updateStudyCyclesUI();
  }


  function handleCycleTransition() {
    const cycle = state.timer.activeCycle;
    if (!cycle) return;

    if (cycle.isStudy) {
        const subject = cycle.subjects[cycle.currentStep - 1];
        const topic = '';
        addStudyRecord(subject, topic, 'Ciclo', cycle.studyTime, `Ciclo: ${cycle.name}`, cycle.restTime);
    }

    if (cycle.isStudy) {
        cycle.isStudy = false;
        timerMinutesInput.value = cycle.restTime;
        document.querySelector('input[name="timerMode"][value="rest"]').checked = true;
        timerSubjectGroup.style.display = 'none';
        startTimer();
    } else {
        if (cycle.currentStep < cycle.totalSteps) {
            cycle.currentStep++;
            cycle.isStudy = true;
            
            const nextSubject = cycle.subjects[cycle.currentStep - 1];
            timerSubjectSelect.value = nextSubject;
            populateTopicSelect(timerSubjectSelect, timerTopicSelect);
            
            timerMinutesInput.value = cycle.studyTime;
            document.querySelector('input[name="timerMode"][value="study"]').checked = true;
            timerSubjectGroup.style.display = 'block';
            startTimer();
        } else {
            showInfoModal('Ciclo Concluído', `Ciclo "${cycle.name}" concluído com sucesso!`);
            resetTimer(true);
        }
    }
    saveState();
  }

  // --- LÓGICA DE REGISTRO DE ESTUDO ---
  function addStudyRecord(subject, topic, method, duration, summary, restDuration) {
      state.studyRecords.push({ date: new Date().toLocaleDateString('pt-BR'), subject, topic, method, duration, summary, restDuration });
      saveState();
      renderAll();
  }

  document.getElementById('record-study-btn').onclick = () => {
    const subject = document.getElementById('record-subject').value;
    const topic = document.getElementById('record-topic').value;
    if (!subject) {
        showInfoModal('Erro de Validação', 'Por favor, selecione uma disciplina.');
        return;
    }
    const duration = Number(document.getElementById('study-duration').value);
    if (isNaN(duration) || duration <= 0) {
        showInfoModal('Erro de Validação', 'Informe uma duração de estudo válida.');
        return;
    }
    const restDuration = Number(document.getElementById('rest-duration').value) || 0;

    addStudyRecord(subject, topic, document.getElementById('study-method').value, duration, document.getElementById('pages-studied').value.trim() || document.getElementById('notes').value.trim() || 'Nenhum resumo', restDuration);
    
    document.getElementById('record-subject').value = '';
    document.getElementById('record-topic').value = '';
    document.getElementById('record-topic').disabled = true;
    document.getElementById('study-duration').value = 25;
    document.getElementById('rest-duration').value = '';
    document.getElementById('pages-studied').value = '';
    document.getElementById('notes').value = '';
    showInfoModal('Sucesso', 'Estudo registrado com sucesso!');
  };
  
  function updateProgressTable() {
    const tbody = document.querySelector('#progress-table tbody');
    tbody.innerHTML = '';
    [...state.studyRecords].reverse().forEach((rec, index) => {
      const realIndex = state.studyRecords.length - 1 - index;
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${rec.date}</td>
        <td>${rec.subject}</td>
        <td>${rec.topic || 'Geral'}</td>
        <td>${rec.method}</td>
        <td>${rec.duration}</td>
        <td>${rec.summary}</td>
        <td>${rec.restDuration || 0}</td>
        <td style="text-align: center;"><button class="icon-btn delete-btn delete-record-btn" data-index="${realIndex}" title="Excluir registro">${trashIconSVG}</button></td>
      `;
      tbody.appendChild(tr);
    });
    
    document.querySelectorAll('.delete-record-btn').forEach(button => {
        button.onclick = (e) => {
            const indexToDelete = parseInt(e.currentTarget.dataset.index, 10);
            showConfirmationModal('Confirma excluir este registro de estudo?', () => {
                state.studyRecords.splice(indexToDelete, 1);
                saveState();
                renderAll();
            });
        };
    });
  }

  // --- LÓGICA DE GRÁFICOS E FILTROS ---
  let chartInstance = null;
  const graphSubjectsSelect = document.getElementById('graph-subjects');
  const graphTopicsSelect = document.getElementById('graph-topics');

  graphSubjectsSelect.addEventListener('change', () => {
    graphTopicsSelect.innerHTML = '';
    const selectedSubjectNames = Array.from(graphSubjectsSelect.selectedOptions).map(o => o.value);
    
    const topics = new Set();
    state.subjects
        .filter(s => selectedSubjectNames.includes(s.name))
        .forEach(s => {
            s.topics.forEach(t => topics.add(t.name));
        });
    
    topics.forEach(topicName => {
        const opt = document.createElement('option');
        opt.value = topicName;
        opt.textContent = topicName;
        graphTopicsSelect.appendChild(opt);
    });
  });

  function updateChart() {
    const ctx = document.getElementById('study-chart').getContext('2d');
    const diasFiltro = Number(document.getElementById('graph-timeframe').value);
    const dataInicial = new Date();
    dataInicial.setDate(dataInicial.getDate() - diasFiltro + 1);
    dataInicial.setHours(0,0,0,0);

    const selectedSubjects = Array.from(graphSubjectsSelect.selectedOptions).map(o => o.value);
    const selectedTopics = Array.from(graphTopicsSelect.selectedOptions).map(o => o.value);
    
    if (chartInstance) chartInstance.destroy();
    if (selectedSubjects.length === 0) return;

    let registrosFiltrados = state.studyRecords.filter(rec => {
      const [d, m, a] = rec.date.split('/');
      const recDate = new Date(`${a}-${m}-${d}`);
      return recDate >= dataInicial && selectedSubjects.includes(rec.subject);
    });

    let chartData;
    let chartLabels;
    let chartColors;

    if (selectedTopics.length > 0) {
        registrosFiltrados = registrosFiltrados.filter(rec => selectedTopics.includes(rec.topic));
        
        const duracaoPorTopico = registrosFiltrados.reduce((acc, rec) => {
            if (!rec.topic) return acc;
            acc[rec.topic] = (acc[rec.topic] || 0) + rec.duration;
            return acc;
        }, {});

        chartLabels = Object.keys(duracaoPorTopico);
        chartData = Object.values(duracaoPorTopico);
        chartColors = chartLabels.map(topicName => {
            for (const subject of state.subjects) {
                const topic = subject.topics.find(t => t.name === topicName);
                if (topic) return topic.color;
            }
            return '#cccccc';
        });

    } else {
        const duracaoPorDisciplina = registrosFiltrados.reduce((acc, rec) => {
            acc[rec.subject] = (acc[rec.subject] || 0) + rec.duration;
            return acc;
        }, {});

        chartLabels = Object.keys(duracaoPorDisciplina);
        chartData = Object.values(duracaoPorDisciplina);
        chartColors = chartLabels.map(l => state.subjects.find(s => s.name === l)?.color || '#ccc');
    }
    
    chartInstance = new Chart(ctx, {
      type: document.getElementById('graph-type').value,
      data: { 
          labels: chartLabels, 
          datasets: [{ 
              label: 'Tempo (min)', 
              data: chartData, 
              backgroundColor: chartColors 
          }] 
      },
      options: { responsive: true, maintainAspectRatio: false }
    });
  }
  document.getElementById('update-graph-btn').onclick = updateChart;

  // --- LÓGICA DE REVISÕES E OUTROS SELECTS ---
  const recordSubjectSelect = document.getElementById('record-subject');
  const recordTopicSelect = document.getElementById('record-topic');
  const revisionSubjectSelect = document.getElementById('revision-subject');
  const revisionTopicSelect = document.getElementById('revision-topic');
  const alarmSubjectSelect = document.getElementById('alarm-subject');
  const alarmTopicSelect = document.getElementById('alarm-topic');

  function populateTopicSelect(subjectSelect, topicSelect) {
    const selectedSubjectName = subjectSelect.value;
    topicSelect.innerHTML = topicSelect.id === 'alarm-topic' 
        ? '<option value="">-- Assunto (opcional) --</option>'
        : '<option value="">-- Geral da disciplina --</option>';
    
    const subject = state.subjects.find(s => s.name === selectedSubjectName);
    if(subject && subject.topics.length > 0) {
      subject.topics.forEach(topic => {
        const opt = document.createElement('option');
        opt.value = topic.name;
        opt.textContent = topic.name;
        topicSelect.appendChild(opt);
      });
      topicSelect.disabled = false;
    } else {
      topicSelect.disabled = true;
    }
  }

  recordSubjectSelect.addEventListener('change', () => populateTopicSelect(recordSubjectSelect, recordTopicSelect));
  timerSubjectSelect.addEventListener('change', () => populateTopicSelect(timerSubjectSelect, timerTopicSelect));
  revisionSubjectSelect.addEventListener('change', () => populateTopicSelect(revisionSubjectSelect, revisionTopicSelect));
  alarmSubjectSelect.addEventListener('change', () => populateTopicSelect(alarmSubjectSelect, alarmTopicSelect));

  function updateRevisionList() {
    revisionList.innerHTML = state.revisions.length === 0 ? '<li>Nenhuma revisão agendada.</li>' : '';
    state.revisions.forEach((rev) => {
      const li = document.createElement('li');
      if (rev.triggered) {
          li.style.textDecoration = 'line-through';
          li.style.opacity = '0.6';
      }
      
      // CORREÇÃO: Parse das datas de início e fim para exibição
      const startDate = new Date(rev.start);
      const endDate = new Date(rev.end);
      const today = new Date(); today.setHours(0,0,0,0);
      
      const startTimeStr = startDate.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
      const endTimeStr = endDate.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
      const endDateStr = startDate.toDateString() !== endDate.toDateString() ? ` (até ${endDate.toLocaleDateString('pt-BR')})` : '';

      let revisionText = `<strong>${startDate.toLocaleDateString('pt-BR')} das ${startTimeStr} às ${endTimeStr}${endDateStr} - ${rev.subject}`;
      if (rev.topic) revisionText += ` > ${rev.topic}`;
      revisionText += `</strong>: ${rev.notes || 'Sem notas.'}`;

      li.innerHTML = `
        <span class="drag-handle" title="Arraste para reordenar">${dragHandleIconSVG}</span>
        <div style="flex-grow: 1;">${revisionText}</div>
        <button class="icon-btn delete-btn delete-revision-btn" data-id="${rev.id}" title="Excluir revisão">${trashIconSVG}</button>`;
      if (startDate < today && !rev.triggered) li.style.borderColor = '#e74c3c';
      else if (startDate.toDateString() === today.toDateString() && !rev.triggered) li.style.borderColor = '#f39c12';
      revisionList.appendChild(li);
    });

    document.querySelectorAll('.delete-revision-btn').forEach(btn => {
        btn.onclick = e => {
            const idToDelete = parseInt(e.currentTarget.dataset.id, 10);
            showConfirmationModal('Deseja excluir esta revisão?', () => {
                state.revisions = state.revisions.filter(r => r.id !== idToDelete);
                saveState();
                renderAll();
            });
        };
    });
  }

  document.getElementById('add-revision-btn').onclick = () => {
    const subject = revisionSubjectSelect.value;
    const date = document.getElementById('revision-date').value;
    const time = document.getElementById('revision-time').value;
    const endTime = document.getElementById('revision-end-time').value;
    if (!subject || !date || !time || !endTime) {
        showInfoModal('Erro de Validação', 'Por favor, preencha a disciplina, data e horários de início e fim.');
        return;
    }
    
    // CORREÇÃO: Usa a nova função para calcular datas e horários
    const { start, end } = getEventDateTimes(date, time, endTime);
    const newRevisionStart = new Date(start);
    const newRevisionEnd = new Date(end);

    const conflict = [...state.studyAlarms, ...state.revisions].some(event => {
        const existingStart = new Date(event.start);
        const existingEnd = new Date(event.end);
        return (newRevisionStart < existingEnd) && (newRevisionEnd > existingStart);
    });

    if (conflict) {
        showInfoModal('Conflito de Horário', 'Já existe uma atividade agendada para este período. Por favor, escolha outro.');
        return;
    }

    // CORREÇÃO: Salva o objeto com 'start' e 'end' completos
    state.revisions.push({ 
        id: Date.now(),
        subject, 
        topic: revisionTopicSelect.value, 
        start: start,
        end: end,
        notes: document.getElementById('revision-notes').value.trim(),
        triggered: false
    });
    saveState();
    renderAll();
    revisionSubjectSelect.value = '';
    revisionTopicSelect.innerHTML = '<option value="">-- Geral da disciplina --</option>';
    revisionTopicSelect.disabled = true;
    document.getElementById('revision-date').value = '';
    document.getElementById('revision-time').value = '';
    document.getElementById('revision-end-time').value = '';
    document.getElementById('revision-notes').value = '';
    showInfoModal('Sucesso', 'Revisão agendada!');
  };

  // --- LÓGICA DE CONFIGURAÇÕES ---
  const settingsBtn = document.getElementById('settings-btn');
  const settingsMenu = document.getElementById('settings-menu');
  const aboutBtn = document.getElementById('about-btn');
  const aboutModal = document.getElementById('about-modal');
  const instructionsBtn = document.getElementById('instructions-btn');
  const instructionsModal = document.getElementById('instructions-modal');
  const exportDataBtn = document.getElementById('export-data-btn');
  const importDataBtn = document.getElementById('import-data-btn');
  const importFileInput = document.getElementById('import-file-input');
  const themesBtn = document.getElementById('themes-btn');
  const themesModal = document.getElementById('themes-modal');
  const customThemesBtn = document.getElementById('custom-themes-btn');
  const customThemesModal = document.getElementById('custom-themes-modal');

  settingsBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    settingsMenu.style.display = settingsMenu.style.display === 'block' ? 'none' : 'block';
  });

  document.addEventListener('click', (e) => {
    if (settingsMenu.style.display === 'block' && !settingsMenu.contains(e.target) && !settingsBtn.contains(e.target)) {
      settingsMenu.style.display = 'none';
    }
  });
  
  aboutBtn.addEventListener('click', () => {
    aboutModal.style.display = 'flex';
    settingsMenu.style.display = 'none';
  });

  instructionsBtn.addEventListener('click', () => {
    instructionsModal.style.display = 'flex';
    settingsMenu.style.display = 'none';
  });

  themesBtn.addEventListener('click', () => {
    populateThemesModal();
    themesModal.style.display = 'flex';
    settingsMenu.style.display = 'none';
  });
  
  customThemesBtn.addEventListener('click', () => {
    populateCustomThemesModal();
    customThemesModal.style.display = 'flex';
    settingsMenu.style.display = 'none';
  });

  document.querySelectorAll('.close-modal-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
        e.currentTarget.closest('.modal-overlay').style.display = 'none';
    });
  });

  window.addEventListener('click', (e) => {
    if (e.target.classList.contains('modal-overlay')) {
        e.target.style.display = 'none';
        if (e.target.id === 'confirmation-modal') {
            confirmCallback = null;
        }
    }
  });

  // --- LÓGICA DA BIBLIOTECA DE TEMAS ---
  const BUILT_IN_THEMES = {
    default: { name: 'Padrão', properties: {'--bg-primary': '#f5f7fa', '--bg-secondary': '#ffffff', '--bg-tertiary': '#f9f9f9', '--bg-header': '#005a9c', '--bg-header-hover': '#004477', '--text-primary': '#333333', '--text-secondary': '#555555', '--text-light': '#ffffff', '--border-color': '#dddddd', '--accent-color': '#005a9c', '--font-family-base': '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif'} },
    dark: { name: 'Noturno', properties: {'--bg-primary': '#121212', '--bg-secondary': '#1e1e1e', '--bg-tertiary': '#2a2a2a', '--bg-header': '#1a237e', '--bg-header-hover': '#283593', '--text-primary': '#e0e0e0', '--text-secondary': '#b0b0b0', '--text-light': '#ffffff', '--border-color': '#444444', '--accent-color': '#3f51b5', '--font-family-base': '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif'} },
    forest: { name: 'Floresta', properties: {'--bg-primary': '#f1f8e9', '--bg-secondary': '#ffffff', '--bg-tertiary': '#e8f5e9', '--bg-header': '#2e7d32', '--bg-header-hover': '#1b5e20', '--text-primary': '#1b2e35', '--text-secondary': '#455a64', '--text-light': '#ffffff', '--border-color': '#c8e6c9', '--accent-color': '#4caf50', '--font-family-base': '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif'} },
    ocean: { name: 'Oceano', properties: {'--bg-primary': '#e0f7fa', '--bg-secondary': '#ffffff', '--bg-tertiary': '#b2ebf2', '--bg-header': '#00838f', '--bg-header-hover': '#006064', '--text-primary': '#004d40', '--text-secondary': '#00695c', '--text-light': '#ffffff', '--border-color': '#80deea', '--accent-color': '#00acc1', '--font-family-base': '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif'} },
    coffee: { name: 'Café', properties: {'--bg-primary': '#efebe9', '--bg-secondary': '#ffffff', '--bg-tertiary': '#d7ccc8', '--bg-header': '#5d4037', '--bg-header-hover': '#4e342e', '--text-primary': '#3e2723', '--text-secondary': '#6d4c41', '--text-light': '#ffffff', '--border-color': '#bcaaa4', '--accent-color': '#795548', '--font-family-base': '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif'} },
    sourcecode: { name: 'Código Fonte', properties: {'--bg-primary': '#1e1e1e', '--bg-secondary': '#252526', '--bg-tertiary': '#333333', '--bg-header': '#007acc', '--bg-header-hover': '#005a9e', '--text-primary': '#d4d4d4', '--text-secondary': '#808080', '--text-light': '#ffffff', '--border-color': '#3c3c3c', '--accent-color': '#569cd6', '--font-family-base': "'Courier New', Courier, monospace"} },
    matrix: { name: 'Matrix', properties: {'--bg-primary': '#000000', '--bg-secondary': '#0D0208', '--bg-tertiary': '#1a1a1a', '--bg-header': '#003B00', '--bg-header-hover': '#005200', '--text-primary': '#00FF00', '--text-secondary': '#00b300', '--text-light': '#ffffff', '--border-color': '#006400', '--accent-color': '#00FF00', '--font-family-base': "'Courier New', Courier, monospace"} },
    sunset: { name: 'Pôr do Sol', properties: {'--bg-primary': '#fbe9e7', '--bg-secondary': '#ffffff', '--bg-tertiary': '#ffccbc', '--bg-header': '#d84315', '--bg-header-hover': '#bf360c', '--text-primary': '#4e342e', '--text-secondary': '#bf360c', '--text-light': '#ffffff', '--border-color': '#ffab91', '--accent-color': '#ff7043', '--font-family-base': '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif'} },
    sakura: { name: 'Sakura', properties: {'--bg-primary': '#fff0f5', '--bg-secondary': '#ffffff', '--bg-tertiary': '#ffe4e1', '--bg-header': '#db7093', '--bg-header-hover': '#c71585', '--text-primary': '#6a5acd', '--text-secondary': '#8a2be2', '--text-light': '#ffffff', '--border-color': '#ffb6c1', '--accent-color': '#ff69b4', '--font-family-base': '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif'} },
    vampire: { name: 'Vampiro', properties: {'--bg-primary': '#1a1a1a', '--bg-secondary': '#2c2c2c', '--bg-tertiary': '#383838', '--bg-header': '#9a0007', '--bg-header-hover': '#6a0005', '--text-primary': '#f0e6e6', '--text-secondary': '#c9c9c9', '--text-light': '#ffffff', '--border-color': '#4a4a4a', '--accent-color': '#e5383b', '--font-family-base': '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif'} },
    mint: { name: 'Menta', properties: {'--bg-primary': '#f0fff0', '--bg-secondary': '#ffffff', '--bg-tertiary': '#e0eee0', '--bg-header': '#3cb371', '--bg-header-hover': '#2e8b57', '--text-primary': '#2f4f4f', '--text-secondary': '#556b2f', '--text-light': '#ffffff', '--border-color': '#98fb98', '--accent-color': '#66cdaa', '--font-family-base': '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif'} },
    galaxy: { name: 'Galáxia', properties: {'--bg-primary': '#0c0a1a', '--bg-secondary': '#1a182b', '--bg-tertiary': '#2a283b', '--bg-header': '#4a148c', '--bg-header-hover': '#6a1b9a', '--text-primary': '#e1ddeb', '--text-secondary': '#b39ddb', '--text-light': '#ffffff', '--border-color': '#4527a0', '--accent-color': '#9c27b0', '--font-family-base': '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif'} },
    oldpaper: { name: 'Jornal Antigo', properties: {'--bg-primary': '#fdf5e6', '--bg-secondary': '#faf0e6', '--bg-tertiary': '#f5deb3', '--bg-header': '#8b4513', '--bg-header-hover': '#a0522d', '--text-primary': '#5c4033', '--text-secondary': '#800000', '--text-light': '#fff', '--border-color': '#d2b48c', '--accent-color': '#cd853f', '--font-family-base': "'Georgia', 'Times New Roman', serif"} },
    neon: { name: 'Neon', properties: {'--bg-primary': '#000000', '--bg-secondary': '#111111', '--bg-tertiary': '#222222', '--bg-header': '#990099', '--bg-header-hover': '#770077', '--text-primary': '#00ffff', '--text-secondary': '#b3ffff', '--text-light': '#ffffff', '--border-color': '#555555', '--accent-color': '#f0f', '--font-family-base': '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif'} },
    submarine: { name: 'Submarino', properties: {'--bg-primary': '#001f3f', '--bg-secondary': '#002a54', '--bg-tertiary': '#003566', '--bg-header': '#0096c7', '--bg-header-hover': '#0077b6', '--text-primary': '#e0e0e0', '--text-secondary': '#ade8f4', '--text-light': '#ffffff', '--border-color': '#00509d', '--accent-color': '#00b4d8', '--font-family-base': '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif'} },
    desert: { name: 'Deserto', properties: {'--bg-primary': '#f4a261', '--bg-secondary': '#fffaf0', '--bg-tertiary': '#fde4cf', '--bg-header': '#264653', '--bg-header-hover': '#2a9d8f', '--text-primary': '#264653', '--text-secondary': '#2a9d8f', '--text-light': '#ffffff', '--border-color': '#e9c46a', '--accent-color': '#e76f51', '--font-family-base': '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif'} },
    lavender: { name: 'Lavanda', properties: {'--bg-primary': '#e6e6fa', '--bg-secondary': '#ffffff', '--bg-tertiary': '#d8bfd8', '--bg-header': '#8a2be2', '--bg-header-hover': '#6a1b9a', '--text-primary': '#483d8b', '--text-secondary': '#6a5acd', '--text-light': '#ffffff', '--border-color': '#dda0dd', '--accent-color': '#9370db', '--font-family-base': '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif'} },
    terminal: { name: 'Terminal', properties: {'--bg-primary': '#000000', '--bg-secondary': '#1a1a1a', '--bg-tertiary': '#2a2a2a', '--bg-header': '#005500', '--bg-header-hover': '#003300', '--text-primary': '#00ff00', '--text-secondary': '#00aa00', '--text-light': '#ffffff', '--border-color': '#006600', '--accent-color': '#00aa00', '--font-family-base': "'Courier New', Courier, monospace"} },
  };
  
  function getCombinedThemes() {
    const customThemesObject = {};
    state.customThemes.forEach(theme => {
        customThemesObject[theme.id] = theme;
    });
    return { ...BUILT_IN_THEMES, ...customThemesObject };
  }
  
  function applyTheme(themeId) {
    const allThemes = getCombinedThemes();
    const theme = allThemes[themeId];
    if (!theme) {
        console.warn(`Tema ${themeId} não encontrado. Voltando para o padrão.`);
        applyTheme('default');
        return;
    }

    const root = document.documentElement;
    const managedProperties = [
        '--bg-primary', '--bg-secondary', '--bg-tertiary', '--bg-header', '--bg-header-hover',
        '--text-primary', '--text-secondary', '--text-light', '--border-color', '--accent-color',
        '--font-family-base'
    ];

    managedProperties.forEach(prop => root.style.removeProperty(prop));
    root.setAttribute('data-theme-preset', themeId);
    
    if (themeId.startsWith('custom_')) {
        for (const [prop, value] of Object.entries(theme.properties)) {
            if (managedProperties.includes(prop)) {
                root.style.setProperty(prop, value);
            }
        }
    }
    
    localStorage.setItem('studyAppThemePreset', themeId);
  }

  function deleteCustomTheme(themeId) {
    showConfirmationModal('Tem certeza que deseja excluir este tema personalizado?', () => {
        const currentThemeId = document.documentElement.getAttribute('data-theme-preset');
        if (themeId === currentThemeId) {
            applyTheme('default');
        }

        state.customThemes = state.customThemes.filter(t => t.id !== themeId);
        saveState();
        
        if (themesModal.style.display === 'flex') {
            populateThemesModal();
        }
        if (customThemesModal.style.display === 'flex') {
            populateCustomThemesModal();
        }
    });
  }

  function populateThemesModal() {
    const themesGrid = document.getElementById('themes-grid');
    themesGrid.innerHTML = '';
    const currentThemeId = document.documentElement.getAttribute('data-theme-preset');
    const allThemes = getCombinedThemes();

    for (const [id, theme] of Object.entries(allThemes)) {
      const preview = document.createElement('div');
      preview.className = 'theme-preview';
      if (id === currentThemeId) {
        preview.classList.add('active');
      }
      preview.dataset.themeId = id;

      let actionsHTML = '';
      if (id.startsWith('custom_')) {
          actionsHTML = `
              <div class="custom-theme-actions">
                  <button class="icon-btn delete-custom-theme-btn" title="Excluir">${trashIconSVG}</button>
              </div>
          `;
      }

      preview.innerHTML = `
        ${actionsHTML}
        <div class="theme-palette">
          <div style="background-color: ${theme.properties['--accent-color']}"></div>
          <div style="background-color: ${theme.properties['--bg-primary']}"></div>
          <div style="background-color: ${theme.properties['--bg-secondary']}"></div>
          <div style="background-color: ${theme.properties['--text-primary']}"></div>
        </div>
        <div class="theme-name">${theme.name}</div>
      `;
      preview.addEventListener('click', (e) => {
        if (e.target.closest('.delete-custom-theme-btn')) return;
        const themeId = e.currentTarget.dataset.themeId;
        applyTheme(themeId);
        document.querySelector('#themes-grid .theme-preview.active')?.classList.remove('active');
        preview.classList.add('active');
      });

      if (id.startsWith('custom_')) {
          preview.querySelector('.delete-custom-theme-btn').addEventListener('click', (e) => {
              e.stopPropagation();
              deleteCustomTheme(id);
          });
      }

      themesGrid.appendChild(preview);
    }
  }
  
  // --- LÓGICA DE TEMAS PERSONALIZADOS ---
  const themeEditorModal = document.getElementById('theme-editor-modal');
  const saveThemeBtn = document.getElementById('save-theme-btn');
  const cancelThemeEditBtn = document.getElementById('cancel-theme-edit-btn');
  const exportThemesBtn = document.getElementById('export-themes-btn');
  const importThemesBtn = document.getElementById('import-themes-btn');
  const importThemesInput = document.getElementById('import-themes-input');
  const chooseThemesFolderBtn = document.getElementById('choose-themes-folder-btn');
  const themesFolderPathSpan = document.getElementById('themes-folder-path');

  function populateCustomThemesModal() {
    const grid = document.getElementById('custom-themes-grid');
    grid.innerHTML = state.customThemes.length === 0 ? '<p>Nenhum tema personalizado criado ainda.</p>' : '';
    
    state.customThemes.forEach(theme => {
        const preview = document.createElement('div');
        preview.className = 'theme-preview';
        preview.dataset.themeId = theme.id;
        preview.innerHTML = `
            <div class="custom-theme-actions">
                <button class="icon-btn edit-custom-theme-btn" title="Editar">${editIconSVG}</button>
                <button class="icon-btn delete-custom-theme-btn" title="Excluir">${trashIconSVG}</button>
            </div>
            <div class="theme-palette">
                <div style="background-color: ${theme.properties['--accent-color']}"></div>
                <div style="background-color: ${theme.properties['--bg-primary']}"></div>
                <div style="background-color: ${theme.properties['--bg-secondary']}"></div>
                <div style="background-color: ${theme.properties['--text-primary']}"></div>
            </div>
            <div class="theme-name">${theme.name}</div>
        `;
        grid.appendChild(preview);
    });

    grid.querySelectorAll('.edit-custom-theme-btn').forEach(btn => {
        btn.onclick = (e) => {
            e.stopPropagation();
            const themeId = e.currentTarget.closest('.theme-preview').dataset.themeId;
            const theme = state.customThemes.find(t => t.id === themeId);
            openThemeEditor(theme);
        };
    });
    grid.querySelectorAll('.delete-custom-theme-btn').forEach(btn => {
        btn.onclick = (e) => {
            e.stopPropagation();
            const themeId = e.currentTarget.closest('.theme-preview').dataset.themeId;
            deleteCustomTheme(themeId);
        };
    });
  }

  function openThemeEditor(theme = null) {
    const form = document.getElementById('theme-editor-form');
    form.reset();
    document.getElementById('theme-editor-title').textContent = theme ? 'Editar Tema' : 'Criar Novo Tema';
    
    if (theme) {
        document.getElementById('theme-editor-id').value = theme.id;
        document.getElementById('theme-name-input').value = theme.name;
        for (const [prop, value] of Object.entries(theme.properties)) {
            const inputId = `theme-${prop.replace('--', '')}-input`;
            const input = document.getElementById(inputId);
            if (input) {
                input.value = value;
            }
        }
    } else {
        document.getElementById('theme-editor-id').value = '';
    }
    themeEditorModal.style.display = 'flex';
  }

  document.getElementById('create-new-theme-btn').addEventListener('click', () => openThemeEditor());
  cancelThemeEditBtn.addEventListener('click', () => themeEditorModal.style.display = 'none');

  saveThemeBtn.addEventListener('click', () => {
    const id = document.getElementById('theme-editor-id').value;
    const name = document.getElementById('theme-name-input').value.trim();
    if (!name) {
        showInfoModal('Erro de Validação', 'O nome do tema é obrigatório.');
        return;
    }

    const properties = {};
    const propNames = [
        'accent-color', 'bg-header', 'bg-header-hover', 'bg-primary', 'bg-secondary',
        'bg-tertiary', 'text-primary', 'text-secondary', 'text-light', 'border-color', 'font-family-base'
    ];
    propNames.forEach(name => {
        const prop = `--${name}`;
        const inputId = `theme-${name}-input`;
        properties[prop] = document.getElementById(inputId).value;
    });

    const newTheme = {
        id: id || `custom_${Date.now()}`,
        name: name,
        properties: properties
    };

    if (id) {
        const index = state.customThemes.findIndex(t => t.id === id);
        state.customThemes[index] = newTheme;
        const currentThemeId = document.documentElement.getAttribute('data-theme-preset');
        if (id === currentThemeId) {
            applyTheme(id);
        }
    } else {
        state.customThemes.push(newTheme);
    }
    saveState();
    populateCustomThemesModal();
    themeEditorModal.style.display = 'none';
  });

  exportThemesBtn.addEventListener('click', async () => {
    if (state.customThemes.length === 0) {
        showInfoModal('Aviso', 'Nenhum tema personalizado para exportar.');
        return;
    }
    const dataStr = JSON.stringify(state.customThemes, null, 2);
    const dataBlob = new Blob([dataStr], {type: "application/json"});
    const fileName = `meus_temas_estudos.json`;

    try {
        let handle = themesDirHandle;
        let permissionGranted = false;

        if (handle) {
            permissionGranted = await verifyHandlePermission(handle);
        }

        if (handle && permissionGranted) {
            const fileHandle = await handle.getFileHandle(fileName, { create: true });
            const writable = await fileHandle.createWritable();
            await writable.write(dataBlob);
            await writable.close();
            showInfoModal('Sucesso', `Temas exportados com sucesso para a pasta "${handle.name}"!`);
        } else {
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.download = fileName;
            link.href = url;
            link.click();
            URL.revokeObjectURL(url);
        }
    } catch (error) {
        console.error('Erro ao exportar temas:', error);
        showInfoModal('Erro', `Ocorreu um erro ao exportar os temas. Error: ${error.name}`);
    }
  });

  importThemesBtn.addEventListener('click', () => importThemesInput.click());
  importThemesInput.addEventListener('change', (event) => {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
        try {
            const imported = JSON.parse(e.target.result);
            if (!Array.isArray(imported)) throw new Error('O arquivo não é uma lista de temas válida.');
            
            const validThemes = imported.filter(t => t.id && t.name && t.properties);
            if (validThemes.length === 0) {
                showInfoModal('Aviso', 'Nenhum tema válido encontrado no arquivo.');
                return;
            }

            validThemes.forEach(theme => {
                const existingIndex = state.customThemes.findIndex(t => t.id === theme.id);
                if (existingIndex > -1) {
                    state.customThemes[existingIndex] = theme;
                } else {
                    state.customThemes.push(theme);
                }
            });
            saveState();
            populateCustomThemesModal();
            showInfoModal('Sucesso', `${validThemes.length} tema(s) importado(s) com sucesso!`);
        } catch (error) {
            showInfoModal('Erro de Importação', `Erro ao importar temas: ${error.message}`);
        }
    };
    reader.readAsText(file);
    importThemesInput.value = '';
  });

  
  // --- LÓGICA DE EXPORTAÇÃO E IMPORTAÇÃO DE DADOS ---
  async function doExportData(isAutoBackup = false) {
    const dataStr = JSON.stringify(state, null, 2);
    const dataBlob = new Blob([dataStr], {type: "application/json"});
    const fileName = `dados_estudos_22_${new Date().toISOString().slice(0,10)}.json`;

    try {
      let handle = backupDirHandle;
      let permissionGranted = false;

      if (handle) {
        permissionGranted = await verifyHandlePermission(handle, isAutoBackup);
      }

      if (handle && permissionGranted) {
        const fileHandle = await handle.getFileHandle(fileName, { create: true });
        const writable = await fileHandle.createWritable();
        await writable.write(dataBlob);
        await writable.close();
      } else {
        if (isAutoBackup) {
          console.log("Backup automático adiado: permissão da pasta não concedida.");
          return false;
        }
        const url = URL.createObjectURL(dataBlob);
        const link = document.createElement('a');
        link.download = fileName;
        link.href = url;
        link.click();
        URL.revokeObjectURL(url);
      }
      return true;
    } catch (error) {
      console.error('Erro ao exportar dados:', error);
      if (!isAutoBackup) {
          showInfoModal('Erro de Exportação', `Ocorreu um erro ao exportar os dados. Se você escolheu uma pasta, verifique suas permissões.\nErro: ${error.name}`);
      }
      return false;
    }
  }

  exportDataBtn.addEventListener('click', async () => {
    if (await doExportData(false)) {
        showInfoModal('Sucesso', 'Dados exportados com sucesso!');
    }
    settingsMenu.style.display = 'none';
  });

  importDataBtn.addEventListener('click', () => {
    showConfirmationModal('Atenção: A importação irá substituir TODOS os seus dados atuais. Deseja continuar?', () => {
        importFileInput.click();
    });
    settingsMenu.style.display = 'none';
  });

  importFileInput.addEventListener('change', (event) => {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (e) => {
        try {
            const importedState = JSON.parse(e.target.result);
            if (importedState && typeof importedState.subjects !== 'undefined' && typeof importedState.studyRecords !== 'undefined') {
                Object.assign(state, importedState);
                saveState();
                showInfoModal('Sucesso', 'Dados importados com sucesso! A página será recarregada.');
                setTimeout(() => location.reload(), 1500);
            } else {
                showInfoModal('Erro', 'Arquivo inválido ou corrompido.');
            }
        } catch (error) {
            console.error('Erro ao importar dados:', error);
            showInfoModal('Erro de Importação', 'Ocorreu um erro ao ler o arquivo. Verifique se é um arquivo JSON válido.');
        }
    };
    reader.readAsText(file);
    importFileInput.value = '';
  });

  // --- LÓGICA DE BACKUP AGENDADO E PASTA ---
  const scheduleBackupBtn = document.getElementById('schedule-backup-btn');
  const backupModal = document.getElementById('backup-modal');
  const backupIntervalInput = document.getElementById('backup-interval');
  const saveBackupBtn = document.getElementById('save-backup-schedule-btn');
  const cancelBackupBtn = document.getElementById('cancel-backup-schedule-btn');
  const backupStatus = document.getElementById('backup-status');
  const chooseFolderBtn = document.getElementById('choose-backup-folder-btn');
  const folderPathSpan = document.getElementById('backup-folder-path');

  function openDb() {
    return new Promise((resolve, reject) => {
      const request = indexedDB.open('studyAppDB', 1);
      request.onupgradeneeded = () => {
        request.result.createObjectStore('fileHandles', { keyPath: 'id' });
      };
      request.onsuccess = () => resolve(request.result);
      request.onerror = () => reject(request.error);
    });
  }

  async function saveDirectoryHandle(handle, key) {
    const db = await openDb();
    return new Promise((resolve, reject) => {
      const tx = db.transaction('fileHandles', 'readwrite');
      tx.objectStore('fileHandles').put({ id: key, handle });
      tx.oncomplete = () => resolve();
      tx.onerror = () => reject(tx.error);
    });
  }

  async function getDirectoryHandle(key) {
    try {
      const db = await openDb();
      return new Promise((resolve, reject) => {
        const tx = db.transaction('fileHandles', 'readonly');
        const request = tx.objectStore('fileHandles').get(key);
        tx.oncomplete = () => resolve(request.result ? request.result.handle : null);
        tx.onerror = () => reject(tx.error);
      });
    } catch (error) {
      console.error("Erro ao acessar IndexedDB:", error);
      return null;
    }
  }

  async function verifyHandlePermission(handle, silent = false) {
    if (!handle || typeof handle.queryPermission !== 'function') return false;
    
    const options = { mode: 'readwrite' };
    
    if (await handle.queryPermission(options) === 'granted') return true;
    if (silent) return false;
    if (await handle.requestPermission(options) === 'granted') return true;

    return false;
  }

  chooseFolderBtn.addEventListener('click', async () => {
    if (typeof window.showDirectoryPicker !== 'function') {
      showInfoModal('Aviso', 'Seu navegador não suporta a seleção de pastas. O backup será salvo na pasta de Downloads.');
      return;
    }
    try {
      const handle = await window.showDirectoryPicker();
      await saveDirectoryHandle(handle, 'backupDir');
      backupDirHandle = handle;
      folderPathSpan.textContent = handle.name;
      showInfoModal('Sucesso', `Pasta "${handle.name}" selecionada para backups.`);
    } catch (error) {
      console.log('Seleção de pasta cancelada ou falhou:', error);
    }
  });
  
  chooseThemesFolderBtn.addEventListener('click', async () => {
    if (typeof window.showDirectoryPicker !== 'function') {
      showInfoModal('Aviso', 'Seu navegador não suporta a seleção de pastas. Os temas serão salvos na pasta de Downloads.');
      return;
    }
    try {
      const handle = await window.showDirectoryPicker();
      await saveDirectoryHandle(handle, 'themesDir');
      themesDirHandle = handle;
      themesFolderPathSpan.textContent = handle.name;
      showInfoModal('Sucesso', `Pasta "${handle.name}" selecionada para temas.`);
    } catch (error) {
      console.log('Seleção de pasta de temas cancelada ou falhou:', error);
    }
  });

  scheduleBackupBtn.addEventListener('click', () => {
    const schedule = JSON.parse(localStorage.getItem('studyAppBackupSchedule') || '{}');
    backupIntervalInput.value = schedule.intervalDays || 7;
    updateBackupStatus();
    
    if (backupDirHandle) {
      folderPathSpan.textContent = backupDirHandle.name;
    } else {
      folderPathSpan.textContent = 'Nenhuma (usará a pasta Downloads)';
    }

    backupModal.style.display = 'flex';
    settingsMenu.style.display = 'none';
  });

  function updateBackupStatus() {
    const schedule = JSON.parse(localStorage.getItem('studyAppBackupSchedule') || '{}');
    if (schedule.intervalDays && schedule.lastBackupTimestamp) {
        const nextBackupDate = new Date(schedule.lastBackupTimestamp + schedule.intervalDays * 24 * 60 * 60 * 1000);
        backupStatus.textContent = `Próximo backup: ${nextBackupDate.toLocaleDateString('pt-BR')}.`;
    } else {
        backupStatus.textContent = 'Nenhum backup automático agendado.';
    }
  }

  saveBackupBtn.addEventListener('click', () => {
    const interval = parseInt(backupIntervalInput.value, 10);
    if (isNaN(interval) || interval < 1) {
        showInfoModal('Erro de Validação', 'Por favor, insira um intervalo de dias válido.');
        return;
    }
    const schedule = {
        intervalDays: interval,
        lastBackupTimestamp: Date.now()
    };
    localStorage.setItem('studyAppBackupSchedule', JSON.stringify(schedule));
    showInfoModal('Sucesso', `Backup automático agendado para cada ${interval} dias.`);
    backupModal.style.display = 'none';
  });

  cancelBackupBtn.addEventListener('click', () => {
    backupModal.style.display = 'none';
  });

  async function checkScheduledBackup() {
    const schedule = JSON.parse(localStorage.getItem('studyAppBackupSchedule') || '{}');
    if (!schedule.intervalDays || !schedule.lastBackupTimestamp) return;

    const now = Date.now();
    const nextBackupTimestamp = schedule.lastBackupTimestamp + (schedule.intervalDays * 24 * 60 * 60 * 1000);

    if (now >= nextBackupTimestamp) {
      console.log('Executando backup agendado...');
      if (await doExportData(true)) {
        console.log('Backup automático realizado com sucesso!');
        schedule.lastBackupTimestamp = now;
        localStorage.setItem('studyAppBackupSchedule', JSON.stringify(schedule));
      } else {
        console.log('Falha ao realizar o backup automático.');
      }
    }
  }


  // --- LÓGICA DOS ALARMES ---
  const alarmModal = document.getElementById('alarm-modal');
  const alarmTitle = document.getElementById('alarm-title');
  const alarmText = document.getElementById('alarm-text');
  const closeAlarmBtn = document.getElementById('close-alarm-btn');
  let alarmSound;

  document.body.addEventListener('click', () => {
      if (!alarmSound) {
          alarmSound = new Tone.Synth().toDestination();
      }
  }, { once: true });

  function triggerAlarm(alarm) {
      if (alarmSound) {
          alarmSound.triggerAttackRelease("C5", "0.5");
      }
      if (alarm.type === 'study') {
          alarmTitle.textContent = "Hora do Estudo!";
          alarmText.textContent = `É hora do estudo agendado para: ${alarm.subject}${alarm.topic ? ' - ' + alarm.topic : ''}`;
          const alarmToUpdate = state.studyAlarms.find(a => a.id === alarm.id);
          if (alarmToUpdate) alarmToUpdate.triggered = true;
      } else { // revision
          alarmTitle.textContent = "Hora da Revisão!";
          alarmText.textContent = `É hora de revisar: ${alarm.subject} ${alarm.topic ? '> ' + alarm.topic : ''}`;
          const revisionToUpdate = state.revisions.find(r => r.id === alarm.id);
          if (revisionToUpdate) revisionToUpdate.triggered = true;
      }
      alarmModal.style.display = 'flex';
      saveState();
      renderAll();
  }

  closeAlarmBtn.addEventListener('click', () => {
      alarmModal.style.display = 'none';
  });

  function checkAlarms() {
      const now = new Date();
      const allAlarms = [
          ...state.studyAlarms.map(a => ({...a, type: 'study'})),
          ...state.revisions.map(r => ({...r, type: 'revision'}))
      ];

      const dueAlarm = allAlarms.find(alarm => {
          if (alarm.triggered || !alarm.start) return false;
          const alarmTime = new Date(alarm.start);
          return now >= alarmTime;
      });

      if(dueAlarm) {
          triggerAlarm(dueAlarm);
      }
  }

  setInterval(checkAlarms, 1000);

  // Agendar Alarme de Estudo
  document.getElementById('add-study-alarm-btn').addEventListener('click', () => {
      const subject = document.getElementById('alarm-subject').value;
      const topic = document.getElementById('alarm-topic').value;
      const date = document.getElementById('alarm-date').value;
      const time = document.getElementById('alarm-time').value;
      const endTime = document.getElementById('alarm-end-time').value;

      if (!subject || !date || !time || !endTime) {
          showInfoModal('Erro de Validação', 'Por favor, preencha a disciplina, data e horários de início e fim.');
          return;
      }
      
      // CORREÇÃO: Usa a nova função para calcular datas e horários
      const { start, end } = getEventDateTimes(date, time, endTime);
      const newAlarmStart = new Date(start);
      const newAlarmEnd = new Date(end);

      const conflict = [...state.studyAlarms, ...state.revisions].some(event => {
        const existingStart = new Date(event.start);
        const existingEnd = new Date(event.end);
        return (newAlarmStart < existingEnd) && (newAlarmEnd > existingStart);
      });

      if (conflict) {
          showInfoModal('Conflito de Horário', 'Já existe uma atividade agendada para este período. Por favor, escolha outro.');
          return;
      }

      // CORREÇÃO: Salva o objeto com 'start' e 'end' completos
      state.studyAlarms.push({
          id: Date.now(),
          subject,
          topic,
          start: start,
          end: end,
          triggered: false
      });
      saveState();
      renderAll();
      document.getElementById('alarm-subject').value = '';
      document.getElementById('alarm-topic').value = '';
      document.getElementById('alarm-topic').disabled = true;
      document.getElementById('alarm-date').value = '';
      document.getElementById('alarm-time').value = '';
      document.getElementById('alarm-end-time').value = '';
      showInfoModal('Sucesso', 'Estudo agendado com sucesso!');
  });

  function updateStudyAlarmList() {
      const list = studyAlarmList;
      list.innerHTML = '';
      if (state.studyAlarms.length === 0) {
          list.innerHTML = '<li>Nenhum estudo agendado.</li>';
          return;
      }
      state.studyAlarms.forEach(alarm => {
          const li = document.createElement('li');
          if (alarm.triggered) {
              li.style.textDecoration = 'line-through';
              li.style.opacity = '0.6';
          }
          
          // CORREÇÃO: Parse das datas de início e fim para exibição
          const startDate = new Date(alarm.start);
          const endDate = new Date(alarm.end);
          const startTimeStr = startDate.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
          const endTimeStr = endDate.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
          const endDateStr = startDate.toDateString() !== endDate.toDateString() ? ` (até ${endDate.toLocaleDateString('pt-BR')})` : '';
          
          let alarmText = `<strong>${startDate.toLocaleDateString('pt-BR')} das ${startTimeStr} às ${endTimeStr}${endDateStr}</strong> - ${alarm.subject}`;
          if (alarm.topic) {
              alarmText += ` > ${alarm.topic}`;
          }
          li.innerHTML = `
            <span class="drag-handle" title="Arraste para reordenar">${dragHandleIconSVG}</span>
            <div style="flex-grow: 1;">${alarmText}</div>
            <button class="icon-btn delete-btn delete-study-alarm-btn" data-id="${alarm.id}" title="Excluir agendamento">${trashIconSVG}</button>
          `;
          list.appendChild(li);
      });

      document.querySelectorAll('.delete-study-alarm-btn').forEach(btn => {
          btn.onclick = (e) => {
              const id = parseInt(e.currentTarget.dataset.id, 10);
              showConfirmationModal('Deseja realmente excluir este agendamento de estudo?', () => {
                  state.studyAlarms = state.studyAlarms.filter(a => a.id !== id);
                  saveState();
                  renderAll();
              });
          };
      });
  }

  // --- LÓGICA DE REORDENAÇÃO (DRAG & DROP) ---
  function initSortable() {
    new Sortable(subjectsContainer, {
        animation: 150,
        handle: '.drag-handle',
        onEnd: (evt) => {
            const movedItem = state.subjects.splice(evt.oldIndex, 1)[0];
            state.subjects.splice(evt.newIndex, 0, movedItem);
            saveState();
            renderAll();
        }
    });

    new Sortable(studyAlarmList, {
        animation: 150,
        handle: '.drag-handle',
        onEnd: (evt) => {
            const movedItem = state.studyAlarms.splice(evt.oldIndex, 1)[0];
            state.studyAlarms.splice(evt.newIndex, 0, movedItem);
            saveState();
            renderAll();
        }
    });

    new Sortable(revisionList, {
        animation: 150,
        handle: '.drag-handle',
        onEnd: (evt) => {
            const movedItem = state.revisions.splice(evt.oldIndex, 1)[0];
            state.revisions.splice(evt.newIndex, 0, movedItem);
            saveState();
            renderAll();
        }
    });
    
    new Sortable(document.getElementById('study-cycles-container'), {
        animation: 150,
        handle: '.drag-handle',
        onEnd: (evt) => {
            const movedItem = state.studyCycles.splice(evt.oldIndex, 1)[0];
            state.studyCycles.splice(evt.newIndex, 0, movedItem);
            saveState();
            updateStudyCyclesUI();
        }
    });
  }

  // --- PERSISTÊNCIA E INICIALIZAÇÃO ---
  function saveState() {
    try {
        const stateToSave = { ...state, timer: { ...state.timer, interval: null, activeCycle: null } };
        localStorage.setItem('studyAppState', JSON.stringify(stateToSave));
    } catch (e) {
        console.error("Erro ao salvar o estado:", e);
    }
  }

  function loadState() {
    try {
        const savedStateJSON = localStorage.getItem('studyAppState');
        if (savedStateJSON) {
            const savedState = JSON.parse(savedStateJSON);
            if (savedState && typeof savedState === 'object') {
                Object.assign(state, { ...savedState, timer: {...state.timer, ...savedState.timer} });
                
                state.subjects = state.subjects || [];
                state.studyRecords = state.studyRecords || [];
                state.revisions = state.revisions || [];
                state.studyAlarms = state.studyAlarms || [];
                state.customThemes = state.customThemes || [];
                state.studyCycles = state.studyCycles || [];

                state.subjects.forEach(s => {
                    s.topics = s.topics || [];
                    if (typeof s.isMinimized === 'undefined') s.isMinimized = false;
                });
                state.studyRecords.forEach(r => {
                    r.topic = r.topic || '';
                    r.restDuration = r.restDuration || 0;
                });
                state.studyAlarms.forEach(a => a.topic = a.topic || '');
                
                state.timer.activeCycle = null; 

                if (state.customThemes && state.customThemes.length > 0 && state.customThemes[0].colors) {
                    console.log("Migrando estrutura de temas antiga...");
                    state.customThemes.forEach(theme => {
                        if (theme.colors) {
                            theme.properties = {
                                '--accent-color': theme.colors[0] || '#005a9c',
                                '--bg-primary': theme.colors[1] || '#f5f7fa',
                                '--bg-secondary': theme.colors[2] || '#ffffff',
                                '--text-primary': theme.colors[3] || '#333333',
                                '--bg-header': theme.colors[0] || '#005a9c',
                                '--bg-header-hover': '#004477',
                                '--bg-tertiary': '#f9f9f9',
                                '--text-secondary': '#555555',
                                '--text-light': '#ffffff',
                                '--border-color': '#dddddd',
                                '--font-family-base': theme.font || '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif'
                            };
                            delete theme.colors;
                            delete theme.font;
                        }
                    });
                }
            }
        }
    } catch (e) {
        console.error("Erro ao carregar o estado do localStorage. Redefinindo para o padrão.", e);
        localStorage.removeItem('studyAppState');
    }
    
    const savedTheme = localStorage.getItem('studyAppThemePreset') || 'default';
    applyTheme(savedTheme);
  }

  function renderAll() {
    updateSubjectsUI();
    updateProgressTable();
    updateRevisionList();
    updateStudyAlarmList();
    updateTimerControls();
    updateUnifiedCalendarFilter();
    updateCalendarEvents();
    updateStudyCyclesUI();
    if (document.querySelector('#tab-progress.active')) {
        graphSubjectsSelect.dispatchEvent(new Event('change'));
        updateChart();
    }
  }

  async function initializeApp() {
    loadState();
    
    const backupHandle = await getDirectoryHandle('backupDir');
    if (backupHandle) {
      backupDirHandle = backupHandle;
      document.getElementById('backup-folder-path').textContent = backupHandle.name;
      console.log("Referência da pasta de backup restaurada.");
    }
    
    const themesHandle = await getDirectoryHandle('themesDir');
    if (themesHandle) {
      themesDirHandle = themesHandle;
      document.getElementById('themes-folder-path').textContent = themesHandle.name;
      console.log("Referência da pasta de temas restaurada.");
    }

    renderAll();
    initSortable();
    checkScheduledBackup();
    
    createCycleBtn.addEventListener('click', () => openCycleCreator());
    saveCycleBtn.addEventListener('click', saveCycle);
    cancelCycleBtn.addEventListener('click', () => cycleCreatorModal.style.display = 'none');
    cycleCountInput.addEventListener('input', updateCycleSubjectSelectors);
  }

  initializeApp();
});
</script>

</body>
</html>
